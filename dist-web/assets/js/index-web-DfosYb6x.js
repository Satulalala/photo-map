const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/SettingsPanel-CrhxzLxV.js","assets/js/utils-vendor-BVqnKQB6.js","assets/js/react-vendor-DDxydHEc.js","assets/js/virtual-scroll-DDeySHGB.js"])))=>i.map(i=>d[i]);
var cs=Object.defineProperty;var ds=(c,r,l)=>r in c?cs(c,r,{enumerable:!0,configurable:!0,writable:!0,value:l}):c[r]=l;var Fe=(c,r,l)=>ds(c,typeof r!="symbol"?r+"":r,l);import{r as hs,a as us,g as ms}from"./react-vendor-DDxydHEc.js";import{r as a,v as Lt,R as ps}from"./utils-vendor-BVqnKQB6.js";import{F as gs}from"./virtual-scroll-DDeySHGB.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))p(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const x of h.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&p(x)}).observe(document,{childList:!0,subtree:!0});function l(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerPolicy&&(h.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?h.credentials="include":i.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function p(i){if(i.ep)return;i.ep=!0;const h=l(i);fetch(i.href,h)}})();var ct={exports:{}},Me={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Dt;function xs(){if(Dt)return Me;Dt=1;var c=hs(),r=Symbol.for("react.element"),l=Symbol.for("react.fragment"),p=Object.prototype.hasOwnProperty,i=c.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,h={key:!0,ref:!0,__self:!0,__source:!0};function x(d,m,M){var g,y={},k=null,v=null;M!==void 0&&(k=""+M),m.key!==void 0&&(k=""+m.key),m.ref!==void 0&&(v=m.ref);for(g in m)p.call(m,g)&&!h.hasOwnProperty(g)&&(y[g]=m[g]);if(d&&d.defaultProps)for(g in m=d.defaultProps,m)y[g]===void 0&&(y[g]=m[g]);return{$$typeof:r,type:d,key:k,ref:v,props:y,_owner:i.current}}return Me.Fragment=l,Me.jsx=x,Me.jsxs=x,Me}var zt;function fs(){return zt||(zt=1,ct.exports=xs()),ct.exports}var e=fs(),Be={},Et;function vs(){if(Et)return Be;Et=1;var c=us();return Be.createRoot=c.createRoot,Be.hydrateRoot=c.hydrateRoot,Be}var js=vs();const ws=ms(js),ys="modulepreload",Ns=function(c){return"/"+c},$t={},ks=function(r,l,p){let i=Promise.resolve();if(l&&l.length>0){let x=function(M){return Promise.all(M.map(g=>Promise.resolve(g).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),m=d?.nonce||d?.getAttribute("nonce");i=x(l.map(M=>{if(M=Ns(M),M in $t)return;$t[M]=!0;const g=M.endsWith(".css"),y=g?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${M}"]${y}`))return;const k=document.createElement("link");if(k.rel=g?"stylesheet":ys,g||(k.as="script"),k.crossOrigin="",k.href=M,m&&k.setAttribute("nonce",m),document.head.appendChild(k),g)return new Promise((v,R)=>{k.addEventListener("load",v),k.addEventListener("error",()=>R(new Error(`Unable to preload CSS for ${M}`)))})}))}function h(x){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=x,window.dispatchEvent(d),!d.defaultPrevented)throw x}return i.then(x=>{for(const d of x||[])d.status==="rejected"&&h(d.reason);return r().catch(h)})};class ut{constructor(r=50,l){Fe(this,"maxSize");Fe(this,"cache");Fe(this,"onEvict");this.maxSize=r,this.cache=new Map,this.onEvict=l}get(r){if(!this.cache.has(r))return null;const l=this.cache.get(r);return this.cache.delete(r),this.cache.set(r,l),l}set(r,l){if(this.cache.has(r)){const p=this.cache.get(r);this.cache.delete(r),p!==l&&this.onEvict&&this.onEvict(r,p)}else if(this.cache.size>=this.maxSize){const p=this.cache.keys().next().value;if(p!==void 0){const i=this.cache.get(p);this.cache.delete(p),this.onEvict&&this.onEvict(p,i)}}this.cache.set(r,l)}has(r){return this.cache.has(r)}delete(r){if(this.cache.has(r)){const l=this.cache.get(r);return this.cache.delete(r),this.onEvict&&this.onEvict(r,l),!0}return!1}clear(){this.onEvict&&this.cache.forEach((r,l)=>{this.onEvict(l,r)}),this.cache.clear()}get size(){return this.cache.size}keys(){return Array.from(this.cache.keys())}}const mt=(c,r)=>{if(r&&r.startsWith("blob:"))try{URL.revokeObjectURL(r)}catch{}},Z=new ut(15,mt),Ie=new ut(50,mt),Ut=new ut(100,mt),Ot=300*1e3;let Ce=null;function Ft(){return{photoUrl:Z.size,thumbnail:Ie.size,placeholder:Ut.size,total:Z.size+Ie.size+Ut.size}}function bs(){Ce||(Ce=setInterval(()=>{const c=Ft();if(console.log("[å†…å­˜ç®¡ç†] å®šæ—¶æ£€æŸ¥ç¼“å­˜:",c),c.total>100){const r=Math.floor(Z.size*.2),l=Z.keys();for(let p=0;p<r&&p<l.length;p++)Z.delete(l[p]);console.log("[å†…å­˜ç®¡ç†] å·²æ¸…ç†",r,"ä¸ªåŽŸå›¾ç¼“å­˜")}},Ot),console.log("[å†…å­˜ç®¡ç†] å®šæ—¶æ¸…ç†ä»»åŠ¡å·²å¯åŠ¨ï¼Œé—´éš”:",Ot/1e3,"ç§’"))}function Ms(){Ce&&(clearInterval(Ce),Ce=null,console.log("[å†…å­˜ç®¡ç†] å®šæ—¶æ¸…ç†ä»»åŠ¡å·²åœæ­¢"))}function Cs(){if(typeof performance<"u"&&performance.memory){const c=performance.memory;return{usedJSHeapSize:c.usedJSHeapSize,totalJSHeapSize:c.totalJSHeapSize,jsHeapSizeLimit:c.jsHeapSizeLimit}}return null}function Is({photoViewer:c,setPhotoViewer:r,currentPhotoUrl:l,getPhotoNote:p,markers:i,setMarkerMenu:h,refreshMarkers:x,setPhotoEditor:d}){const m=a.useRef(null),M=a.useRef(null);a.useEffect(()=>(M.current=l,()=>{if(M.current?.startsWith("blob:"))try{URL.revokeObjectURL(M.current)}catch{}}),[l]);const g=a.useCallback(async()=>{if(c.returnToMenu)if(window.electronAPI?.getMarkerDetail){const v=await window.electronAPI.getMarkerDetail(c.markerId);v&&h({...c.returnToMenu,marker:v})}else{const v=i.find(R=>R.id===c.markerId);v&&h({...c.returnToMenu,marker:v})}r(null)},[c,i,h,r]),y=v=>{r(R=>({...R,index:v}))},k=()=>{const v=c.photos[c.index];d({photoId:v?.id,photoUrl:l,returnToViewer:c}),r(null)};return e.jsxs("div",{className:"photo-viewer",onClick:g,children:[e.jsxs("div",{className:"pv-toolbar",onClick:v=>v.stopPropagation(),children:[e.jsx("button",{className:"pv-btn",onClick:k,title:"ç¼–è¾‘ï¼ˆè£å‰ª/æ—‹è½¬ï¼‰",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:"pv-btn",onClick:()=>{const v=document.createElement("a");v.download=`ç…§ç‰‡_${c.index+1}.jpg`,v.href=l,v.click()},title:"ä¸‹è½½åŽŸå›¾",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"})})}),c.photos.length>1&&e.jsx("button",{className:"pv-btn pv-btn-danger",onClick:async()=>{if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ"))return;const v=c.photos[c.index];window.electronAPI&&await window.electronAPI.deletePhoto(c.markerId,c.index,v?.id);const R=c.photos.filter((de,K)=>K!==c.index);r({...c,photos:R,index:Math.min(c.index,R.length-1)}),x()},title:"åˆ é™¤",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})})}),e.jsx("div",{className:"pv-divider"}),e.jsx("button",{className:"pv-btn pv-btn-close",onClick:g,title:"å…³é—­",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]}),e.jsx("div",{className:"photo-main-wrapper",onClick:v=>v.stopPropagation(),children:e.jsx("img",{ref:m,src:l,alt:"",draggable:!1})}),c.photos.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"photo-nav prev",onClick:v=>{v.stopPropagation(),y((c.index-1+c.photos.length)%c.photos.length)},children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"})})}),e.jsx("button",{className:"photo-nav next",onClick:v=>{v.stopPropagation(),y((c.index+1)%c.photos.length)},children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})})})]}),e.jsxs("div",{className:"photo-bottom-bar",onClick:v=>v.stopPropagation(),children:[c.photos.length>1&&e.jsxs("div",{className:"photo-counter",children:[c.index+1," / ",c.photos.length]}),p(c.photos[c.index])&&e.jsxs("div",{className:"photo-note-bar",children:["ðŸ“ ",p(c.photos[c.index])]})]})]})}function Ps({photoEditor:c,setPhotoEditor:r,setPhotoViewer:l,cropPhoto:p,refreshMarkers:i}){const[h,x]=a.useState(0),[d,m]=a.useState(null),[M,g]=a.useState(!1),[y,k]=a.useState(null),[v,R]=a.useState(!1),de=a.useRef(null),K=a.useRef(null),W=a.useRef(null),se=a.useRef(null);a.useEffect(()=>{c&&(x(0),m(null),se.current=c.photoUrl)},[c?.photoUrl]),a.useEffect(()=>()=>{if(se.current?.startsWith("blob:"))try{URL.revokeObjectURL(se.current)}catch{}},[]);const ne=a.useCallback(()=>{c?.returnToViewer&&l(c.returnToViewer),r(null)},[c,l,r]),$=()=>{const A=K.current;return A?A.getBoundingClientRect():null},ge=A=>{if(A.target.closest(".crop-handle"))return;const f=$();if(!f)return;const S=A.clientX-f.left,b=A.clientY-f.top;d&&S>=d.x&&S<=d.x+d.width&&b>=d.y&&b<=d.y+d.height?(k("move"),W.current={x:S,y:b,cropArea:{...d}}):(k("new"),W.current={x:S,y:b},m(null)),g(!0)},O=(A,f)=>{f.stopPropagation();const S=$();!S||!d||(k(A),W.current={x:f.clientX-S.left,y:f.clientY-S.top,cropArea:{...d}},g(!0))},fe=A=>{if(!M||!W.current)return;const f=$();if(!f)return;const S=Math.max(0,Math.min(f.width,A.clientX-f.left)),b=Math.max(0,Math.min(f.height,A.clientY-f.top));if(y==="new"){const{x:D,y:L}=W.current;m({x:Math.min(D,S),y:Math.min(L,b),width:Math.abs(S-D),height:Math.abs(b-L)})}else if(y==="move"){const{x:D,y:L,cropArea:U}=W.current,Y=S-D,_=b-L;m({x:Math.max(0,Math.min(f.width-U.width,U.x+Y)),y:Math.max(0,Math.min(f.height-U.height,U.y+_)),width:U.width,height:U.height})}else{const{cropArea:D}=W.current;let L={...D};y.includes("l")&&(L.width=D.x+D.width-S,L.x=S),y.includes("r")&&(L.width=S-D.x),y.includes("t")&&(L.height=D.y+D.height-b,L.y=b),y.includes("b")&&(L.height=b-D.y),L.width>=20&&L.height>=20&&m(L)}},T=()=>{g(!1),k(null),W.current=null},B=()=>{x(A=>A-90),m(null)},He=()=>{x(A=>A+90),m(null)},Pe=()=>{x(0),m(null)},We=()=>(h%360+360)%360,ve=()=>{m(null)},pt=async()=>{if(!de.current)return;R(!0);const f=document.createElement("canvas"),S=f.getContext("2d"),b=new Image;b.crossOrigin="anonymous",b.onload=async()=>{let D=b.naturalWidth,L=b.naturalHeight;const U=We(),Y=U%180!==0;if(f.width=Y?L:D,f.height=Y?D:L,S.save(),S.translate(f.width/2,f.height/2),S.rotate(U*Math.PI/180),S.drawImage(b,-D/2,-L/2),S.restore(),d&&d.width>10&&d.height>10){const _=K.current;if(_){const re=_.getBoundingClientRect(),X=f.width/re.width,Ae=f.height/re.height,Re=d.x*X,gt=d.y*Ae,he=d.width*X,G=d.height*Ae,F=document.createElement("canvas");F.width=he,F.height=G,F.getContext("2d").drawImage(f,Re,gt,he,G,0,0,he,G),f.width=he,f.height=G,S.drawImage(F,0,0)}}f.toBlob(_=>{if(!_){R(!1);return}const re=URL.createObjectURL(_),X=document.createElement("a");X.download=`edited_${Date.now()}.jpg`,X.href=re,X.click(),URL.revokeObjectURL(re),R(!1),ne()},"image/jpeg",.92)},b.onerror=()=>R(!1),b.src=c.photoUrl};if(!c)return null;const Se=We(),H=Se!==0||d&&d.width>10&&d.height>10;return e.jsx("div",{className:"photo-editor-overlay",onMouseMove:fe,onMouseUp:T,onMouseLeave:T,children:e.jsxs("div",{className:"photo-editor-modern",children:[e.jsxs("div",{className:"pe-header",children:[e.jsx("button",{className:"pe-btn pe-cancel",onClick:ne,children:"å–æ¶ˆ"}),e.jsx("span",{className:"pe-title",children:"ç¼–è¾‘"}),e.jsx("button",{className:`pe-btn pe-done ${H?"active":""}`,onClick:pt,disabled:!H||v,children:v?"ä¿å­˜ä¸­...":"å®Œæˆ"})]}),e.jsxs("div",{className:"pe-canvas-area",children:[e.jsxs("div",{ref:K,className:"pe-image-container",onMouseDown:ge,children:[e.jsx("img",{ref:de,src:c.photoUrl,alt:"ç¼–è¾‘",draggable:!1,style:{transform:`rotate(${h}deg)`}}),d&&d.width>5&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"pe-crop-overlay"}),e.jsxs("div",{className:"pe-crop-box",style:{left:d.x,top:d.y,width:d.width,height:d.height},children:[e.jsxs("div",{className:"pe-grid",children:[e.jsx("div",{className:"pe-grid-h",style:{top:"33.33%"}}),e.jsx("div",{className:"pe-grid-h",style:{top:"66.66%"}}),e.jsx("div",{className:"pe-grid-v",style:{left:"33.33%"}}),e.jsx("div",{className:"pe-grid-v",style:{left:"66.66%"}})]}),e.jsx("div",{className:"crop-handle tl",onMouseDown:A=>O("tl",A)}),e.jsx("div",{className:"crop-handle tr",onMouseDown:A=>O("tr",A)}),e.jsx("div",{className:"crop-handle bl",onMouseDown:A=>O("bl",A)}),e.jsx("div",{className:"crop-handle br",onMouseDown:A=>O("br",A)})]})]})]}),H&&e.jsx("button",{className:"pe-reset-btn",onClick:Pe,title:"é‡ç½®å…¨éƒ¨",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"})})}),!d&&!H&&e.jsx("div",{className:"pe-hint",children:"æ‹–æ‹½é€‰æ‹©è£å‰ªåŒºåŸŸ"}),H&&e.jsxs("div",{className:"pe-status",children:[Se!==0&&e.jsxs("span",{className:"pe-status-item",children:["æ—‹è½¬ ",Se,"Â°"]}),d&&d.width>10&&e.jsxs("span",{className:"pe-status-item",children:[Math.round(d.width)," Ã— ",Math.round(d.height)]})]})]}),e.jsxs("div",{className:"pe-toolbar",children:[e.jsx("button",{className:"pe-tool",onClick:B,title:"é€†æ—¶é’ˆæ—‹è½¬",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M7.11 8.53L5.7 7.11C4.8 8.27 4.24 9.61 4.07 11h2.02c.14-.87.49-1.72 1.02-2.47zM6.09 13H4.07c.17 1.39.72 2.73 1.62 3.89l1.41-1.42c-.52-.75-.87-1.59-1.01-2.47zm1.01 5.32c1.16.9 2.51 1.44 3.9 1.61V17.9c-.87-.15-1.71-.49-2.46-1.03L7.1 18.32zM13 4.07V1L8.45 5.55 13 10V6.09c2.84.48 5 2.94 5 5.91s-2.16 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93s-3.05-7.44-7-7.93z"})})}),e.jsx("button",{className:"pe-tool",onClick:He,title:"é¡ºæ—¶é’ˆæ—‹è½¬",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M15.55 5.55L11 1v3.07C7.06 4.56 4 7.92 4 12s3.05 7.44 7 7.93v-2.02c-2.84-.48-5-2.94-5-5.91s2.16-5.43 5-5.91V10l4.55-4.45zM19.93 11c-.17-1.39-.72-2.73-1.62-3.89l-1.42 1.42c.54.75.88 1.6 1.02 2.47h2.02zM13 17.9v2.02c1.39-.17 2.74-.71 3.9-1.61l-1.44-1.44c-.75.54-1.59.89-2.46 1.03zm3.89-2.42l1.42 1.41c.9-1.16 1.45-2.5 1.62-3.89h-2.02c-.14.87-.48 1.72-1.02 2.48z"})})}),d&&e.jsx("button",{className:"pe-tool",onClick:ve,title:"æ¸…é™¤è£å‰ª",children:e.jsxs("svg",{viewBox:"0 0 24 24",children:[e.jsx("path",{d:"M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"}),e.jsx("path",{d:"M2.5 3.5l18 18",stroke:"currentColor",strokeWidth:"2"})]})})]})]})})}function Ss(){const[c,r]=a.useState(!1),[l,p]=a.useState(null),[i,h]=a.useState(null);return a.useEffect(()=>{if(!c)return;const x=()=>{p(Ft()),h(Cs())};x();const d=setInterval(x,2e3);return()=>clearInterval(d)},[c]),null}a.lazy(()=>ks(()=>import("./SettingsPanel-CrhxzLxV.js"),__vite__mapDeps([0,1,2,3])));const ht=a.memo(function({photo:r,className:l,alt:p="",useThumbnail:i=!0}){const[h,x]=a.useState("");return a.useEffect(()=>{if(r){if(typeof r=="string"){x(r);return}if(r.data?.startsWith("data:")){x(r.data);return}if(r.id&&window.electronAPI){const d=i?Ie:Z,m=i?r.id.replace(/\.[^.]+$/,".webp"):r.id,M=d.get(m);if(M){x(M);return}(i&&window.electronAPI.getThumbnailUrl?window.electronAPI.getThumbnailUrl:window.electronAPI.getPhotoUrl)(r.id).then(y=>{y&&(d.set(m,y),x(y))})}}},[r,i]),h?e.jsx("img",{src:h,alt:p,className:l,loading:"lazy"}):e.jsx("div",{className:l,style:{background:"#f0f0f0"}})}),_t=a.memo(function({marker:r,onClick:l}){return e.jsxs("div",{className:"marker-list-item",onClick:l,children:[(r.firstPhoto||r.photos?.[0])&&e.jsx(ht,{photo:r.firstPhoto||r.photos[0],className:"marker-list-thumb"}),e.jsxs("div",{className:"marker-list-info",children:[e.jsx("div",{className:"marker-list-name",children:r.name||`${r.lat.toFixed(3)}Â°, ${r.lng.toFixed(3)}Â°`}),e.jsxs("div",{className:"marker-list-meta",children:["ðŸ“· ",r.photoCount??r.photos?.length??0," å¼  Â· ",r.createdAt?new Date(r.createdAt).toLocaleDateString("zh-CN"):"æœªçŸ¥æ—¶é—´"]})]})]})}),pe=window.mapboxgl;pe.accessToken="pk.eyJ1IjoiZm43cXAiLCJhIjoiY21peTUyd3B5MGJqMTNjcTU4aDVtdnNqNiJ9.TadVpAbhvEATQxuflxmqdA";const dt=(c,r)=>{const l=Math.PI,p=6378245,i=.006693421622965943,h=(k,v)=>{let R=-100+2*k+3*v+.2*v*v+.1*k*v+.2*Math.sqrt(Math.abs(k));return R+=(20*Math.sin(6*k*l)+20*Math.sin(2*k*l))*2/3,R+=(20*Math.sin(v*l)+40*Math.sin(v/3*l))*2/3,R+=(160*Math.sin(v/12*l)+320*Math.sin(v*l/30))*2/3,R},x=(k,v)=>{let R=300+k+2*v+.1*k*k+.1*k*v+.1*Math.sqrt(Math.abs(k));return R+=(20*Math.sin(6*k*l)+20*Math.sin(2*k*l))*2/3,R+=(20*Math.sin(k*l)+40*Math.sin(k/3*l))*2/3,R+=(150*Math.sin(k/12*l)+300*Math.sin(k/30*l))*2/3,R};let d=h(c-105,r-35),m=x(c-105,r-35);const M=r/180*l;let g=Math.sin(M);g=1-i*g*g;const y=Math.sqrt(g);return d=d*180/(p*(1-i)/(g*y)*l),m=m*180/(p/y*Math.cos(M)*l),{lng:c-m,lat:r-d}};function As(){const[c,r]=a.useState(!1),[l,p]=a.useState(!1),[i,h]=a.useState([]),[x,d]=a.useState({lat:0,lng:0,x:0,y:0}),[m,M]=a.useState(null),[g,y]=a.useState(null),[k,v]=a.useState(null),[R,de]=a.useState(""),[K,W]=a.useState(0),[se,ne]=a.useState(!1),[$,ge]=a.useState("map"),[O,fe]=a.useState(!1),[T,B]=a.useState(null),[He,Pe]=a.useState(""),[We,ve]=a.useState(null),[pt,Se]=a.useState(!1),[H,A]=a.useState(!1),[f,S]=a.useState(null),[b,D]=a.useState(null),[L,U]=a.useState(!1),[Y,_]=a.useState([]),[re,X]=a.useState({count:0,size:0}),[Ae,Re]=a.useState(!1),[gt,he]=a.useState(!1),[G,F]=a.useState(!1),[qe,xt]=a.useState("time"),[je,Bt]=a.useState(""),[we,Je]=a.useState([]),[ft,Ze]=a.useState(!1),[Ke,Te]=a.useState(!1),[Ye,Le]=a.useState(!1),[oe,Xe]=a.useState(""),Ge=a.useDeferredValue(oe),[Qe,ye]=a.useState([]),[Ve,xe]=a.useState(!1),[Ht,vt]=a.useState(!1),[Ne,jt]=a.useState(()=>{try{return JSON.parse(localStorage.getItem("searchHistory")||"[]")}catch{return[]}}),[De,ie]=a.useState(-1),ze=a.useRef(null),[ke,wt]=a.useState(null),[Wt,yt]=a.useState(!0),[le,Nt]=a.useState(!1),[et,Ee]=a.useState(new Set),[Ds,zs]=a.useState(0),[$e,tt]=a.useState(null),st={antialias:!0,fadeDuration:200,maxTileCacheSize:4e3,dragRotate:!1,renderWorldCopies:!1,maxZoom:18,minZoom:0},[E,nt]=a.useState(()=>{try{const t=localStorage.getItem("mapSettings");return t?{...st,...JSON.parse(t)}:st}catch{return st}}),[z,Q]=a.useState(E),[qt,at]=a.useState(null),[Jt,kt]=a.useState([]),rt=a.useRef(null),C=a.useRef(null),Ue=a.useRef({}),Oe=a.useRef(null),Zt=a.useRef(i),ae=a.useRef(null),bt=a.useRef(!1),ue=a.useRef(null);a.useEffect(()=>{Zt.current=i},[i]);const be=a.useCallback(async t=>{if(!t)return null;if(typeof t=="string")return t;if(t.data&&t.data.startsWith("data:"))return t.data;const s=t.id;if(!s)return null;const n=Z.get(s);if(n)return n;if(window.electronAPI){const u=await window.electronAPI.getPhotoUrl(s);return u&&Z.set(s,u),u}return null},[]);a.useCallback(t=>{if(!t)return"";if(typeof t=="string")return t;if(t.data&&t.data.startsWith("data:"))return t.data;const s=t.id;return Z.get(s)||""},[]);const Mt=a.useMemo(()=>i.reduce((t,s)=>t+(s.photoCount??s.photos?.length??0),0),[i]);a.useEffect(()=>{if(T&&T.photos[T.index]){be(T.photos[T.index]).then(s=>{Pe(s||"")});const t=()=>{const{photos:s,index:n}=T;[n+1,n-1].filter(o=>o>=0&&o<s.length).forEach(o=>{be(s[o]).then(j=>{if(j){const w=new Image;w.src=j}})})};"requestIdleCallback"in window?requestIdleCallback(t,{timeout:1e3}):setTimeout(t,100)}else Pe(""),ve(null)},[T,be]),a.useEffect(()=>{if(T&&T.photos[T.index]){const t=T.photos[T.index];t?.id&&window.electronAPI?.getPhotoInfo?window.electronAPI.getPhotoInfo(t.id).then(s=>{ve(s)}):ve(null)}},[T?.index,T?.photos]);const q=a.useCallback((t,s,n=2500)=>{wt({type:t,message:s}),setTimeout(()=>wt(null),n)},[]);a.useEffect(()=>{const t=s=>{if(!(s.target.tagName==="INPUT"||s.target.tagName==="TEXTAREA")){if(s.key==="Escape"){if(T){B(null);return}if($e){tt(null);return}if(se){ne(!1);return}if(G){F(!1);return}if(g){y(null);return}if(m){M(null),v(null);return}if(O){fe(!1);return}}if(T){s.key==="ArrowLeft"||s.key==="a"?(B(n=>({...n,index:(n.index-1+n.photos.length)%n.photos.length})),he(!1)):(s.key==="ArrowRight"||s.key==="d")&&(B(n=>({...n,index:(n.index+1)%n.photos.length})),he(!1));return}!se&&!G&&!g&&!m&&(s.key==="f"||s.key==="F"?(s.preventDefault(),ze.current?.focus()):s.key==="m"||s.key==="M"?F(!0):s.key==="h"||s.key==="H"?Nt(n=>!n):(s.key==="s"||s.key==="S")&&!s.ctrlKey&&!s.metaKey?ne(!0):s.key==="r"||s.key==="R"?fe(n=>!n):s.key==="+"||s.key==="="?C.current?.zoomIn():s.key==="-"?C.current?.zoomOut():s.key==="0"&&ae.current&&C.current&&C.current.flyTo({center:ae.current,zoom:13,duration:1e3}))}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[T,$e,se,G,g,m,O]),a.useEffect(()=>(bs(),window.electronAPI&&(yt(!0),window.electronAPI.loadMarkers().then(t=>{h(t),yt(!1);const s=t.filter(n=>!n.name);s.length>0&&Promise.all(s.map(async n=>{try{const o=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${n.lng},${n.lat}.json?access_token=${pe.accessToken}&language=zh&limit=1`)).json();if(o.features?.[0]){const w=(o.features[0].place_name_zh||o.features[0].place_name||"").replace(/\s*\d{5,6}\s*$/,"").replace(/,\s*$/,"");return window.electronAPI.updateMarker({id:n.id,lat:n.lat,lng:n.lng,name:w}),{id:n.id,name:w}}}catch{}return null})).then(n=>{const u={};n.forEach(o=>{o&&(u[o.id]=o.name)}),Object.keys(u).length>0&&h(o=>o.map(j=>u[j.id]?{...j,name:u[j.id]}:j))})}),window.electronAPI.getCacheStats().then(X)),()=>{Ms()}),[]),a.useEffect(()=>{let t=0;const s=setInterval(()=>{t+=Math.random()*35+20,t>95&&(t=95),W(t)},25),n=new AbortController,u=setTimeout(()=>n.abort(),1500);fetch("https://restapi.amap.com/v3/ip?key=9fb3c3f43537ecacd6d0a082958a883c",{signal:n.signal}).then(o=>o.json()).then(o=>{if(clearTimeout(u),o.status==="1"&&o.rectangle){const[j,w]=o.rectangle.split(";").map(P=>P.split(",").map(Number)),I=(j[0]+w[0])/2,N=(j[1]+w[1])/2;ae.current=[I,N],console.log("é«˜å¾·IPå®šä½:",o.city,[I,N])}}).catch(()=>{clearTimeout(u)}).finally(()=>{ae.current||(ae.current=[117.28,31.86]),clearInterval(s),W(100)})},[]),a.useEffect(()=>{if(!c||!rt.current||C.current)return;const t=new pe.Map({container:rt.current,style:"mapbox://styles/mapbox/streets-v12",center:[105,35],zoom:1,pitch:0,language:"zh-Hans",antialias:E.antialias,fadeDuration:E.fadeDuration,maxTileCacheSize:E.maxTileCacheSize,dragRotate:E.dragRotate,renderWorldCopies:E.renderWorldCopies,maxZoom:E.maxZoom,minZoom:E.minZoom,trackResize:!0,refreshExpiredTiles:!1,scrollZoom:!0,pitchWithRotate:!1,crossSourceCollisions:!1,collectResourceTiming:!1,preserveDrawingBuffer:!1,failIfMajorPerformanceCaveat:!1});t.on("dragstart",()=>Re(!0)),t.on("dragend",()=>Re(!1));let s=0;return t.on("mousemove",n=>{const u=Date.now();u-s<16||(s=u,d({lat:n.lngLat.lat,lng:n.lngLat.lng,x:n.point.x,y:n.point.y}))}),t.on("click",n=>{const u=document.createElement("div");if(u.className="click-ripple",u.style.left=`${n.point.x}px`,u.style.top=`${n.point.y}px`,document.body.appendChild(u),setTimeout(()=>u.remove(),700),bt.current){const N={lat:n.lngLat.lat,lng:n.lngLat.lng};if(!ue.current)ue.current=N,at(N);else{const P=[ue.current.lng,ue.current.lat],V=[N.lng,N.lat],ee=Kt(P,V),te=ee>=1?`${ee.toFixed(2)} km`:`${Math.round(ee*1e3)} m`;kt(J=>[...J,{start:ue.current,end:N,distance:te}]),ue.current=null,at(null)}return}const o={lat:n.lngLat.lat,lng:n.lngLat.lng};v(o),M({x:n.point.x,y:n.point.y,latlng:o}),de(`${o.lat.toFixed(3)}Â°, ${o.lng.toFixed(3)}Â°`);const j=o.lng>=73&&o.lng<=135&&o.lat>=18&&o.lat<=54,w=new AbortController,I=setTimeout(()=>w.abort(),3e3);j?fetch(`https://restapi.amap.com/v3/geocode/regeo?key=9fb3c3f43537ecacd6d0a082958a883c&location=${o.lng},${o.lat}&extensions=base`,{signal:w.signal}).then(N=>N.json()).then(N=>{clearTimeout(I),N.status==="1"&&N.regeocode?.formatted_address&&de(N.regeocode.formatted_address)}).catch(()=>clearTimeout(I)):fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${o.lng},${o.lat}.json?access_token=${pe.accessToken}&language=zh-Hans&limit=1`,{signal:w.signal}).then(N=>N.json()).then(N=>{if(clearTimeout(I),N.features?.[0]){let P=N.features[0].place_name||"";P=P.replace(/\s*\d{5,6}\s*$/,"").replace(/,\s*$/,""),P&&de(P)}}).catch(()=>clearTimeout(I))}),t.on("load",()=>{A(!0),t.addSource("markers-heatmap",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),t.addLayer({id:"markers-heat",type:"heatmap",source:"markers-heatmap",maxzoom:18,layout:{visibility:"none"},paint:{"heatmap-weight":["interpolate",["linear"],["get","photoCount"],1,.4,5,.7,10,.9,20,1],"heatmap-intensity":["interpolate",["linear"],["zoom"],0,2,5,1.5,10,2,15,3],"heatmap-color":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"rgba(65, 105, 225, 0.5)",.3,"rgb(0, 191, 255)",.5,"rgb(50, 205, 50)",.7,"rgb(255, 215, 0)",.85,"rgb(255, 140, 0)",1,"rgb(255, 0, 0)"],"heatmap-radius":["interpolate",["linear"],["zoom"],0,15,3,20,6,25,10,30,15,40],"heatmap-opacity":["interpolate",["linear"],["zoom"],0,.8,10,.85,15,.6]}}),setTimeout(()=>{ae.current&&t.flyTo({center:ae.current,zoom:13,duration:2e3})},800)}),C.current=t,()=>{t.remove(),C.current=null}},[c]);const Kt=(t,s)=>{const u=(s[1]-t[1])*Math.PI/180,o=(s[0]-t[0])*Math.PI/180,j=Math.sin(u/2)*Math.sin(u/2)+Math.cos(t[1]*Math.PI/180)*Math.cos(s[1]*Math.PI/180)*Math.sin(o/2)*Math.sin(o/2);return 6371*2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j))},Ct=a.useCallback((t,s=[])=>{const n=document.createElement("div");return n.className="marker-pin",s.length>0?(n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.innerHTML=`
        <div class="marker-photo-preview">
          <img src="" alt="é¢„è§ˆ" loading="lazy" style="background:#f0f0f0" />
          ${s.length>1?`<span class="photo-badge">+${s.length-1}</span>`:""}
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="32" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="${t}"/><circle cx="12" cy="12" r="5" fill="white"/></svg>
      `,be(s[0]).then(u=>{const o=n.querySelector("img");o&&u&&(o.src=u)})):(n.style.width="24px",n.style.height="32px",n.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="32" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="${t}"/><circle cx="12" cy="12" r="5" fill="white"/></svg>`),n.style.cursor="pointer",n},[be]);a.useRef({}),a.useCallback((t,s)=>{const n=document.createElement("div");if(n.className="marker-pin",n.style.cssText="cursor:pointer;display:flex;flex-direction:column;align-items:center;",t){n.innerHTML=`
        <div class="marker-photo-preview" style="width:48px;height:48px;border-radius:6px;overflow:hidden;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);background:#f0f0f0;margin-bottom:2px;position:relative;">
          <img src="" style="width:100%;height:100%;object-fit:cover;display:block;" />
          ${s>1?`<span style="position:absolute;top:2px;right:2px;background:rgba(0,0,0,0.6);color:white;font-size:10px;padding:1px 4px;border-radius:8px;">+${s-1}</span>`:""}
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="26" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="#ff6b6b"/><circle cx="12" cy="12" r="4" fill="white"/></svg>
      `;const u=n.querySelector("img");window.electronAPI?.getThumbnailUrl&&window.electronAPI.getThumbnailUrl(t).then(o=>{o&&(u.src=o)})}else n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="32" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="#ff6b6b"/><circle cx="12" cy="12" r="5" fill="white"/></svg>';return n},[]);const It=a.useCallback((t,s)=>{const n=document.createElement("div");n.className="marker-pin",n.style.cssText=`cursor:pointer;display:flex;flex-direction:column;align-items:center;${s?"animation:markerDrop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;":""}`;const u=t.firstPhoto?.id||null,o=t.photoCount??0;return u?(n.innerHTML=`
        <div class="marker-photo-preview" style="width:48px;height:48px;border-radius:6px;overflow:hidden;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);background:#e2e8f0;margin-bottom:2px;position:relative;">
          <img src="" style="width:100%;height:100%;object-fit:cover;display:block;opacity:0;transition:opacity 0.2s;" />
          ${o>1?`<span style="position:absolute;top:2px;right:2px;background:rgba(0,0,0,0.6);color:white;font-size:10px;padding:1px 4px;border-radius:8px;">+${o-1}</span>`:""}
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="26" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="#ff6b6b"/><circle cx="12" cy="12" r="4" fill="white"/></svg>
      `,window.electronAPI?.getThumbnailUrl&&window.electronAPI.getThumbnailUrl(u).then(j=>{const w=n.querySelector("img");w&&j&&(w.onload=()=>{w.style.opacity="1"},w.src=j)})):n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="32" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="#ff6b6b"/><circle cx="12" cy="12" r="5" fill="white"/></svg>',n.addEventListener("click",async j=>{j.stopPropagation(),C.current.flyTo({center:[t.lng,t.lat],zoom:Math.max(C.current.getZoom(),15),duration:800}),setTimeout(async()=>{const w=C.current.project([t.lng,t.lat]);let I=t;if(window.electronAPI?.getMarkerDetail){const N=await window.electronAPI.getMarkerDetail(t.id);N&&(I=N)}y({x:w.x,y:w.y,marker:I})},850),M(null),v(null)}),n},[]),Pt=a.useCallback(()=>{C.current&&(Object.values(Ue.current).forEach(t=>t.remove()),Ue.current={},i.forEach(t=>{const s=et.has(t.id),n=It(t,s),u=new pe.Marker({element:n,anchor:"bottom"}).setLngLat([t.lng,t.lat]).addTo(C.current);Ue.current[t.id]=u,le&&(n.style.display="none")}))},[i,et,It,le]);a.useEffect(()=>{H&&Pt()},[i,H,Pt,et]),a.useEffect(()=>{if(!C.current||!H)return;const t=C.current.getSource("markers-heatmap");if(!t)return;const s=i.map(n=>({type:"Feature",geometry:{type:"Point",coordinates:[n.lng,n.lat]},properties:{photoCount:n.photoCount??n.photos?.length??1}}));t.setData({type:"FeatureCollection",features:s})},[i,H]),a.useEffect(()=>{!C.current||!H||!C.current.getLayer("markers-heat")||(C.current.setLayoutProperty("markers-heat","visibility",le?"visible":"none"),Object.values(Ue.current).forEach(s=>{s.getElement().style.display=le?"none":"flex"}))},[le,H]),a.useEffect(()=>{if(C.current&&(Oe.current&&(Oe.current.remove(),Oe.current=null),k)){const t=Ct("#00b894");Oe.current=new pe.Marker({element:t,anchor:"bottom"}).setLngLat([k.lng,k.lat]).addTo(C.current)}},[k,Ct]);const ce=a.useCallback(()=>{window.electronAPI&&window.electronAPI.loadMarkers().then(h)},[]),St=a.useCallback(async(t,s)=>{const n=s>=73&&s<=135&&t>=18&&t<=54;try{if(n){const o=await(await fetch(`https://restapi.amap.com/v3/geocode/regeo?key=9fb3c3f43537ecacd6d0a082958a883c&location=${s},${t}&extensions=base`,{signal:AbortSignal.timeout(3e3)})).json();if(o.status==="1"&&o.regeocode?.formatted_address)return o.regeocode.formatted_address}else{const o=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${s},${t}.json?access_token=${pe.accessToken}&language=zh-Hans&limit=1`,{signal:AbortSignal.timeout(3e3)})).json();if(o.features?.[0])return(o.features[0].place_name||"").replace(/\s*\d{5,6}\s*$/,"").replace(/,\s*$/,"")}}catch{}return`${t.toFixed(3)}Â°, ${s.toFixed(3)}Â°`},[]),Yt=async t=>{if(!window.electronAPI)return;const s=await window.electronAPI.selectPhotos();if(!s||s.length===0)return;const n=await St(t.lat,t.lng),u={id:Lt(),lat:t.lat,lng:t.lng,name:n,photos:s.map(o=>({id:o.id,note:""})),createdAt:Date.now()};await window.electronAPI.addMarker(u),Ee(o=>new Set(o).add(u.id)),setTimeout(()=>Ee(o=>{const j=new Set(o);return j.delete(u.id),j}),600),ce(),M(null),v(null),q("success",`å·²æ·»åŠ  ${s.length} å¼ ç…§ç‰‡`)},Xt=async(t,s,n)=>{window.electronAPI&&(await window.electronAPI.updatePhotoNote(t,s,n),q("success","å¤‡æ³¨å·²ä¿å­˜")),S(null)},ot=a.useCallback(t=>typeof t=="string"?"":t.note||"",[]),At=a.useCallback(()=>{M(null),v(null),y(null)},[]),Gt=a.useCallback(async t=>{window.electronAPI&&(await window.electronAPI.deleteMarker(t),ce(),q("success","æ ‡è®°å·²åˆ é™¤"))},[ce,q]),Qt=a.useCallback(()=>{p(!0),window.electronAPI?.setTitleBarOverlay?.({color:"#00000000",symbolColor:"#64748b",height:32}),setTimeout(()=>r(!0),600)},[]),Vt=a.useCallback(()=>{C.current&&ae.current&&C.current.flyTo({center:ae.current,zoom:15,duration:1e3})},[]),es=a.useCallback(()=>C.current?.zoomIn(),[]),ts=a.useCallback(()=>C.current?.zoomOut(),[]),_e=a.useCallback((t,s,n,u)=>{const j=(u-s)*Math.PI/180,w=(n-t)*Math.PI/180,I=Math.sin(j/2)*Math.sin(j/2)+Math.cos(s*Math.PI/180)*Math.cos(u*Math.PI/180)*Math.sin(w/2)*Math.sin(w/2);return 6371*2*Math.atan2(Math.sqrt(I),Math.sqrt(1-I))},[]),it="9fb3c3f43537ecacd6d0a082958a883c",Rt=a.useCallback(async t=>{if(!t.trim()){ye([]);return}vt(!0),ie(-1);try{const s=C.current?.getCenter()||{lng:117,lat:32},n=new AbortController,u=setTimeout(()=>n.abort(),5e3);let o=[];const w=await(await fetch(`https://restapi.amap.com/v3/assistant/inputtips?key=${it}&keywords=${encodeURIComponent(t)}&location=${s.lng},${s.lat}&datatype=all`,{signal:n.signal})).json();if(w.status==="1"&&w.tips?.length>0&&(o=w.tips.filter(N=>N.location&&N.location.includes(",")).slice(0,10).map(N=>{const[P,V]=N.location.split(",").map(Number),{lng:ee,lat:te}=dt(P,V),J=_e(s.lng,s.lat,ee,te);return{name:N.name,address:N.district||N.address||"",type:N.typecode||"",lng:ee,lat:te,distance:J<1?`${Math.round(J*1e3)}m`:`${J.toFixed(1)}km`}})),o.length===0){const N=await(await fetch(`https://restapi.amap.com/v3/place/text?key=${it}&keywords=${encodeURIComponent(t)}&offset=10&extensions=base`,{signal:n.signal})).json();N.status==="1"&&N.pois?.length>0&&(o=N.pois.map(P=>{const[V,ee]=P.location.split(",").map(Number),{lng:te,lat:J}=dt(V,ee),me=_e(s.lng,s.lat,te,J);return{name:P.name,address:(P.pname||"")+(P.cityname||"")+(P.adname||""),type:P.type||"",lng:te,lat:J,distance:me<1?`${Math.round(me*1e3)}m`:`${me.toFixed(1)}km`}}))}if(o.length===0){const N=await(await fetch(`https://restapi.amap.com/v3/geocode/geo?key=${it}&address=${encodeURIComponent(t)}`,{signal:n.signal})).json();N.status==="1"&&N.geocodes?.length>0&&(o=N.geocodes.map(P=>{const[V,ee]=P.location.split(",").map(Number),{lng:te,lat:J}=dt(V,ee),me=_e(s.lng,s.lat,te,J);return{name:P.formatted_address||t,address:(P.province||"")+(P.city||"")+(P.district||""),type:"region",lng:te,lat:J,distance:me<1?`${Math.round(me*1e3)}m`:`${me.toFixed(1)}km`}}))}clearTimeout(u),ye(o)}catch(s){s.name!=="AbortError"&&ye([])}vt(!1)},[_e]);a.useEffect(()=>{Ge?Rt(Ge):ye([])},[Ge,Rt]);const Tt=a.useCallback(t=>{jt(s=>{const n=s.filter(o=>o.name!==t.name),u=[{name:t.name,address:t.address,lng:t.lng,lat:t.lat},...n].slice(0,10);return localStorage.setItem("searchHistory",JSON.stringify(u)),u})},[]),ss=a.useCallback(()=>{jt([]),localStorage.removeItem("searchHistory")},[]);a.useCallback(async(t,s)=>{if(!window.electronAPI?.rotatePhoto)return!1;const n=await window.electronAPI.rotatePhoto(t,s);return n?(q("success","ç…§ç‰‡å·²æ—‹è½¬"),Z.delete(t),Ie.delete(t.replace(/\.[^.]+$/,".webp"))):q("error","æ—‹è½¬å¤±è´¥"),n},[q]);const ns=a.useCallback(async(t,s)=>{if(!window.electronAPI?.cropPhoto)return!1;const n=await window.electronAPI.cropPhoto(t,s);return n?(q("success","ç…§ç‰‡å·²è£å‰ª"),Z.delete(t),Ie.delete(t.replace(/\.[^.]+$/,".webp"))):q("error","è£å‰ªå¤±è´¥"),n},[q]),as=t=>{Xe(t),ie(-1),(t||Ne.length>0)&&xe(!0)},rs=()=>{(oe||Ne.length>0)&&xe(!0)},os=t=>{const s=oe?Qe:Ne;s.length&&(t.key==="ArrowDown"?(t.preventDefault(),ie(n=>Math.min(n+1,s.length-1))):t.key==="ArrowUp"?(t.preventDefault(),ie(n=>Math.max(n-1,-1))):t.key==="Enter"&&De>=0?(t.preventDefault(),lt(s[De])):t.key==="Escape"&&(xe(!1),ze.current?.blur()))},lt=a.useCallback(t=>{if(C.current){let s=17;t.type==="region"||t.type?.includes("çœ")||t.type?.includes("å¸‚")?s=14:(t.type?.includes("åŒº")||t.type?.includes("åŽ¿"))&&(s=15),C.current.flyTo({center:[t.lng,t.lat],zoom:s,duration:1500})}Tt(t),xe(!1),Xe(t.name),ie(-1)},[Tt]),is=()=>{fe(!1),bt.current=!1,ue.current=null,at(null)},ls=()=>{kt([])};return c?e.jsxs("div",{className:"app",children:[e.jsx("div",{className:"window-drag-region"}),e.jsx("div",{ref:rt,className:`map-container ${O?"measure-mode":""}`}),!O&&e.jsxs("div",{className:"search-bar-container",children:[e.jsxs("div",{className:"search-bar",onClick:()=>ze.current?.focus(),children:[e.jsx("span",{className:"search-icon",children:"ðŸ”"}),e.jsx("input",{type:"text",placeholder:"æœç´¢åœ°ç‚¹...",value:oe,onChange:t=>as(t.target.value),onFocus:rs,onKeyDown:os,ref:ze}),oe&&e.jsx("button",{className:"search-clear",onClick:t=>{t.stopPropagation(),Xe(""),ye([]),xe(!1),ie(-1)},children:"âœ•"})]}),Ve&&e.jsx("div",{className:"search-results",children:Ht?e.jsxs("div",{className:"search-loading",children:[e.jsx("span",{className:"loading-spinner"}),"æœç´¢ä¸­..."]}):oe&&Qe.length>0?Qe.map((t,s)=>e.jsxs("div",{className:`search-result-item ${De===s?"selected":""}`,onClick:()=>lt(t),onMouseEnter:()=>ie(s),children:[e.jsx("span",{className:"result-icon",children:t.type?.includes("é¤é¥®")?"ðŸ½ï¸":t.type?.includes("é…’åº—")||t.type?.includes("ä½å®¿")?"ðŸ¨":t.type?.includes("é£Žæ™¯")||t.type?.includes("å…¬å›­")||t.type?.includes("æ—…æ¸¸")?"ðŸžï¸":t.type?.includes("åŒ»ç–—")||t.type?.includes("åŒ»é™¢")?"ðŸ¥":t.type?.includes("å­¦æ ¡")||t.type?.includes("æ•™è‚²")?"ðŸ«":t.type?.includes("è´­ç‰©")||t.type?.includes("å•†åœº")?"ðŸ›’":t.type?.includes("äº¤é€š")||t.type?.includes("ç«™")||t.type?.includes("åœ°é“")?"ðŸš‰":t.type?.includes("é“¶è¡Œ")||t.type?.includes("é‡‘èž")?"ðŸ¦":t.type?.includes("æ”¿åºœ")||t.type?.includes("æœºå…³")?"ðŸ›ï¸":t.type?.includes("å°åŒº")||t.type?.includes("ä½å®…")?"ðŸ˜ï¸":t.type?.includes("å†™å­—æ¥¼")||t.type?.includes("å…¬å¸")?"ðŸ¢":t.type?.includes("åœ°å")||t.type==="region"?"ðŸ—ºï¸":"ðŸ“"}),e.jsxs("div",{className:"result-info",children:[e.jsx("div",{className:"result-name",children:t.name}),e.jsx("div",{className:"result-address",children:t.address})]}),e.jsx("span",{className:"result-distance",children:t.distance})]},s)):oe?e.jsxs("div",{className:"search-empty",children:['æœªæ‰¾åˆ° "',oe,'" ç›¸å…³åœ°ç‚¹']}):Ne.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"search-history-header",children:[e.jsx("span",{children:"ðŸ• æœç´¢åŽ†å²"}),e.jsx("button",{onClick:ss,children:"æ¸…é™¤"})]}),Ne.map((t,s)=>e.jsxs("div",{className:`search-result-item history-item ${De===s?"selected":""}`,onClick:()=>lt(t),onMouseEnter:()=>ie(s),children:[e.jsx("span",{className:"result-icon",children:"ðŸ•"}),e.jsxs("div",{className:"result-info",children:[e.jsx("div",{className:"result-name",children:t.name}),e.jsx("div",{className:"result-address",children:t.address})]})]},s))]}):e.jsx("div",{className:"search-tip",children:"è¾“å…¥åœ°åã€åœ°å€æœç´¢"})})]}),Ve&&e.jsx("div",{className:"search-overlay",onClick:()=>xe(!1)}),!Ae&&!m&&!g&&!se&&!G&&!T&&!Ve&&!b&&!f&&e.jsxs("div",{className:"cursor-info",style:{left:Math.min(x.x+15,window.innerWidth-120),top:Math.max(x.y-35,10),opacity:x.x>0?1:0},children:[x.lat.toFixed(3),"Â°, ",x.lng.toFixed(3),"Â°"]}),!O&&e.jsxs("div",{className:"toolbar toolbar-left",children:[e.jsx("button",{onClick:Vt,"data-tooltip":"å®šä½",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M12 2v4m0 12v4M2 12h4m12 0h4"})]})}),e.jsx("button",{onClick:()=>window.location.reload(),"data-tooltip":"åˆ·æ–°",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"}),e.jsx("path",{d:"M21 3v5h-5"}),e.jsx("path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"}),e.jsx("path",{d:"M3 21v-5h5"})]})})]}),!O&&e.jsxs("div",{className:"toolbar toolbar-right",children:[e.jsx("button",{onClick:es,"data-tooltip":"æ”¾å¤§",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),e.jsx("button",{onClick:ts,"data-tooltip":"ç¼©å°",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),e.jsx("button",{onClick:()=>Nt(!le),"data-tooltip":le?"å…³é—­çƒ­åŠ›å›¾":"çƒ­åŠ›å›¾",className:le?"active":"",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("circle",{cx:"12",cy:"12",r:"6",opacity:"0.5"}),e.jsx("circle",{cx:"12",cy:"12",r:"9",opacity:"0.25"})]})}),e.jsx("button",{onClick:async()=>{if(Q(E),ne(!0),window.electronAPI){const t=await window.electronAPI.getCacheStats();X(t)}},"data-tooltip":"è®¾ç½®",className:"settings-btn",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),e.jsx("circle",{cx:"12",cy:"12",r:"3"})]})})]}),!O&&e.jsxs("button",{className:"marker-count-btn",onClick:()=>F(!0),title:"æŸ¥çœ‹æ‰€æœ‰æ ‡è®°å’Œæœç´¢å¤‡æ³¨",children:["ðŸ“Œ ",i.length," Â· ðŸ“· ",Mt]}),G&&e.jsx("div",{className:"marker-list-overlay",onClick:()=>F(!1),children:e.jsxs("div",{className:"marker-list-panel",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"marker-list-header",children:[e.jsx("h3",{children:"ðŸ“ æ‰€æœ‰æ ‡è®°"}),e.jsx("button",{className:"panel-close",onClick:()=>F(!1),children:"âœ•"})]}),e.jsxs("div",{className:"marker-list-toolbar",children:[e.jsx("input",{type:"text",placeholder:"ðŸ” æœç´¢åœ°åæˆ–å¤‡æ³¨...",value:je,onChange:t=>{Bt(t.target.value),t.target.value.trim()&&window.electronAPI?.searchPhotos?(Ze(!0),window.electronAPI.searchPhotos(t.target.value).then(s=>{Je(s||[]),Ze(!1)}).catch(()=>{Je([]),Ze(!1)})):Je([])},className:"marker-search"}),e.jsxs("div",{className:"sort-btns",children:[e.jsx("button",{className:qe==="time"?"active":"",onClick:()=>xt("time"),children:"ðŸ• æ—¶é—´"}),e.jsx("button",{className:qe==="name"?"active":"",onClick:()=>xt("name"),children:"ðŸ”¤ åœ°å"})]})]}),e.jsx("div",{className:"marker-list-content",children:(()=>{const t=i.filter(n=>je?(n.name||`${n.lat.toFixed(3)}Â°, ${n.lng.toFixed(3)}Â°`).toLowerCase().includes(je.toLowerCase()):!0).sort((n,u)=>{if(qe==="time")return(u.createdAt||0)-(n.createdAt||0);{const o=n.name||"",j=u.name||"";return o.localeCompare(j,"zh-CN")}});if(Wt)return[1,2,3,4].map(n=>e.jsxs("div",{className:"skeleton-list-item",children:[e.jsx("div",{className:"skeleton-list-thumb"}),e.jsxs("div",{className:"skeleton-list-info",children:[e.jsx("div",{className:"skeleton-text medium"}),e.jsx("div",{className:"skeleton-text short"})]})]},n));if(je){const n=t.length>0,u=we.length>0;return!n&&!u&&!ft?e.jsxs("div",{className:"marker-list-empty",children:['æœªæ‰¾åˆ°åŒ¹é… "',je,'" çš„ç»“æžœ']}):e.jsxs("div",{className:"search-results-grouped",children:[n&&e.jsxs("div",{className:"result-group",children:[e.jsxs("div",{className:"result-group-title",children:["ðŸ“ æ ‡è®° (",t.length,")"]}),t.slice(0,10).map(o=>e.jsx(_t,{marker:o,onClick:async()=>{F(!1),C.current&&(C.current.flyTo({center:[o.lng,o.lat],zoom:15,duration:1e3}),setTimeout(async()=>{const j=C.current.project([o.lng,o.lat]);let w=o;if(window.electronAPI?.getMarkerDetail){const I=await window.electronAPI.getMarkerDetail(o.id);I&&(w=I)}y({x:j.x,y:j.y,marker:w})},1050))}},o.id)),t.length>10&&e.jsxs("div",{className:"result-more",children:["è¿˜æœ‰ ",t.length-10," ä¸ªç»“æžœ..."]})]}),ft?e.jsxs("div",{className:"result-group",children:[e.jsx("div",{className:"result-group-title",children:"ðŸ“ å¤‡æ³¨"}),e.jsxs("div",{className:"marker-list-empty",children:[e.jsx("span",{className:"loading-spinner"})," æœç´¢ä¸­..."]})]}):u&&e.jsxs("div",{className:"result-group",children:[e.jsxs("div",{className:"result-group-title",children:["ðŸ“ å¤‡æ³¨ (",we.length,")"]}),we.slice(0,10).map((o,j)=>e.jsxs("div",{className:"marker-list-item note-item",onClick:async()=>{if(F(!1),C.current&&C.current.flyTo({center:[o.lng,o.lat],zoom:15,duration:1e3}),window.electronAPI?.getMarkerDetail){const w=await window.electronAPI.getMarkerDetail(o.markerId);if(w){const I=w.photos.findIndex(N=>N.id===o.fileId);B({photos:w.photos,index:I>=0?I:0,markerId:o.markerId})}}},children:[e.jsx(ht,{photo:{id:o.fileId},className:"marker-list-thumb"}),e.jsxs("div",{className:"marker-list-info",children:[e.jsxs("div",{className:"marker-list-name",children:['"',o.note,'"']}),e.jsxs("div",{className:"marker-list-meta",children:["ðŸ“ ",o.markerName||`${o.lat.toFixed(3)}Â°, ${o.lng.toFixed(3)}Â°`]})]})]},`note-${j}`)),we.length>10&&e.jsxs("div",{className:"result-more",children:["è¿˜æœ‰ ",we.length-10," ä¸ªç»“æžœ..."]})]})]})}if(t.length===0)return e.jsx("div",{className:"marker-list-empty",children:"æš‚æ— æ ‡è®°ï¼Œç‚¹å‡»åœ°å›¾æ·»åŠ "});const s=({index:n,style:u})=>{const o=t[n];return e.jsx("div",{style:u,children:e.jsx(_t,{marker:o,onClick:async()=>{F(!1),C.current&&(C.current.flyTo({center:[o.lng,o.lat],zoom:15,duration:1e3}),setTimeout(async()=>{const j=C.current.project([o.lng,o.lat]);let w=o;if(window.electronAPI?.getMarkerDetail){const I=await window.electronAPI.getMarkerDetail(o.id);I&&(w=I)}y({x:j.x,y:j.y,marker:w})},1050))}})})};return e.jsx(gs,{height:550,itemCount:t.length,itemSize:80,width:"100%",overscanCount:3,children:s})})()})]})}),O&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"measure-hint",children:["ðŸ“ æµ‹é‡æ¨¡å¼ - ",qt?"ç‚¹å‡»é€‰æ‹©ç»ˆç‚¹":"ç‚¹å‡»é€‰æ‹©èµ·ç‚¹"]}),e.jsxs("div",{className:"measure-toolbar",children:[Jt.length>0&&e.jsx("button",{onClick:ls,className:"measure-btn",children:"ðŸ—‘ï¸ æ¸…é™¤æµ‹é‡"}),e.jsx("button",{onClick:is,className:"measure-btn exit",children:"âœ– é€€å‡ºæµ‹é‡æ¨¡å¼"})]})]}),se&&e.jsx("div",{className:"settings-overlay",onClick:()=>{JSON.stringify(z)!==JSON.stringify(E)&&(window.confirm("è®¾ç½®å·²æ›´æ”¹ä½†æœªä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ")?(nt(z),localStorage.setItem("mapSettings",JSON.stringify(z))):Q(E)),ne(!1)},children:e.jsxs("div",{className:"settings-panel",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"settings-nav",children:[e.jsxs("div",{className:"settings-nav-header",children:[e.jsx("span",{className:"nav-icon",children:"âš™ï¸"}),e.jsx("span",{className:"nav-title",children:"è®¾ç½®"})]}),e.jsxs("div",{className:"settings-nav-items",children:[e.jsxs("button",{className:$==="map"?"active":"",onClick:()=>ge("map"),children:[e.jsx("span",{children:"ðŸ—ºï¸"})," åœ°å›¾æ˜¾ç¤º"]}),e.jsxs("button",{className:$==="performance"?"active":"",onClick:()=>ge("performance"),children:[e.jsx("span",{children:"ðŸš€"})," æ€§èƒ½ä¼˜åŒ–"]}),e.jsxs("button",{className:$==="storage"?"active":"",onClick:()=>ge("storage"),children:[e.jsx("span",{children:"ðŸ’¾"})," å­˜å‚¨ç®¡ç†"]}),e.jsxs("button",{className:$==="about"?"active":"",onClick:()=>ge("about"),children:[e.jsx("span",{children:"â„¹ï¸"})," å…³äºŽ"]})]})]}),e.jsxs("div",{className:"settings-content",children:[e.jsx("button",{className:"settings-close",onClick:()=>{JSON.stringify(z)!==JSON.stringify(E)&&(window.confirm("è®¾ç½®å·²æ›´æ”¹ä½†æœªä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ")?(nt(z),localStorage.setItem("mapSettings",JSON.stringify(z))):Q(E)),ne(!1)},children:"âœ•"}),$==="map"&&e.jsxs("div",{className:"settings-page",children:[e.jsx("h2",{children:"ðŸ—ºï¸ åœ°å›¾æ˜¾ç¤º"}),e.jsx("p",{className:"page-desc",children:"è°ƒæ•´åœ°å›¾çš„æ˜¾ç¤ºæ•ˆæžœå’Œäº¤äº’æ–¹å¼"}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"ç”»è´¨è®¾ç½®"}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"æŠ—é”¯é½¿"}),e.jsx("span",{children:"å¹³æ»‘åœ°å›¾è¾¹ç¼˜ï¼Œæå‡ç”»è´¨ä½†ä¼šå¢žåŠ GPUè´Ÿæ‹…"})]}),e.jsxs("label",{className:"switch",children:[e.jsx("input",{type:"checkbox",checked:z.antialias,onChange:t=>Q(s=>({...s,antialias:t.target.checked}))}),e.jsx("span",{className:"slider"})]})]})]}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"äº¤äº’è®¾ç½®"}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"å…è®¸æ—‹è½¬"}),e.jsx("span",{children:"å³é”®æ‹–åŠ¨å¯æ—‹è½¬åœ°å›¾è§†è§’"})]}),e.jsxs("label",{className:"switch",children:[e.jsx("input",{type:"checkbox",checked:z.dragRotate,onChange:t=>Q(s=>({...s,dragRotate:t.target.checked}))}),e.jsx("span",{className:"slider"})]})]}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"ä¸–ç•Œå‰¯æœ¬"}),e.jsx("span",{children:"å·¦å³æ— é™æ»šåŠ¨ï¼Œæ˜¾ç¤ºå¤šä¸ªåœ°çƒå‰¯æœ¬"})]}),e.jsxs("label",{className:"switch",children:[e.jsx("input",{type:"checkbox",checked:z.renderWorldCopies,onChange:t=>Q(s=>({...s,renderWorldCopies:t.target.checked}))}),e.jsx("span",{className:"slider"})]})]})]}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"ç¼©æ”¾èŒƒå›´"}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"æœ€å°ç¼©æ”¾çº§åˆ«"}),e.jsx("span",{children:"æ•°å€¼è¶Šå°å¯ä»¥çœ‹åˆ°è¶Šå¤§èŒƒå›´"})]}),e.jsxs("div",{className:"range-control",children:[e.jsx("input",{type:"range",min:"0",max:"5",step:"1",value:z.minZoom,onChange:t=>Q(s=>({...s,minZoom:Number(t.target.value)}))}),e.jsx("span",{className:"range-value",children:z.minZoom})]})]}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"æœ€å¤§ç¼©æ”¾çº§åˆ«"}),e.jsx("span",{children:"æ•°å€¼è¶Šå¤§å¯ä»¥çœ‹åˆ°è¶Šè¯¦ç»†"})]}),e.jsxs("div",{className:"range-control",children:[e.jsx("input",{type:"range",min:"15",max:"22",step:"1",value:z.maxZoom,onChange:t=>Q(s=>({...s,maxZoom:Number(t.target.value)}))}),e.jsx("span",{className:"range-value",children:z.maxZoom})]})]})]})]}),$==="performance"&&e.jsxs("div",{className:"settings-page",children:[e.jsx("h2",{children:"ðŸš€ æ€§èƒ½ä¼˜åŒ–"}),e.jsx("p",{className:"page-desc",children:"è°ƒæ•´æ€§èƒ½å‚æ•°ä»¥èŽ·å¾—æ›´æµç•…çš„ä½“éªŒ"}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"æ¸²æŸ“è®¾ç½®"}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"ç“¦ç‰‡æ·¡å…¥æ—¶é—´"}),e.jsx("span",{children:"åœ°å›¾ç“¦ç‰‡åŠ è½½æ—¶çš„æ·¡å…¥åŠ¨ç”»æ—¶é•¿ï¼Œ0ä¸ºç«‹å³æ˜¾ç¤º"})]}),e.jsxs("div",{className:"range-control wide",children:[e.jsx("input",{type:"range",min:"0",max:"500",step:"50",value:z.fadeDuration,onChange:t=>Q(s=>({...s,fadeDuration:Number(t.target.value)}))}),e.jsxs("span",{className:"range-value",children:[z.fadeDuration,"ms"]})]})]})]}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"ç¼“å­˜è®¾ç½®"}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"ç“¦ç‰‡ç¼“å­˜æ•°é‡"}),e.jsx("span",{children:"å†…å­˜ä¸­ç¼“å­˜çš„åœ°å›¾ç“¦ç‰‡æ•°é‡ï¼Œè¶Šå¤§è¶Šæµç•…ä½†å ç”¨æ›´å¤šå†…å­˜"})]}),e.jsxs("div",{className:"range-control wide",children:[e.jsx("input",{type:"range",min:"1000",max:"6000",step:"500",value:z.maxTileCacheSize,onChange:t=>Q(s=>({...s,maxTileCacheSize:Number(t.target.value)}))}),e.jsx("span",{className:"range-value",children:z.maxTileCacheSize})]})]})]}),e.jsxs("div",{className:"setting-tip",children:[e.jsx("span",{children:"ðŸ’¡"}),e.jsx("p",{children:"æ€§èƒ½è®¾ç½®ä¿®æ”¹åŽéœ€è¦é‡å¯åº”ç”¨æ‰èƒ½ç”Ÿæ•ˆã€‚å¦‚æžœåœ°å›¾å¡é¡¿ï¼Œå¯ä»¥å°è¯•é™ä½Žç“¦ç‰‡ç¼“å­˜æ•°é‡ã€‚"})]})]}),$==="storage"&&e.jsxs("div",{className:"settings-page",children:[e.jsx("h2",{children:"ðŸ’¾ å­˜å‚¨ç®¡ç†"}),e.jsx("p",{className:"page-desc",children:"æŸ¥çœ‹å’Œç®¡ç†åº”ç”¨æ•°æ®"}),e.jsxs("div",{className:"storage-cards",children:[e.jsxs("div",{className:"storage-card",children:[e.jsx("div",{className:"storage-icon",children:"ðŸ“"}),e.jsx("div",{className:"storage-value",children:i.length}),e.jsx("div",{className:"storage-label",children:"æ ‡è®°ç‚¹"})]}),e.jsxs("div",{className:"storage-card",children:[e.jsx("div",{className:"storage-icon",children:"ðŸ“·"}),e.jsx("div",{className:"storage-value",children:Mt}),e.jsx("div",{className:"storage-label",children:"ç…§ç‰‡"})]}),e.jsxs("div",{className:"storage-card",children:[e.jsx("div",{className:"storage-icon",children:"ðŸ—ºï¸"}),e.jsx("div",{className:"storage-value",children:re.count}),e.jsx("div",{className:"storage-label",children:"ç¼“å­˜ç“¦ç‰‡"})]}),e.jsxs("div",{className:"storage-card",children:[e.jsx("div",{className:"storage-icon",children:"ðŸ“¦"}),e.jsx("div",{className:"storage-value",children:(re.size/1024/1024).toFixed(1)}),e.jsx("div",{className:"storage-label",children:"MB ç¼“å­˜"})]})]}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"æ•°æ®æ“ä½œ"}),e.jsxs("div",{className:"action-buttons",children:[e.jsxs("button",{className:"action-btn",onClick:async()=>{if(window.confirm("ç¡®å®šæ¸…é™¤æ‰€æœ‰ç“¦ç‰‡ç¼“å­˜ï¼Ÿè¿™ä¸ä¼šå½±å“ä½ çš„æ ‡è®°å’Œç…§ç‰‡ã€‚")){await window.electronAPI?.clearTileCache();const t=await window.electronAPI?.getCacheStats();t&&X(t)}},children:[e.jsx("span",{children:"ðŸ§¹"}),e.jsxs("div",{children:[e.jsx("strong",{children:"æ¸…é™¤ç“¦ç‰‡ç¼“å­˜"}),e.jsx("small",{children:"é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼Œä¸å½±å“æ ‡è®°æ•°æ®"})]})]}),e.jsxs("button",{className:"action-btn danger",onClick:async()=>{if(window.confirm("âš ï¸ ç¡®å®šåˆ é™¤æ‰€æœ‰æ ‡è®°å’Œç…§ç‰‡ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")){for(const t of i)await window.electronAPI?.deleteMarker(t.id);h([])}},children:[e.jsx("span",{children:"ðŸ—‘ï¸"}),e.jsxs("div",{children:[e.jsx("strong",{children:"æ¸…é™¤æ‰€æœ‰æ•°æ®"}),e.jsx("small",{children:"åˆ é™¤æ‰€æœ‰æ ‡è®°å’Œç…§ç‰‡ï¼Œä¸å¯æ¢å¤"})]})]})]})]})]}),$==="about"&&e.jsxs("div",{className:"settings-page about-page",children:[e.jsxs("div",{className:"about-header",children:[e.jsx("div",{className:"about-icon",children:"ðŸ“"}),e.jsx("h1",{children:"åœ°å›¾ç›¸å†Œ"}),e.jsx("p",{className:"version",children:"ç‰ˆæœ¬ 1.0.0"})]}),e.jsx("p",{className:"about-desc",children:"åœ¨åœ°å›¾ä¸Šè®°å½•ä½ çš„æ—…è¡Œå›žå¿†ï¼Œç”¨ç…§ç‰‡æ ‡è®°æ¯ä¸€ä¸ªå€¼å¾—çºªå¿µçš„åœ°ç‚¹ã€‚"}),e.jsxs("div",{className:"about-features",children:[e.jsxs("div",{className:"feature",children:[e.jsx("span",{children:"ðŸ—ºï¸"}),e.jsxs("div",{children:[e.jsx("strong",{children:"äº¤äº’å¼åœ°å›¾"}),e.jsx("small",{children:"åŸºäºŽ Mapbox GL çš„æµç•…åœ°å›¾ä½“éªŒ"})]})]}),e.jsxs("div",{className:"feature",children:[e.jsx("span",{children:"ðŸ“·"}),e.jsxs("div",{children:[e.jsx("strong",{children:"ç…§ç‰‡ç®¡ç†"}),e.jsx("small",{children:"ä¸ºæ¯ä¸ªåœ°ç‚¹æ·»åŠ å¤šå¼ ç…§ç‰‡å’Œå¤‡æ³¨"})]})]}),e.jsxs("div",{className:"feature",children:[e.jsx("span",{children:"ðŸ”"}),e.jsxs("div",{children:[e.jsx("strong",{children:"æ™ºèƒ½æœç´¢"}),e.jsx("small",{children:"å¿«é€Ÿæœç´¢å…¨çƒä»»æ„åœ°ç‚¹"})]})]}),e.jsxs("div",{className:"feature",children:[e.jsx("span",{children:"ðŸ’¾"}),e.jsxs("div",{children:[e.jsx("strong",{children:"æœ¬åœ°å­˜å‚¨"}),e.jsx("small",{children:"æ•°æ®å®‰å…¨å­˜å‚¨åœ¨æœ¬åœ°"})]})]})]}),e.jsxs("div",{className:"dev-tools-section",children:[e.jsx("h3",{children:"ðŸ› ï¸ å¼€å‘è€…å·¥å…·"}),e.jsxs("div",{className:"dev-tools-btns",children:[e.jsxs("button",{onClick:()=>window.electronAPI?.openDevTools(),children:[e.jsx("span",{children:"ðŸ”§"})," æ‰“å¼€æŽ§åˆ¶å°"]}),e.jsxs("button",{onClick:()=>window.electronAPI?.openLogFolder(),children:[e.jsx("span",{children:"ðŸ“"})," æ‰“å¼€æ—¥å¿—ç›®å½•"]})]})]}),e.jsx("div",{className:"about-footer",children:e.jsx("p",{children:"ä½¿ç”¨ Electron + React + Mapbox GL æž„å»º"})})]}),($==="map"||$==="performance")&&e.jsxs("div",{className:"settings-footer",children:[e.jsx("button",{className:"save-btn",disabled:JSON.stringify(z)===JSON.stringify(E),onClick:()=>{nt(z),localStorage.setItem("mapSettings",JSON.stringify(z)),ne(!1)},children:"ä¿å­˜è®¾ç½®"}),e.jsx("p",{className:"save-hint",children:JSON.stringify(z)!==JSON.stringify(E)?"* è®¾ç½®å·²æ›´æ”¹ï¼Œç‚¹å‡»ä¿å­˜ç”Ÿæ•ˆ":"éƒ¨åˆ†è®¾ç½®éœ€è¦é‡å¯åº”ç”¨åŽç”Ÿæ•ˆ"})]})]})]})}),m&&e.jsxs("div",{className:`context-menu ${Ke?"drag-over":""}`,style:{left:Math.min(m.x,window.innerWidth-280),top:Math.min(m.y,window.innerHeight-200)},onDragEnter:t=>{t.preventDefault(),t.stopPropagation(),Te(!0)},onDragOver:t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy",Te(!0)},onDragLeave:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.contains(t.relatedTarget)||Te(!1)},onDrop:async t=>{t.preventDefault(),t.stopPropagation(),Te(!1);const s=Array.from(t.dataTransfer.files).filter(w=>w.type.startsWith("image/"));if(s.length===0)return;const u=(await Promise.all(s.map(w=>new Promise(I=>{const N=new FileReader;N.onload=async P=>{if(window.electronAPI){const V=await window.electronAPI.savePhotoFromBase64(P.target.result);I(V?{id:V.id,note:""}:null)}else I({data:P.target.result,note:""})},N.readAsDataURL(w)})))).filter(w=>w);if(u.length===0)return;const o=await St(m.latlng.lat,m.latlng.lng),j={id:Lt(),lat:m.latlng.lat,lng:m.latlng.lng,name:o,photos:u,createdAt:Date.now()};window.electronAPI&&await window.electronAPI.addMarker(j),Ee(w=>new Set(w).add(j.id)),setTimeout(()=>Ee(w=>{const I=new Set(w);return I.delete(j.id),I}),600),ce(),M(null),v(null)},children:[e.jsx("button",{className:"menu-close",onClick:At,children:"âœ•"}),e.jsxs("div",{className:"context-menu-header",children:[e.jsxs("div",{className:"place-name",children:["ðŸ“ ",R]}),e.jsxs("div",{className:"coords",children:["ðŸŒ ",m.latlng.lat.toFixed(3),"Â°, ",m.latlng.lng.toFixed(3),"Â°"]})]}),e.jsx("div",{className:"menu-actions",children:e.jsxs("div",{className:`add-photo-zone ${Ke?"drag-active":""}`,onClick:()=>Yt(m.latlng),children:[e.jsx("span",{className:"zone-icon",children:Ke?"ðŸ“¥":"ðŸ“·"}),e.jsx("span",{className:"zone-text",children:"ç‚¹å‡»é€‰æ‹©ç…§ç‰‡"}),e.jsx("span",{className:"zone-hint",children:"æˆ–æ‹–æ‹½ç…§ç‰‡åˆ°è¿™é‡Œ"})]})})]}),g&&e.jsxs("div",{className:`context-menu ${Ye?"drag-over":""}`,style:{left:Math.min(g.x,window.innerWidth-280),top:Math.min(g.y,window.innerHeight-320)},onDragEnter:t=>{t.preventDefault(),t.stopPropagation(),Le(!0)},onDragOver:t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy",Le(!0)},onDragLeave:t=>{t.preventDefault(),t.stopPropagation(),t.currentTarget.contains(t.relatedTarget)||Le(!1)},onDrop:async t=>{t.preventDefault(),t.stopPropagation(),Le(!1);const s=Array.from(t.dataTransfer.files).filter(j=>j.type.startsWith("image/"));if(s.length===0)return;const u=(await Promise.all(s.map(j=>new Promise(w=>{const I=new FileReader;I.onload=async N=>{if(window.electronAPI){const P=await window.electronAPI.savePhotoFromBase64(N.target.result);w(P?{id:P.id,note:""}:null)}else w({data:N.target.result,note:""})},I.readAsDataURL(j)})))).filter(j=>j);if(u.length===0)return;const o=g;if(window.electronAPI){await window.electronAPI.addPhotosToMarker(o.marker.id,u);const j=await window.electronAPI.getMarkerDetail(o.marker.id);j&&y({...o,marker:j}),ce()}},children:[e.jsx("button",{className:"menu-close",onClick:()=>y(null),children:"âœ•"}),e.jsxs("div",{className:"context-menu-header",children:[e.jsxs("div",{className:"place-name",children:["ðŸ“ ",g.marker.name||`${g.marker.lat.toFixed(3)}Â°, ${g.marker.lng.toFixed(3)}Â°`]}),e.jsxs("div",{className:"meta-row",children:[e.jsxs("span",{className:"coords",children:[g.marker.lat.toFixed(3),"Â°, ",g.marker.lng.toFixed(3),"Â°"]}),e.jsxs("span",{className:"photo-count",children:["ðŸ“· ",g.marker.photos?.length||0," å¼ "]})]})]}),e.jsxs("div",{className:"menu-actions",children:[e.jsxs("div",{className:"menu-actions-primary",children:[g.marker.photos?.length>0&&e.jsxs("button",{className:"menu-btn primary view",onClick:()=>{B({photos:g.marker.photos,index:0,markerId:g.marker.id,returnToMenu:g}),y(null)},children:[e.jsx("span",{className:"btn-icon",children:"ðŸ–¼ï¸"}),e.jsx("span",{children:"æŸ¥çœ‹ç…§ç‰‡"})]}),e.jsxs("button",{className:`menu-btn primary add ${Ye?"drag-active":""}`,onClick:async()=>{if(!window.electronAPI)return;const t=g,s=await window.electronAPI.selectPhotos();if(s?.length>0){await window.electronAPI.addPhotosToMarker(t.marker.id,s.map(u=>({id:u.id,note:""})));const n=await window.electronAPI.getMarkerDetail(t.marker.id);n&&y({...t,marker:n}),ce()}},children:[e.jsx("span",{className:"btn-icon",children:Ye?"ðŸ“¥":"âž•"}),e.jsx("span",{children:"æ·»åŠ ç…§ç‰‡"})]})]}),g.marker.photos?.length>0&&e.jsxs("button",{className:"menu-btn note",onClick:()=>{D({markerId:g.marker.id,marker:g.marker,returnToMenu:g}),y(null)},children:[e.jsx("span",{className:"btn-icon",children:"ðŸ“"}),e.jsx("span",{children:"å¤‡æ³¨"})]}),e.jsxs("button",{className:"menu-btn danger",onClick:()=>{Gt(g.marker.id),y(null)},children:[e.jsx("span",{className:"btn-icon",children:"ðŸ—‘ï¸"}),e.jsx("span",{children:"åˆ é™¤æ ‡è®°"})]})]})]}),(m||g)&&e.jsx("div",{className:"context-overlay",onClick:At}),T&&e.jsx(Is,{photoViewer:T,setPhotoViewer:B,currentPhotoUrl:He,getPhotoNote:ot,markers:i,setMarkerMenu:y,refreshMarkers:ce,setPhotoEditor:tt}),f&&e.jsx("div",{className:"note-editor-overlay",onClick:()=>{if(f.returnToViewer)B(f.returnToViewer);else if(f.returnToMenu){const t=i.find(s=>s.id===f.markerId);t&&y({...f.returnToMenu,marker:t})}S(null)},children:e.jsxs("div",{className:"note-editor",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{children:"ðŸ“ ç¼–è¾‘å¤‡æ³¨"}),e.jsx("textarea",{value:f.note,onChange:t=>S({...f,note:t.target.value}),placeholder:"è¾“å…¥ç…§ç‰‡å¤‡æ³¨...",autoFocus:!0}),e.jsxs("div",{className:"note-editor-btns",children:[e.jsx("button",{onClick:()=>{if(f.returnToViewer)B(f.returnToViewer);else if(f.returnToMenu){const t=i.find(s=>s.id===f.markerId);t&&y({...f.returnToMenu,marker:t})}S(null)},children:"å–æ¶ˆ"}),e.jsx("button",{className:"save",onClick:()=>{Xt(f.markerId,f.photoIndex,f.note);const t=i.find(s=>s.id===f.markerId);if(t){const s=[...t.photos];if(typeof s[f.photoIndex]=="string"?s[f.photoIndex]={data:s[f.photoIndex],note:f.note}:s[f.photoIndex]={...s[f.photoIndex],note:f.note},f.returnToViewer)B({...f.returnToViewer,photos:s});else if(f.returnToMenu){const n={...t,photos:s};y({...f.returnToMenu,marker:n})}}},children:"ä¿å­˜"})]})]})}),b&&e.jsx("div",{className:"notes-panel-overlay",onClick:async()=>{if(!L){if(b.returnToMenu)if(window.electronAPI?.getMarkerDetail){const t=await window.electronAPI.getMarkerDetail(b.markerId);t&&y({...b.returnToMenu,marker:t})}else{const t=i.find(s=>s.id===b.markerId);t&&y({...b.returnToMenu,marker:t})}D(null)}},children:e.jsxs("div",{className:"notes-panel",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"notes-panel-header",children:[e.jsx("h3",{children:"ðŸ“ ç…§ç‰‡å¤‡æ³¨"}),e.jsxs("div",{className:"header-actions",children:[L?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cancel-btn",onClick:()=>{U(!1),_([])},children:"å–æ¶ˆ"}),e.jsx("button",{className:"save-btn",onClick:async()=>{if(window.electronAPI?.batchUpdatePhotoNotes)await window.electronAPI.batchUpdatePhotoNotes(b.markerId,Y);else if(window.electronAPI)for(let t=0;t<Y.length;t++)await window.electronAPI.updatePhotoNote(b.markerId,t,Y[t]||"");if(U(!1),_([]),q("success","å¤‡æ³¨å·²ä¿å­˜"),window.electronAPI){const t=await window.electronAPI.getMarkerDetail(b.markerId);t&&D(s=>({...s,marker:t}))}},children:"ðŸ’¾ ä¿å­˜"})]}):e.jsx("button",{className:"edit-btn",onClick:()=>{const t=i.find(s=>s.id===b.markerId)?.photos||[];_(t.map(s=>ot(s))),U(!0)},children:"âœï¸ ç¼–è¾‘"}),e.jsx("button",{className:"panel-close",onClick:async()=>{if(b.returnToMenu)if(window.electronAPI?.getMarkerDetail){const t=await window.electronAPI.getMarkerDetail(b.markerId);t&&y({...b.returnToMenu,marker:t})}else{const t=i.find(s=>s.id===b.markerId);t&&y({...b.returnToMenu,marker:t})}U(!1),_([]),D(null)},children:"âœ•"})]})]}),e.jsx("div",{className:"notes-list",children:(i.find(t=>t.id===b.markerId)?.photos||[]).map((t,s)=>e.jsxs("div",{className:"note-item",children:[e.jsx(ht,{photo:t,className:"note-thumb",alt:`ç…§ç‰‡${s+1}`}),e.jsxs("div",{className:"note-content",children:[e.jsxs("div",{className:"note-label",children:["ç…§ç‰‡ ",s+1]}),L?e.jsx("textarea",{value:Y[s]||"",onChange:n=>{const u=[...Y];u[s]=n.target.value,_(u)},placeholder:"è¾“å…¥å¤‡æ³¨..."}):e.jsx("div",{className:"note-text",children:ot(t)||"æš‚æ— å¤‡æ³¨"})]})]},s))})]})}),$e&&e.jsx(Ps,{photoEditor:$e,setPhotoEditor:tt,setPhotoViewer:B,cropPhoto:ns,refreshMarkers:ce}),ke&&e.jsxs("div",{className:`feedback-toast ${ke.type}`,children:[e.jsx("span",{className:"toast-icon",children:ke.type==="success"?"âœ“":ke.type==="error"?"âœ•":"â„¹"}),ke.message]}),e.jsx(Ss,{})]}):e.jsxs("div",{className:`login-page ${l?"exiting":""}`,onMouseMove:t=>{const s=(t.clientX/window.innerWidth-.5)*30,n=(t.clientY/window.innerHeight-.5)*30;document.documentElement.style.setProperty("--mouse-x",`${s}px`),document.documentElement.style.setProperty("--mouse-y",`${n}px`)},children:[e.jsxs("div",{className:"login-bg",children:[e.jsx("div",{className:"login-circle c1"}),e.jsx("div",{className:"login-circle c2"}),e.jsx("div",{className:"login-circle c3"})]}),e.jsxs("div",{className:"login-card",children:[e.jsx("div",{className:"login-icon",children:"ðŸ“"}),e.jsx("h1",{children:"åœ°å›¾ç›¸å†Œ"}),e.jsx("p",{children:"åœ¨åœ°å›¾ä¸Šè®°å½•ä½ çš„æ—…è¡Œå›žå¿†"}),e.jsxs("div",{className:"login-progress-wrap",children:[e.jsx("div",{className:"login-progress",children:e.jsx("div",{className:"login-progress-bar",style:{width:`${K}%`}})}),e.jsx("span",{className:"login-progress-text",children:K<100?`å®šä½ä¸­ ${Math.round(K)}%`:"å®šä½å®Œæˆ"})]}),e.jsx("button",{className:"login-btn",onClick:Qt,disabled:l||K<100,children:l?"è¿›å…¥ä¸­...":"å¼€å§‹æŽ¢ç´¢"}),e.jsxs("div",{className:"login-footer",children:[e.jsx("span",{children:"ðŸŒ"})," æŽ¢ç´¢ä¸–ç•Œï¼Œè®°å½•ç¾Žå¥½"]})]})]})}function Rs(){const[c,r]=a.useState(""),[l,p]=a.useState(!1);a.useEffect(()=>{const d=navigator.userAgent;d.includes("Windows")?r("windows"):d.includes("Mac")?r("mac"):d.includes("Linux")?r("linux"):r("windows")},[]);const i={windows:{name:"Windows ç‰ˆæœ¬",icon:"ðŸªŸ",file:"photo-map-setup-1.0.0.exe",size:"~85 MB"},mac:{name:"macOS ç‰ˆæœ¬",icon:"ðŸŽ",file:"photo-map-1.0.0.dmg",size:"~90 MB"},linux:{name:"Linux ç‰ˆæœ¬",icon:"ðŸ§",file:"photo-map-1.0.0.AppImage",size:"~88 MB"}},h=i[c],x=Object.entries(i).filter(([d])=>d!==c);return e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"download-float-btn",onClick:()=>p(!0),title:"ä¸‹è½½æ¡Œé¢ç‰ˆåº”ç”¨",children:"ðŸ“± ä¸‹è½½åº”ç”¨"}),l&&e.jsx("div",{className:"download-modal-overlay",onClick:()=>p(!1),children:e.jsxs("div",{className:"download-modal",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"download-header",children:[e.jsx("h2",{children:"ä¸‹è½½æ¡Œé¢ç‰ˆåº”ç”¨"}),e.jsx("button",{className:"download-close",onClick:()=>p(!1),children:"Ã—"})]}),e.jsxs("div",{className:"download-content",children:[e.jsxs("div",{className:"download-benefits",children:[e.jsx("h3",{children:"æ¡Œé¢ç‰ˆä¼˜åŠ¿"}),e.jsxs("ul",{children:[e.jsx("li",{children:"âœ… æ›´å¿«çš„æ€§èƒ½å’Œå“åº”é€Ÿåº¦"}),e.jsx("li",{children:"âœ… æœ¬åœ°å­˜å‚¨ï¼Œæ•°æ®æ›´å®‰å…¨"}),e.jsx("li",{children:"âœ… ç¦»çº¿ä½¿ç”¨ï¼Œæ— éœ€ç½‘ç»œ"}),e.jsx("li",{children:"âœ… æ›´å¤§çš„å­˜å‚¨ç©ºé—´"}),e.jsx("li",{children:"âœ… æ›´å¥½çš„å›¾ç‰‡å¤„ç†èƒ½åŠ›"}),e.jsx("li",{children:"âœ… ç³»ç»Ÿé›†æˆï¼ˆæ–‡ä»¶å…³è”ç­‰ï¼‰"})]})]}),e.jsxs("div",{className:"download-primary",children:[e.jsx("h3",{children:"æŽ¨èä¸‹è½½"}),e.jsxs("div",{className:"download-card primary",children:[e.jsxs("div",{className:"download-info",children:[e.jsx("span",{className:"download-icon",children:h.icon}),e.jsxs("div",{children:[e.jsx("div",{className:"download-name",children:h.name}),e.jsx("div",{className:"download-size",children:h.size})]})]}),e.jsx("a",{href:`/downloads/${h.file}`,className:"download-btn primary",download:!0,children:"ç«‹å³ä¸‹è½½"})]})]}),e.jsxs("div",{className:"download-others",children:[e.jsx("h3",{children:"å…¶ä»–ç‰ˆæœ¬"}),x.map(([d,m])=>e.jsxs("div",{className:"download-card",children:[e.jsxs("div",{className:"download-info",children:[e.jsx("span",{className:"download-icon",children:m.icon}),e.jsxs("div",{children:[e.jsx("div",{className:"download-name",children:m.name}),e.jsx("div",{className:"download-size",children:m.size})]})]}),e.jsx("a",{href:`/downloads/${m.file}`,className:"download-btn",download:!0,children:"ä¸‹è½½"})]},d))]}),e.jsxs("div",{className:"download-requirements",children:[e.jsx("h3",{children:"ç³»ç»Ÿè¦æ±‚"}),e.jsxs("div",{className:"requirements-grid",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Windows:"})," Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"macOS:"})," macOS 10.15 æˆ–æ›´é«˜ç‰ˆæœ¬"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Linux:"})," Ubuntu 18.04+ æˆ–åŒç­‰ç‰ˆæœ¬"]})]})]}),e.jsx("div",{className:"download-github",children:e.jsxs("p",{children:["å¼€æºé¡¹ç›®ï¼ŒæŸ¥çœ‹æºä»£ç ï¼š",e.jsx("a",{href:"https://github.com/ä½ çš„ç”¨æˆ·å/photo-map",target:"_blank",rel:"noopener noreferrer",children:"GitHub ä»“åº“"})]})})]})]})})]})}class Ts{constructor(){this.isWeb=!0,this.isElectron=!1}async selectPhotos(){return new Promise(r=>{const l=document.createElement("input");l.type="file",l.multiple=!0,l.accept="image/*",l.onchange=async p=>{const i=Array.from(p.target.files),h=[];for(const x of i){const d=crypto.randomUUID()+"."+x.name.split(".").pop(),m=new FileReader,M=await new Promise(g=>{m.onload=()=>g(m.result),m.readAsDataURL(x)});h.push({id:d,data:M,name:x.name,size:x.size})}r(h)},l.click()})}async getPhotoUrl(r){return(await this.getStoredPhoto(r))?.data||null}async getThumbnailUrl(r){const l=await this.getStoredPhoto(r);return l?.data?this.generateThumbnail(l.data):null}async generateThumbnail(r,l=200){return new Promise(p=>{const i=new Image;i.onload=()=>{const h=document.createElement("canvas"),x=h.getContext("2d"),d=Math.min(l/i.width,l/i.height);h.width=i.width*d,h.height=i.height*d,x.drawImage(i,0,0,h.width,h.height),p(h.toDataURL("image/webp",.8))},i.src=r})}async storePhoto(r){return new Promise((l,p)=>{const i=indexedDB.open("PhotoMapDB",1);i.onerror=()=>p(i.error),i.onsuccess=()=>{const x=i.result.transaction(["photos"],"readwrite");x.objectStore("photos").put(r),x.oncomplete=()=>l(!0),x.onerror=()=>p(x.error)},i.onupgradeneeded=()=>{const h=i.result;h.objectStoreNames.contains("photos")||h.createObjectStore("photos",{keyPath:"id"})}})}async getStoredPhoto(r){return new Promise((l,p)=>{const i=indexedDB.open("PhotoMapDB",1);i.onerror=()=>p(i.error),i.onsuccess=()=>{const m=i.result.transaction(["photos"],"readonly").objectStore("photos").get(r);m.onsuccess=()=>l(m.result),m.onerror=()=>p(m.error)}})}async loadMarkers(){try{const r=localStorage.getItem("photo-map-markers");return r?JSON.parse(r):[]}catch{return[]}}async saveMarkers(r){try{return localStorage.setItem("photo-map-markers",JSON.stringify(r)),!0}catch{return!1}}async rotatePhoto({photoId:r,degrees:l}){const p=await this.getStoredPhoto(r);if(!p?.data)return!1;const i=await this.rotateImageData(p.data,l);return p.data=i,await this.storePhoto(p),!0}async cropPhoto({photoId:r,crop:l}){const p=await this.getStoredPhoto(r);if(!p?.data)return!1;const i=await this.cropImageData(p.data,l);return p.data=i,await this.storePhoto(p),!0}async rotateImageData(r,l){return new Promise(p=>{const i=new Image;i.onload=()=>{const h=document.createElement("canvas"),x=h.getContext("2d");l===90||l===270?(h.width=i.height,h.height=i.width):(h.width=i.width,h.height=i.height),x.translate(h.width/2,h.height/2),x.rotate(l*Math.PI/180),x.drawImage(i,-i.width/2,-i.height/2),p(h.toDataURL("image/jpeg",.92))},i.src=r})}async cropImageData(r,l){return new Promise(p=>{const i=new Image;i.onload=()=>{const h=document.createElement("canvas"),x=h.getContext("2d");h.width=l.width,h.height=l.height,x.drawImage(i,l.x,l.y,l.width,l.height,0,0,l.width,l.height),p(h.toDataURL("image/jpeg",.92))},i.src=r})}async log({level:r,message:l}){console[r]("[PhotoMap]",l)}async getCacheStats(){return{count:0,size:0,path:"IndexedDB"}}}typeof window<"u"&&(window.electronAPI=new Ts);function Ls(){return e.jsxs("div",{className:"web-app",children:[e.jsx(As,{}),e.jsx(Rs,{}),e.jsx("div",{className:"web-notice",children:e.jsxs("div",{className:"web-notice-content",children:[e.jsx("span",{children:"ðŸŒ è¿™æ˜¯ Web ä½“éªŒç‰ˆ"}),e.jsx("span",{children:"ä¸‹è½½æ¡Œé¢ç‰ˆèŽ·å¾—å®Œæ•´åŠŸèƒ½"})]})})]})}ws.createRoot(document.getElementById("root")).render(e.jsx(ps.StrictMode,{children:e.jsx(Ls,{})}));export{e as j};
