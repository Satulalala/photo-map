const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/js/SettingsPanel-hZ22DIAV.js","assets/js/utils-vendor-BVqnKQB6.js","assets/js/react-vendor-DDxydHEc.js","assets/js/virtual-scroll-DDeySHGB.js"])))=>i.map(i=>d[i]);
var bs=Object.defineProperty;var ks=(d,t,n)=>t in d?bs(d,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):d[t]=n;var ue=(d,t,n)=>ks(d,typeof t!="symbol"?t+"":t,n);import{r as js,a as Gt,g as Ms}from"./react-vendor-DDxydHEc.js";import{r as i,R as Vt,v as Ot}from"./utils-vendor-BVqnKQB6.js";import{F as Ns}from"./virtual-scroll-DDeySHGB.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const u of o)if(u.type==="childList")for(const c of u.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const u={};return o.integrity&&(u.integrity=o.integrity),o.referrerPolicy&&(u.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?u.credentials="include":o.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function a(o){if(o.ep)return;o.ep=!0;const u=n(o);fetch(o.href,u)}})();var gt={exports:{}},De={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ut;function Ss(){if(Ut)return De;Ut=1;var d=js(),t=Symbol.for("react.element"),n=Symbol.for("react.fragment"),a=Object.prototype.hasOwnProperty,o=d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,u={key:!0,ref:!0,__self:!0,__source:!0};function c(m,f,k){var y,N={},x=null,g=null;k!==void 0&&(x=""+k),f.key!==void 0&&(x=""+f.key),f.ref!==void 0&&(g=f.ref);for(y in f)a.call(f,y)&&!u.hasOwnProperty(y)&&(N[y]=f[y]);if(m&&m.defaultProps)for(y in f=m.defaultProps,f)N[y]===void 0&&(N[y]=f[y]);return{$$typeof:t,type:m,key:x,ref:g,props:N,_owner:o.current}}return De.Fragment=n,De.jsx=c,De.jsxs=c,De}var Bt;function Cs(){return Bt||(Bt=1,gt.exports=Ss()),gt.exports}var e=Cs(),Ge={},Ft;function Ps(){if(Ft)return Ge;Ft=1;var d=Gt();return Ge.createRoot=d.createRoot,Ge.hydrateRoot=d.hydrateRoot,Ge}var Is=Ps();const Es=Ms(Is),As="modulepreload",Ts=function(d){return"/"+d},qt={},Yt=function(t,n,a){let o=Promise.resolve();if(n&&n.length>0){let c=function(k){return Promise.all(k.map(y=>Promise.resolve(y).then(N=>({status:"fulfilled",value:N}),N=>({status:"rejected",reason:N}))))};document.getElementsByTagName("link");const m=document.querySelector("meta[property=csp-nonce]"),f=m?.nonce||m?.getAttribute("nonce");o=c(n.map(k=>{if(k=Ts(k),k in qt)return;qt[k]=!0;const y=k.endsWith(".css"),N=y?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${k}"]${N}`))return;const x=document.createElement("link");if(x.rel=y?"stylesheet":As,y||(x.as="script"),x.crossOrigin="",x.href=k,f&&x.setAttribute("nonce",f),document.head.appendChild(x),y)return new Promise((g,j)=>{x.addEventListener("load",g),x.addEventListener("error",()=>j(new Error(`Unable to preload CSS for ${k}`)))})}))}function u(c){const m=new Event("vite:preloadError",{cancelable:!0});if(m.payload=c,window.dispatchEvent(m),!m.defaultPrevented)throw c}return o.then(c=>{for(const m of c||[])m.status==="rejected"&&u(m.reason);return t().catch(u)})};class yt{constructor(t=50,n){ue(this,"maxSize");ue(this,"cache");ue(this,"onEvict");this.maxSize=t,this.cache=new Map,this.onEvict=n}get(t){if(!this.cache.has(t))return null;const n=this.cache.get(t);return this.cache.delete(t),this.cache.set(t,n),n}set(t,n){if(this.cache.has(t)){const a=this.cache.get(t);this.cache.delete(t),a!==n&&this.onEvict&&this.onEvict(t,a)}else if(this.cache.size>=this.maxSize){const a=this.cache.keys().next().value;if(a!==void 0){const o=this.cache.get(a);this.cache.delete(a),this.onEvict&&this.onEvict(a,o)}}this.cache.set(t,n)}has(t){return this.cache.has(t)}delete(t){if(this.cache.has(t)){const n=this.cache.get(t);return this.cache.delete(t),this.onEvict&&this.onEvict(t,n),!0}return!1}clear(){this.onEvict&&this.cache.forEach((t,n)=>{this.onEvict(n,t)}),this.cache.clear()}get size(){return this.cache.size}keys(){return Array.from(this.cache.keys())}}const vt=(d,t)=>{if(t&&t.startsWith("blob:"))try{URL.revokeObjectURL(t)}catch{}},X=new yt(15,vt),ze=new yt(50,vt),Wt=new yt(100,vt),Ht=300*1e3;let Re=null;function Kt(){return{photoUrl:X.size,thumbnail:ze.size,placeholder:Wt.size,total:X.size+ze.size+Wt.size}}function Ls(){Re||(Re=setInterval(()=>{const d=Kt();if(console.log("[å†…å­˜ç®¡ç†] å®šæ—¶æ£€æŸ¥ç¼“å­˜:",d),d.total>100){const t=Math.floor(X.size*.2),n=X.keys();for(let a=0;a<t&&a<n.length;a++)X.delete(n[a]);console.log("[å†…å­˜ç®¡ç†] å·²æ¸…ç†",t,"ä¸ªåŸå›¾ç¼“å­˜")}},Ht),console.log("[å†…å­˜ç®¡ç†] å®šæ—¶æ¸…ç†ä»»åŠ¡å·²å¯åŠ¨ï¼Œé—´éš”:",Ht/1e3,"ç§’"))}function Ds(){Re&&(clearInterval(Re),Re=null,console.log("[å†…å­˜ç®¡ç†] å®šæ—¶æ¸…ç†ä»»åŠ¡å·²åœæ­¢"))}function Rs(){if(typeof performance<"u"&&performance.memory){const d=performance.memory;return{usedJSHeapSize:d.usedJSHeapSize,totalJSHeapSize:d.totalJSHeapSize,jsHeapSizeLimit:d.jsHeapSizeLimit}}return null}function zs({photoViewer:d,setPhotoViewer:t,currentPhotoUrl:n,getPhotoNote:a,markers:o,setMarkerMenu:u,refreshMarkers:c,setPhotoEditor:m}){const f=i.useRef(null),k=i.useRef(null);i.useEffect(()=>(k.current=n,()=>{if(k.current?.startsWith("blob:"))try{URL.revokeObjectURL(k.current)}catch{}}),[n]);const y=i.useCallback(async()=>{if(d.returnToMenu)if(window.electronAPI?.getMarkerDetail){const g=await window.electronAPI.getMarkerDetail(d.markerId);g&&u({...d.returnToMenu,marker:g})}else{const g=o.find(j=>j.id===d.markerId);g&&u({...d.returnToMenu,marker:g})}t(null)},[d,o,u,t]),N=g=>{t(j=>({...j,index:g}))},x=()=>{const g=d.photos[d.index];m({photoId:g?.id,photoUrl:n,returnToViewer:d}),t(null)};return e.jsxs("div",{className:"photo-viewer",onClick:y,children:[e.jsxs("div",{className:"pv-toolbar",onClick:g=>g.stopPropagation(),children:[e.jsx("button",{className:"pv-btn",onClick:x,title:"ç¼–è¾‘ï¼ˆè£å‰ª/æ—‹è½¬ï¼‰",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"})})}),e.jsx("button",{className:"pv-btn",onClick:()=>{const g=document.createElement("a");g.download=`ç…§ç‰‡_${d.index+1}.jpg`,g.href=n,g.click()},title:"ä¸‹è½½åŸå›¾",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"})})}),d.photos.length>1&&e.jsx("button",{className:"pv-btn pv-btn-danger",onClick:async()=>{if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ"))return;const g=d.photos[d.index];window.electronAPI&&await window.electronAPI.deletePhoto(d.markerId,d.index,g?.id);const j=d.photos.filter((_,q)=>q!==d.index);t({...d,photos:j,index:Math.min(d.index,j.length-1)}),c()},title:"åˆ é™¤",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"})})}),e.jsx("div",{className:"pv-divider"}),e.jsx("button",{className:"pv-btn pv-btn-close",onClick:y,title:"å…³é—­",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})})})]}),e.jsx("div",{className:"photo-main-wrapper",onClick:g=>g.stopPropagation(),children:e.jsx("img",{ref:f,src:n,alt:"",draggable:!1})}),d.photos.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"photo-nav prev",onClick:g=>{g.stopPropagation(),N((d.index-1+d.photos.length)%d.photos.length)},children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"})})}),e.jsx("button",{className:"photo-nav next",onClick:g=>{g.stopPropagation(),N((d.index+1)%d.photos.length)},children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"})})})]}),e.jsxs("div",{className:"photo-bottom-bar",onClick:g=>g.stopPropagation(),children:[d.photos.length>1&&e.jsxs("div",{className:"photo-counter",children:[d.index+1," / ",d.photos.length]}),a(d.photos[d.index])&&e.jsxs("div",{className:"photo-note-bar",children:["ğŸ“ ",a(d.photos[d.index])]})]})]})}function _s({photoEditor:d,setPhotoEditor:t,setPhotoViewer:n,cropPhoto:a,refreshMarkers:o}){const[u,c]=i.useState(0),[m,f]=i.useState(null),[k,y]=i.useState(!1),[N,x]=i.useState(null),[g,j]=i.useState(!1),_=i.useRef(null),q=i.useRef(null),$=i.useRef(null),ne=i.useRef(null);i.useEffect(()=>{d&&(c(0),f(null),ne.current=d.photoUrl)},[d?.photoUrl]),i.useEffect(()=>()=>{if(ne.current?.startsWith("blob:"))try{URL.revokeObjectURL(ne.current)}catch{}},[]);const ke=i.useCallback(()=>{d?.returnToViewer&&n(d.returnToViewer),t(null)},[d,n,t]),ae=()=>{const A=q.current;return A?A.getBoundingClientRect():null},re=A=>{if(A.target.closest(".crop-handle"))return;const C=ae();if(!C)return;const T=A.clientX-C.left,b=A.clientY-C.top;m&&T>=m.x&&T<=m.x+m.width&&b>=m.y&&b<=m.y+m.height?(x("move"),$.current={x:T,y:b,cropArea:{...m}}):(x("new"),$.current={x:T,y:b},f(null)),y(!0)},O=(A,C)=>{C.stopPropagation();const T=ae();!T||!m||(x(A),$.current={x:C.clientX-T.left,y:C.clientY-T.top,cropArea:{...m}},y(!0))},xe=A=>{if(!k||!$.current)return;const C=ae();if(!C)return;const T=Math.max(0,Math.min(C.width,A.clientX-C.left)),b=Math.max(0,Math.min(C.height,A.clientY-C.top));if(N==="new"){const{x:R,y:S}=$.current;f({x:Math.min(R,T),y:Math.min(S,b),width:Math.abs(T-R),height:Math.abs(b-S)})}else if(N==="move"){const{x:R,y:S,cropArea:F}=$.current,oe=T-R,J=b-S;f({x:Math.max(0,Math.min(C.width-F.width,F.x+oe)),y:Math.max(0,Math.min(C.height-F.height,F.y+J)),width:F.width,height:F.height})}else{const{cropArea:R}=$.current;let S={...R};N.includes("l")&&(S.width=R.x+R.width-T,S.x=T),N.includes("r")&&(S.width=T-R.x),N.includes("t")&&(S.height=R.y+R.height-b,S.y=b),N.includes("b")&&(S.height=b-R.y),S.width>=20&&S.height>=20&&f(S)}},G=()=>{y(!1),x(null),$.current=null},je=()=>{c(A=>A-90),f(null)},D=()=>{c(A=>A+90),f(null)},H=()=>{c(0),f(null)},_e=()=>(u%360+360)%360,$e=()=>{f(null)},bt=async()=>{if(!_.current)return;j(!0);const C=document.createElement("canvas"),T=C.getContext("2d"),b=new Image;b.crossOrigin="anonymous",b.onload=async()=>{let R=b.naturalWidth,S=b.naturalHeight;const F=_e(),oe=F%180!==0;if(C.width=oe?S:R,C.height=oe?R:S,T.save(),T.translate(C.width/2,C.height/2),T.rotate(F*Math.PI/180),T.drawImage(b,-R/2,-S/2),T.restore(),m&&m.width>10&&m.height>10){const J=q.current;if(J){const V=J.getBoundingClientRect(),Z=C.width/V.width,Me=C.height/V.height,Ne=m.x*Z,Ve=m.y*Me,pe=m.width*Z,Se=m.height*Me,ge=document.createElement("canvas");ge.width=pe,ge.height=Se,ge.getContext("2d").drawImage(C,Ne,Ve,pe,Se,0,0,pe,Se),C.width=pe,C.height=Se,T.drawImage(ge,0,0)}}C.toBlob(J=>{if(!J){j(!1);return}const V=URL.createObjectURL(J),Z=document.createElement("a");Z.download=`edited_${Date.now()}.jpg`,Z.href=V,Z.click(),URL.revokeObjectURL(V),j(!1),ke()},"image/jpeg",.92)},b.onerror=()=>j(!1),b.src=d.photoUrl};if(!d)return null;const me=_e(),we=me!==0||m&&m.width>10&&m.height>10;return e.jsx("div",{className:"photo-editor-overlay",onMouseMove:xe,onMouseUp:G,onMouseLeave:G,children:e.jsxs("div",{className:"photo-editor-modern",children:[e.jsxs("div",{className:"pe-header",children:[e.jsx("button",{className:"pe-btn pe-cancel",onClick:ke,children:"å–æ¶ˆ"}),e.jsx("span",{className:"pe-title",children:"ç¼–è¾‘"}),e.jsx("button",{className:`pe-btn pe-done ${we?"active":""}`,onClick:bt,disabled:!we||g,children:g?"ä¿å­˜ä¸­...":"å®Œæˆ"})]}),e.jsxs("div",{className:"pe-canvas-area",children:[e.jsxs("div",{ref:q,className:"pe-image-container",onMouseDown:re,children:[e.jsx("img",{ref:_,src:d.photoUrl,alt:"ç¼–è¾‘",draggable:!1,style:{transform:`rotate(${u}deg)`}}),m&&m.width>5&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"pe-crop-overlay"}),e.jsxs("div",{className:"pe-crop-box",style:{left:m.x,top:m.y,width:m.width,height:m.height},children:[e.jsxs("div",{className:"pe-grid",children:[e.jsx("div",{className:"pe-grid-h",style:{top:"33.33%"}}),e.jsx("div",{className:"pe-grid-h",style:{top:"66.66%"}}),e.jsx("div",{className:"pe-grid-v",style:{left:"33.33%"}}),e.jsx("div",{className:"pe-grid-v",style:{left:"66.66%"}})]}),e.jsx("div",{className:"crop-handle tl",onMouseDown:A=>O("tl",A)}),e.jsx("div",{className:"crop-handle tr",onMouseDown:A=>O("tr",A)}),e.jsx("div",{className:"crop-handle bl",onMouseDown:A=>O("bl",A)}),e.jsx("div",{className:"crop-handle br",onMouseDown:A=>O("br",A)})]})]})]}),we&&e.jsx("button",{className:"pe-reset-btn",onClick:H,title:"é‡ç½®å…¨éƒ¨",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"})})}),!m&&!we&&e.jsx("div",{className:"pe-hint",children:"æ‹–æ‹½é€‰æ‹©è£å‰ªåŒºåŸŸ"}),we&&e.jsxs("div",{className:"pe-status",children:[me!==0&&e.jsxs("span",{className:"pe-status-item",children:["æ—‹è½¬ ",me,"Â°"]}),m&&m.width>10&&e.jsxs("span",{className:"pe-status-item",children:[Math.round(m.width)," Ã— ",Math.round(m.height)]})]})]}),e.jsxs("div",{className:"pe-toolbar",children:[e.jsx("button",{className:"pe-tool",onClick:je,title:"é€†æ—¶é’ˆæ—‹è½¬",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M7.11 8.53L5.7 7.11C4.8 8.27 4.24 9.61 4.07 11h2.02c.14-.87.49-1.72 1.02-2.47zM6.09 13H4.07c.17 1.39.72 2.73 1.62 3.89l1.41-1.42c-.52-.75-.87-1.59-1.01-2.47zm1.01 5.32c1.16.9 2.51 1.44 3.9 1.61V17.9c-.87-.15-1.71-.49-2.46-1.03L7.1 18.32zM13 4.07V1L8.45 5.55 13 10V6.09c2.84.48 5 2.94 5 5.91s-2.16 5.43-5 5.91v2.02c3.95-.49 7-3.85 7-7.93s-3.05-7.44-7-7.93z"})})}),e.jsx("button",{className:"pe-tool",onClick:D,title:"é¡ºæ—¶é’ˆæ—‹è½¬",children:e.jsx("svg",{viewBox:"0 0 24 24",children:e.jsx("path",{d:"M15.55 5.55L11 1v3.07C7.06 4.56 4 7.92 4 12s3.05 7.44 7 7.93v-2.02c-2.84-.48-5-2.94-5-5.91s2.16-5.43 5-5.91V10l4.55-4.45zM19.93 11c-.17-1.39-.72-2.73-1.62-3.89l-1.42 1.42c.54.75.88 1.6 1.02 2.47h2.02zM13 17.9v2.02c1.39-.17 2.74-.71 3.9-1.61l-1.44-1.44c-.75.54-1.59.89-2.46 1.03zm3.89-2.42l1.42 1.41c.9-1.16 1.45-2.5 1.62-3.89h-2.02c-.14.87-.48 1.72-1.02 2.48z"})})}),m&&e.jsx("button",{className:"pe-tool",onClick:$e,title:"æ¸…é™¤è£å‰ª",children:e.jsxs("svg",{viewBox:"0 0 24 24",children:[e.jsx("path",{d:"M17 15h2V7c0-1.1-.9-2-2-2H9v2h8v8zM7 17V1H5v4H1v2h4v10c0 1.1.9 2 2 2h10v4h2v-4h4v-2H7z"}),e.jsx("path",{d:"M2.5 3.5l18 18",stroke:"currentColor",strokeWidth:"2"})]})})]})]})})}function $s(){const[d,t]=i.useState(!1),[n,a]=i.useState(null),[o,u]=i.useState(null);return i.useEffect(()=>{if(!d)return;const c=()=>{a(Kt()),u(Rs())};c();const m=setInterval(c,2e3);return()=>clearInterval(m)},[d]),null}class Os extends Vt.Component{constructor(n){super(n);ue(this,"reportError",(n,a)=>{const o={message:n.message,stack:n.stack,componentStack:a.componentStack,errorBoundary:this.props.name||"Unknown",url:window.location.href,userAgent:navigator.userAgent,timestamp:new Date().toISOString(),errorId:this.state.errorId,props:this.props.context||{}};window.errorReporting&&window.errorReporting.captureException(n,{tags:{component:"ErrorBoundary",boundary:this.props.name||"Unknown"},extra:o}),window.analytics&&window.analytics.trackError(n,{errorBoundary:this.props.name,componentStack:a.componentStack})});ue(this,"handleRetry",()=>{this.setState({hasError:!1,error:null,errorInfo:null,errorId:null}),window.analytics&&window.analytics.trackEvent("error_boundary_retry",{boundary:this.props.name,errorId:this.state.errorId})});ue(this,"handleReload",()=>{window.analytics&&window.analytics.trackEvent("error_boundary_reload",{boundary:this.props.name,errorId:this.state.errorId}),window.location.reload()});ue(this,"handleReport",()=>{const n={error:this.state.error?.message,stack:this.state.error?.stack,component:this.props.name,url:window.location.href,timestamp:new Date().toISOString()};navigator.clipboard&&navigator.clipboard.writeText(JSON.stringify(n,null,2)).then(()=>{alert("é”™è¯¯ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}).catch(()=>{const a=document.createElement("textarea");a.value=JSON.stringify(n,null,2),document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a),alert("é”™è¯¯ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}),window.analytics&&window.analytics.trackEvent("error_boundary_report",{boundary:this.props.name,errorId:this.state.errorId})});this.state={hasError:!1,error:null,errorInfo:null,errorId:null}}static getDerivedStateFromError(n){return{hasError:!0,errorId:`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}componentDidCatch(n,a){this.setState({error:n,errorInfo:a}),this.reportError(n,a)}render(){return this.state.hasError?this.props.fallback?this.props.fallback(this.state.error,this.state.errorInfo,this.handleRetry):e.jsx("div",{className:"error-boundary",children:e.jsxs("div",{className:"error-boundary-content",children:[e.jsx("div",{className:"error-icon",children:"âš ï¸"}),e.jsx("h2",{className:"error-title",children:this.props.title||"å‡ºç°äº†ä¸€äº›é—®é¢˜"}),e.jsx("p",{className:"error-message",children:this.props.message||"åº”ç”¨é‡åˆ°äº†æ„å¤–é”™è¯¯ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚"}),!1,e.jsxs("div",{className:"error-actions",children:[e.jsx("button",{className:"error-button error-button-primary",onClick:this.handleRetry,children:"ğŸ”„ é‡è¯•"}),e.jsx("button",{className:"error-button error-button-secondary",onClick:this.handleReload,children:"ğŸ”ƒ åˆ·æ–°é¡µé¢"}),!1]}),e.jsxs("div",{className:"error-info",children:[e.jsxs("p",{className:"error-id",children:["é”™è¯¯ID: ",this.state.errorId]}),e.jsxs("p",{className:"error-time",children:["æ—¶é—´: ",new Date().toLocaleString("zh-CN")]})]})]})}):this.props.children}}const Us=({children:d,fallback:t,onError:n})=>{const[a,o]=i.useState(null);if(i.useEffect(()=>{const u=c=>{o(c.reason),n&&n(c.reason,{type:"unhandledRejection"})};return window.addEventListener("unhandledrejection",u),()=>{window.removeEventListener("unhandledrejection",u)}},[n]),a){if(t)return t(a,{type:"async"},()=>o(null));throw a}return d},Bs=({children:d,fallback:t})=>{const[n,a]=i.useState(null),[o,u]=i.useState(navigator.onLine);return i.useEffect(()=>{const c=()=>{u(!0),a(null)},m=()=>{u(!1),a(new Error("ç½‘ç»œè¿æ¥å·²æ–­å¼€"))};return window.addEventListener("online",c),window.addEventListener("offline",m),()=>{window.removeEventListener("online",c),window.removeEventListener("offline",m)}},[]),n&&!o?t?t(n,{type:"network",isOnline:o},()=>{a(null)}):e.jsx("div",{className:"network-error-boundary",children:e.jsxs("div",{className:"network-error-content",children:[e.jsx("div",{className:"network-error-icon",children:"ğŸ“¡"}),e.jsx("h3",{children:"ç½‘ç»œè¿æ¥å·²æ–­å¼€"}),e.jsx("p",{children:"è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥ï¼Œç„¶åé‡è¯•ã€‚"}),e.jsx("button",{onClick:()=>window.location.reload(),className:"error-button error-button-primary",children:"é‡æ–°è¿æ¥"})]})}):d};class Fs{constructor(){this.defaultMeta={title:"åœ°å›¾ç›¸å†Œ - è®°å½•æ¯ä¸€ä¸ªå€¼å¾—çºªå¿µçš„åœ°ç‚¹",description:"ä¸€ä¸ªä¼˜é›…çš„ç…§ç‰‡åœ°å›¾åº”ç”¨ï¼Œå¸®åŠ©æ‚¨åœ¨åœ°å›¾ä¸Šæ ‡è®°å’Œç®¡ç†ç…§ç‰‡ï¼Œè®°å½•æ—…è¡Œè¶³è¿¹ï¼Œåˆ†äº«ç¾å¥½å›å¿†ã€‚æ”¯æŒGPSå®šä½ã€ç…§ç‰‡ç¼–è¾‘ã€çƒ­åŠ›å›¾å±•ç¤ºç­‰åŠŸèƒ½ã€‚",keywords:"åœ°å›¾ç›¸å†Œ,ç…§ç‰‡åœ°å›¾,GPSç…§ç‰‡,æ—…è¡Œè®°å½•,ä½ç½®æ ‡è®°,ç…§ç‰‡ç®¡ç†,åœ°ç†æ ‡è®°,è¶³è¿¹åœ°å›¾",author:"Photo Map Team",viewport:"width=device-width, initial-scale=1.0",robots:"index, follow",language:"zh-CN",charset:"UTF-8"},this.socialMeta={ogType:"website",ogSiteName:"åœ°å›¾ç›¸å†Œ",ogLocale:"zh_CN",twitterCard:"summary_large_image",twitterSite:"@photomap"},this.structuredData={"@context":"https://schema.org","@type":"WebApplication",name:"åœ°å›¾ç›¸å†Œ",description:"ä¸€ä¸ªä¼˜é›…çš„ç…§ç‰‡åœ°å›¾åº”ç”¨ï¼Œå¸®åŠ©æ‚¨åœ¨åœ°å›¾ä¸Šæ ‡è®°å’Œç®¡ç†ç…§ç‰‡",url:window.location.origin,applicationCategory:"PhotographyApplication",operatingSystem:"Web Browser",offers:{"@type":"Offer",price:"0",priceCurrency:"CNY"},author:{"@type":"Organization",name:"Photo Map Team"}},this.init()}init(){this.setBasicMeta(),this.setSocialMeta(),this.setStructuredData(),this.setupDynamicUpdates(),console.log("âœ… SEO Manager initialized")}setBasicMeta(){document.title=this.defaultMeta.title,this.setMetaTag("description",this.defaultMeta.description),this.setMetaTag("keywords",this.defaultMeta.keywords),this.setMetaTag("author",this.defaultMeta.author),this.setMetaTag("viewport",this.defaultMeta.viewport),this.setMetaTag("robots",this.defaultMeta.robots),this.setMetaTag("language",this.defaultMeta.language);let t=document.querySelector("meta[charset]");t||(t=document.createElement("meta"),t.setAttribute("charset",this.defaultMeta.charset),document.head.insertBefore(t,document.head.firstChild)),this.setCanonicalUrl(window.location.href),document.documentElement.lang="zh-CN"}setSocialMeta(){this.setMetaProperty("og:title",this.defaultMeta.title),this.setMetaProperty("og:description",this.defaultMeta.description),this.setMetaProperty("og:type",this.socialMeta.ogType),this.setMetaProperty("og:site_name",this.socialMeta.ogSiteName),this.setMetaProperty("og:locale",this.socialMeta.ogLocale),this.setMetaProperty("og:url",window.location.href);const t=`${window.location.origin}/images/og-image.jpg`;this.setMetaProperty("og:image",t),this.setMetaProperty("og:image:width","1200"),this.setMetaProperty("og:image:height","630"),this.setMetaProperty("og:image:alt","åœ°å›¾ç›¸å†Œåº”ç”¨æˆªå›¾"),this.setMetaName("twitter:card",this.socialMeta.twitterCard),this.setMetaName("twitter:site",this.socialMeta.twitterSite),this.setMetaName("twitter:title",this.defaultMeta.title),this.setMetaName("twitter:description",this.defaultMeta.description),this.setMetaName("twitter:image",t)}setStructuredData(){let t=document.querySelector("#structured-data");t||(t=document.createElement("script"),t.id="structured-data",t.type="application/ld+json",document.head.appendChild(t)),t.textContent=JSON.stringify(this.structuredData,null,2)}setMetaTag(t,n){let a=document.querySelector(`meta[name="${t}"]`);a||(a=document.createElement("meta"),a.setAttribute("name",t),document.head.appendChild(a)),a.setAttribute("content",n)}setMetaProperty(t,n){let a=document.querySelector(`meta[property="${t}"]`);a||(a=document.createElement("meta"),a.setAttribute("property",t),document.head.appendChild(a)),a.setAttribute("content",n)}setMetaName(t,n){let a=document.querySelector(`meta[name="${t}"]`);a||(a=document.createElement("meta"),a.setAttribute("name",t),document.head.appendChild(a)),a.setAttribute("content",n)}setCanonicalUrl(t){let n=document.querySelector('link[rel="canonical"]');n||(n=document.createElement("link"),n.setAttribute("rel","canonical"),document.head.appendChild(n)),n.setAttribute("href",t)}updatePageSEO(t={}){const{title:n,description:a,keywords:o,image:u,url:c=window.location.href,type:m="website"}=t;if(n){const f=`${n} - åœ°å›¾ç›¸å†Œ`;document.title=f,this.setMetaProperty("og:title",f),this.setMetaName("twitter:title",f)}a&&(this.setMetaTag("description",a),this.setMetaProperty("og:description",a),this.setMetaName("twitter:description",a)),o&&this.setMetaTag("keywords",o),u&&(this.setMetaProperty("og:image",u),this.setMetaName("twitter:image",u)),this.setMetaProperty("og:url",c),this.setCanonicalUrl(c),this.setMetaProperty("og:type",m)}setPhotoPageSEO(t){const n=t.note||`ç…§ç‰‡ - ${t.location||"æœªçŸ¥ä½ç½®"}`,a=`åœ¨${t.location||"æŸä¸ªåœ°ç‚¹"}æ‹æ‘„çš„ç…§ç‰‡${t.note?`ï¼š${t.note}`:""}ã€‚ä½¿ç”¨åœ°å›¾ç›¸å†Œè®°å½•æ‚¨çš„ç¾å¥½å›å¿†ã€‚`,o=`${this.defaultMeta.keywords},${t.location||""},${t.note||""}`;this.updatePageSEO({title:n,description:a,keywords:o,image:t.thumbnailUrl||t.url,type:"article"})}setMapPageSEO(t,n){const a=`${t} - åœ°å›¾è§†å›¾`,o=`æŸ¥çœ‹${t}çš„${n}å¼ ç…§ç‰‡ï¼Œæ¢ç´¢è¿™ä¸ªåœ°åŒºçš„ç¾ä¸½é£æ™¯å’Œéš¾å¿˜æ—¶åˆ»ã€‚`,u=`${this.defaultMeta.keywords},${t},åœ°å›¾è§†å›¾`;this.updatePageSEO({title:a,description:o,keywords:u,type:"website"})}generateSitemap(){return`<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
${[{loc:window.location.origin,lastmod:new Date().toISOString().split("T")[0],changefreq:"daily",priority:"1.0"},{loc:`${window.location.origin}/map`,lastmod:new Date().toISOString().split("T")[0],changefreq:"weekly",priority:"0.8"},{loc:`${window.location.origin}/photos`,lastmod:new Date().toISOString().split("T")[0],changefreq:"weekly",priority:"0.8"}].map(a=>`  <url>
    <loc>${a.loc}</loc>
    <lastmod>${a.lastmod}</lastmod>
    <changefreq>${a.changefreq}</changefreq>
    <priority>${a.priority}</priority>
  </url>`).join(`
`)}
</urlset>`}generateRobotsTxt(){return`User-agent: *
Allow: /
Disallow: /api/
Disallow: /admin/
Disallow: /*.json$

Sitemap: ${window.location.origin}/sitemap.xml

# æœç´¢å¼•æ“ä¼˜åŒ–
Crawl-delay: 1`}setupDynamicUpdates(){let t=window.location.href;const n=()=>{window.location.href!==t&&(t=window.location.href,this.setCanonicalUrl(t),this.setMetaProperty("og:url",t))};new MutationObserver(n).observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("popstate",n);const o=history.pushState,u=history.replaceState;history.pushState=function(...c){o.apply(history,c),setTimeout(n,0)},history.replaceState=function(...c){u.apply(history,c),setTimeout(n,0)}}setBreadcrumbData(t){const n={"@context":"https://schema.org","@type":"BreadcrumbList",itemListElement:t.map((o,u)=>({"@type":"ListItem",position:u+1,name:o.name,item:o.url}))};let a=document.querySelector("#breadcrumb-data");a||(a=document.createElement("script"),a.id="breadcrumb-data",a.type="application/ld+json",document.head.appendChild(a)),a.textContent=JSON.stringify(n,null,2)}setImageData(t){const n={"@context":"https://schema.org","@type":"ImageGallery",name:"åœ°å›¾ç›¸å†Œå›¾ç‰‡é›†",description:"ç”¨æˆ·ä¸Šä¼ çš„åœ°ç†ä½ç½®æ ‡è®°ç…§ç‰‡é›†åˆ",image:t.map(o=>({"@type":"ImageObject",url:o.url,name:o.note||"ç…§ç‰‡",description:o.description||"",contentLocation:{"@type":"Place",name:o.location||"æœªçŸ¥ä½ç½®",geo:o.lat&&o.lng?{"@type":"GeoCoordinates",latitude:o.lat,longitude:o.lng}:void 0}}))};let a=document.querySelector("#image-data");a||(a=document.createElement("script"),a.id="image-data",a.type="application/ld+json",document.head.appendChild(a)),a.textContent=JSON.stringify(n,null,2)}getSEOReport(){const t={title:{content:document.title,length:document.title.length,optimal:document.title.length>=30&&document.title.length<=60},description:{content:document.querySelector('meta[name="description"]')?.content||"",length:(document.querySelector('meta[name="description"]')?.content||"").length,optimal:!1},keywords:{content:document.querySelector('meta[name="keywords"]')?.content||"",count:(document.querySelector('meta[name="keywords"]')?.content||"").split(",").length},headings:{h1:document.querySelectorAll("h1").length,h2:document.querySelectorAll("h2").length,h3:document.querySelectorAll("h3").length},images:{total:document.querySelectorAll("img").length,withAlt:document.querySelectorAll("img[alt]").length,withoutAlt:document.querySelectorAll("img:not([alt])").length},links:{internal:document.querySelectorAll('a[href^="/"], a[href^="./"], a[href^="../"]').length,external:document.querySelectorAll('a[href^="http"]:not([href*="'+window.location.hostname+'"])').length},social:{ogTags:document.querySelectorAll('meta[property^="og:"]').length,twitterTags:document.querySelectorAll('meta[name^="twitter:"]').length},structured:{jsonLd:document.querySelectorAll('script[type="application/ld+json"]').length}};return t.description.optimal=t.description.length>=120&&t.description.length<=160,t}trackSEOEvent(t,n={}){window.analytics&&window.analytics.trackEvent(t,{...n,seo:!0,url:window.location.href,title:document.title})}}const ve=new Fs,qs=()=>({updateSEO:c=>ve.updatePageSEO(c),setPhotoSEO:c=>ve.setPhotoPageSEO(c),setMapSEO:(c,m)=>ve.setMapPageSEO(c,m),setBreadcrumbs:c=>ve.setBreadcrumbData(c),setImages:c=>ve.setImageData(c),getReport:()=>ve.getSEOReport()}),ft={};class Ws{constructor(){this.config={ga4:{measurementId:ft?.VITE_GA4_ID||"",enabled:!1},baidu:{siteId:ft?.VITE_BAIDU_ANALYTICS_ID||"",enabled:!1},custom:{endpoint:ft?.VITE_ANALYTICS_ENDPOINT||"/api/analytics",enabled:!0}},this.sessionData={sessionId:this.generateSessionId(),startTime:Date.now(),pageViews:0,events:[],userAgent:navigator.userAgent,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,screenResolution:`${screen.width}x${screen.height}`,viewportSize:`${window.innerWidth}x${window.innerHeight}`},this.queue=[],this.isOnline=navigator.onLine,this.batchSize=10,this.flushInterval=3e4,this.init()}async init(){try{if(!this.hasUserConsent()){console.log("ğŸ“Š Analytics: Waiting for user consent");return}await this.initGA4(),await this.initBaidu(),this.initCustomAnalytics(),this.setupEventListeners(),this.startBatchSending(),this.trackEvent("session_start",{sessionId:this.sessionData.sessionId,...this.getDeviceInfo()}),console.log("âœ… Web Analytics initialized")}catch(t){console.error("âŒ Analytics initialization failed:",t)}}generateSessionId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}hasUserConsent(){return localStorage.getItem("analytics_consent")==="granted"}requestUserConsent(){return new Promise(t=>{const n=document.createElement("div");n.innerHTML=`
        <div style="
          position: fixed;
          bottom: 20px;
          left: 20px;
          right: 20px;
          background: rgba(0, 0, 0, 0.9);
          color: white;
          padding: 20px;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          backdrop-filter: blur(20px);
          border: 1px solid rgba(255, 255, 255, 0.1);
        ">
          <div style="margin-bottom: 16px;">
            <h3 style="margin: 0 0 8px 0; font-size: 16px;">ğŸ“Š æ•°æ®åˆ†æ</h3>
            <p style="margin: 0; font-size: 14px; color: #ccc; line-height: 1.4;">
              æˆ‘ä»¬ä½¿ç”¨åˆ†æå·¥å…·æ¥æ”¹å–„ç”¨æˆ·ä½“éªŒã€‚è¿™äº›æ•°æ®å®Œå…¨åŒ¿åï¼Œä¸ä¼šæ”¶é›†ä¸ªäººä¿¡æ¯ã€‚
            </p>
          </div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button id="analytics-decline" style="
              background: transparent;
              border: 1px solid rgba(255, 255, 255, 0.3);
              color: white;
              padding: 8px 16px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
            ">æ‹’ç»</button>
            <button id="analytics-accept" style="
              background: #4a90e2;
              border: none;
              color: white;
              padding: 8px 16px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
            ">åŒæ„</button>
          </div>
        </div>
      `,document.body.appendChild(n),document.getElementById("analytics-accept").onclick=()=>{localStorage.setItem("analytics_consent","granted"),n.remove(),this.init(),t(!0)},document.getElementById("analytics-decline").onclick=()=>{localStorage.setItem("analytics_consent","denied"),n.remove(),t(!1)}})}async initGA4(){if(!(!this.config.ga4.measurementId||!this.config.ga4.enabled))try{let t=function(){dataLayer.push(arguments)};const n=document.createElement("script");n.async=!0,n.src=`https://www.googletagmanager.com/gtag/js?id=${this.config.ga4.measurementId}`,document.head.appendChild(n),window.dataLayer=window.dataLayer||[],window.gtag=t,t("js",new Date),t("config",this.config.ga4.measurementId,{page_title:document.title,page_location:window.location.href,custom_map:{custom_parameter_1:"session_id"}}),console.log("âœ… Google Analytics 4 initialized")}catch(t){console.error("âŒ GA4 initialization failed:",t)}}async initBaidu(){if(!(!this.config.baidu.siteId||!this.config.baidu.enabled))try{const t=document.createElement("script");t.innerHTML=`
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?${this.config.baidu.siteId}";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
      `,document.head.appendChild(t),console.log("âœ… Baidu Analytics initialized")}catch(t){console.error("âŒ Baidu Analytics initialization failed:",t)}}initCustomAnalytics(){this.config.custom.enabled&&(window.addEventListener("online",()=>{this.isOnline=!0,this.flushQueue()}),window.addEventListener("offline",()=>{this.isOnline=!1}),console.log("âœ… Custom Analytics initialized"))}setupEventListeners(){document.addEventListener("visibilitychange",()=>{document.hidden?this.trackEvent("page_hidden",{timeOnPage:Date.now()-this.sessionData.startTime}):this.trackEvent("page_visible")}),window.addEventListener("beforeunload",()=>{this.trackEvent("session_end",{sessionDuration:Date.now()-this.sessionData.startTime,pageViews:this.sessionData.pageViews,totalEvents:this.sessionData.events.length}),this.flushQueue(!0)}),window.addEventListener("resize",()=>{this.sessionData.viewportSize=`${window.innerWidth}x${window.innerHeight}`}),window.addEventListener("error",t=>{this.trackEvent("javascript_error",{message:t.message,filename:t.filename,lineno:t.lineno,colno:t.colno,stack:t.error?.stack})}),window.addEventListener("unhandledrejection",t=>{this.trackEvent("unhandled_promise_rejection",{reason:t.reason?.toString(),stack:t.reason?.stack})})}trackPageView(t=window.location.pathname,n=document.title){this.sessionData.pageViews++;const a={event:"page_view",page:t,title:n,referrer:document.referrer,timestamp:Date.now(),sessionId:this.sessionData.sessionId,...this.getDeviceInfo()};this.sendToGA4("page_view",a),this.sendToBaidu("_trackPageview",[t]),this.sendToCustom(a),console.log("ğŸ“Š Page view tracked:",t)}trackEvent(t,n={}){const a={event:t,properties:{...n,timestamp:Date.now(),sessionId:this.sessionData.sessionId,page:window.location.pathname,...this.getDeviceInfo()}};this.sessionData.events.push(a),this.sendToGA4(t,a.properties),this.sendToBaidu("_trackEvent",[t,JSON.stringify(n)]),this.sendToCustom(a),console.log("ğŸ“Š Event tracked:",t,n)}trackUserAction(t,n,a={}){this.trackEvent("user_action",{action:t,target:n,...a})}trackPerformance(){if(!window.performance)return;const t=performance.getEntriesByType("navigation")[0],n=performance.getEntriesByType("paint"),a={domContentLoaded:t?.domContentLoadedEventEnd-t?.domContentLoadedEventStart,loadComplete:t?.loadEventEnd-t?.loadEventStart,firstPaint:n.find(o=>o.name==="first-paint")?.startTime,firstContentfulPaint:n.find(o=>o.name==="first-contentful-paint")?.startTime,connectionType:navigator.connection?.effectiveType,downlink:navigator.connection?.downlink,usedJSHeapSize:performance.memory?.usedJSHeapSize,totalJSHeapSize:performance.memory?.totalJSHeapSize};this.trackEvent("performance_metrics",a)}sendToGA4(t,n){if(!(!window.gtag||!this.config.ga4.enabled))try{window.gtag("event",t,{...n,custom_parameter_1:this.sessionData.sessionId})}catch(a){console.error("GA4 tracking error:",a)}}sendToBaidu(t,n){if(!(!window._hmt||!this.config.baidu.enabled))try{window._hmt.push([t,...n])}catch(a){console.error("Baidu Analytics tracking error:",a)}}sendToCustom(t){this.config.custom.enabled&&(this.queue.push({...t,timestamp:Date.now(),url:window.location.href}),this.queue.length>=this.batchSize&&this.flushQueue())}async flushQueue(t=!1){if(this.queue.length===0||!this.isOnline&&!t)return;const n=[...this.queue];this.queue=[];try{const a=await fetch(this.config.custom.endpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({batch:n,sessionId:this.sessionData.sessionId,timestamp:Date.now()}),keepalive:t});if(!a.ok)throw new Error(`Analytics API error: ${a.status}`);console.log(`ğŸ“Š Analytics batch sent: ${n.length} events`)}catch(a){console.error("Analytics batch send failed:",a),t||this.queue.unshift(...n)}}startBatchSending(){setInterval(()=>{this.flushQueue()},this.flushInterval)}getDeviceInfo(){return{userAgent:this.sessionData.userAgent,language:this.sessionData.language,timezone:this.sessionData.timezone,screenResolution:this.sessionData.screenResolution,viewportSize:this.sessionData.viewportSize,platform:navigator.platform,cookieEnabled:navigator.cookieEnabled,onlineStatus:navigator.onLine}}trackPhotoEvent(t,n={}){this.trackEvent("photo_action",{action:t,photoId:n.id,hasGPS:!!(n.lat&&n.lng),fileSize:n.size,fileType:n.type})}trackMapEvent(t,n={}){this.trackEvent("map_action",{action:t,zoom:n.zoom,center:n.center,markerCount:n.markerCount})}trackSearchEvent(t,n=0){this.trackEvent("search",{query:t.substring(0,100),resultCount:n,queryLength:t.length})}trackError(t,n={}){this.trackEvent("application_error",{message:t.message,stack:t.stack,context:JSON.stringify(n)})}getAnalyticsReport(){return{session:{id:this.sessionData.sessionId,duration:Date.now()-this.sessionData.startTime,pageViews:this.sessionData.pageViews,events:this.sessionData.events.length},queue:{pending:this.queue.length,isOnline:this.isOnline},config:{ga4Enabled:this.config.ga4.enabled,baiduEnabled:this.config.baidu.enabled,customEnabled:this.config.custom.enabled},consent:this.hasUserConsent()}}clearData(){this.queue=[],this.sessionData.events=[],localStorage.removeItem("analytics_consent"),console.log("ğŸ“Š Analytics data cleared")}}const se=new Ws;!se.hasUserConsent()&&localStorage.getItem("analytics_consent")===null&&setTimeout(()=>{se.requestUserConsent()},3e3);const Hs=()=>({trackPage:(f,k)=>se.trackPageView(f,k),trackEvent:(f,k)=>se.trackEvent(f,k),trackAction:(f,k,y)=>se.trackUserAction(f,k,y),trackPhoto:(f,k)=>se.trackPhotoEvent(f,k),trackMap:(f,k)=>se.trackMapEvent(f,k),trackSearch:(f,k)=>se.trackSearchEvent(f,k),trackError:(f,k)=>se.trackError(f,k),getReport:()=>se.getAnalyticsReport()}),Js=typeof window<"u"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.port==="3001");class Zs{constructor(){this.registration=null,this.isOnline=navigator.onLine,this.installPrompt=null,this.updateAvailable=!1,this.init()}async init(){if(Js){console.log("âš ï¸ PWA Manager: Development mode - Service Worker disabled"),this.setupEventListeners();return}if("serviceWorker"in navigator)try{await this.registerServiceWorker(),this.setupEventListeners(),this.checkForUpdates(),console.log("âœ… PWA Manager initialized")}catch(t){console.error("âŒ PWA Manager initialization failed:",t)}else console.warn("âš ï¸ Service Worker not supported")}async registerServiceWorker(){try{return this.registration=await navigator.serviceWorker.register("/sw.js",{scope:"/"}),console.log("Service Worker registered:",this.registration),this.registration.addEventListener("updatefound",()=>{const t=this.registration.installing;t.addEventListener("statechange",()=>{t.state==="installed"&&navigator.serviceWorker.controller&&(this.updateAvailable=!0,this.notifyUpdateAvailable())})}),this.registration}catch(t){throw console.error("Service Worker registration failed:",t),t}}setupEventListeners(){window.addEventListener("online",()=>{this.isOnline=!0,this.onNetworkChange(!0)}),window.addEventListener("offline",()=>{this.isOnline=!1,this.onNetworkChange(!1)}),window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),this.installPrompt=t,this.showInstallButton()}),window.addEventListener("appinstalled",()=>{this.installPrompt=null,this.hideInstallButton(),this.trackEvent("pwa_installed")}),navigator.serviceWorker.addEventListener("message",t=>{this.handleServiceWorkerMessage(t.data)})}onNetworkChange(t){console.log("Network status:",t?"online":"offline"),this.showNetworkStatus(t),window.dispatchEvent(new CustomEvent("networkchange",{detail:{isOnline:t}})),t&&this.syncOfflineData()}showNetworkStatus(t){if(!document.getElementById("network-status")){const o=document.createElement("div");o.id="network-status",o.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 8px;
        text-align: center;
        font-size: 14px;
        z-index: 10000;
        transition: transform 0.3s ease;
        transform: translateY(-100%);
      `,document.body.appendChild(o)}const a=document.getElementById("network-status");t?(a.textContent="âœ… ç½‘ç»œå·²è¿æ¥",a.style.backgroundColor="#4CAF50",a.style.color="white",setTimeout(()=>{a.style.transform="translateY(-100%)"},3e3)):(a.textContent="âš ï¸ ç½‘ç»œå·²æ–­å¼€ï¼Œæ­£åœ¨ä½¿ç”¨ç¦»çº¿æ¨¡å¼",a.style.backgroundColor="#FF9800",a.style.color="white",a.style.transform="translateY(0)")}async checkForUpdates(){if(this.registration)try{await this.registration.update()}catch(t){console.error("Update check failed:",t)}}notifyUpdateAvailable(){const t=document.createElement("div");t.id="update-banner",t.innerHTML=`
      <div style="
        position: fixed;
        bottom: 20px;
        left: 20px;
        right: 20px;
        background: #2196F3;
        color: white;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: space-between;
      ">
        <span>ğŸš€ æ–°ç‰ˆæœ¬å¯ç”¨ï¼</span>
        <div>
          <button id="update-btn" style="
            background: white;
            color: #2196F3;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin-right: 8px;
            cursor: pointer;
          ">æ›´æ–°</button>
          <button id="dismiss-btn" style="
            background: transparent;
            color: white;
            border: 1px solid white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
          ">ç¨å</button>
        </div>
      </div>
    `,document.body.appendChild(t),document.getElementById("update-btn").addEventListener("click",()=>{this.applyUpdate(),t.remove()}),document.getElementById("dismiss-btn").addEventListener("click",()=>{t.remove()})}async applyUpdate(){!this.registration||!this.registration.waiting||(this.registration.waiting.postMessage({type:"SKIP_WAITING"}),window.location.reload())}showInstallButton(){let t=document.getElementById("install-pwa-btn");t||(t=document.createElement("button"),t.id="install-pwa-btn",t.textContent="ğŸ“± å®‰è£…åº”ç”¨",t.style.cssText=`
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 14px;
        transition: transform 0.3s ease;
      `,t.addEventListener("click",()=>{this.promptInstall()}),document.body.appendChild(t)),t.style.transform="scale(1)"}hideInstallButton(){const t=document.getElementById("install-pwa-btn");t&&(t.style.transform="scale(0)",setTimeout(()=>t.remove(),300))}async promptInstall(){if(this.installPrompt)try{const t=await this.installPrompt.prompt();console.log("Install prompt result:",t),this.installPrompt=null,this.hideInstallButton(),t.outcome==="accepted"?this.trackEvent("pwa_install_accepted"):this.trackEvent("pwa_install_dismissed")}catch(t){console.error("Install prompt failed:",t)}}async syncOfflineData(){if(!(!this.registration||!this.registration.sync))try{await this.registration.sync.register("background-sync"),console.log("Background sync registered")}catch(t){console.error("Background sync registration failed:",t)}}handleServiceWorkerMessage(t){const{type:n,payload:a}=t;switch(n){case"CACHE_SIZE":console.log("Cache size:",a);break;case"CACHE_CLEARED":console.log("Cache cleared");break;case"URLS_CACHED":console.log("URLs cached");break}}async getCacheSize(){return this.registration?new Promise(t=>{const n=new MessageChannel;n.port1.onmessage=a=>{a.data.type==="CACHE_SIZE"&&t(a.data.payload)},this.registration.active.postMessage({type:"GET_CACHE_SIZE"},[n.port2])}):null}async clearCache(){if(this.registration)return new Promise(t=>{const n=new MessageChannel;n.port1.onmessage=a=>{a.data.type==="CACHE_CLEARED"&&t()},this.registration.active.postMessage({type:"CLEAR_CACHE"},[n.port2])})}async cacheUrls(t){if(this.registration)return new Promise(n=>{const a=new MessageChannel;a.port1.onmessage=o=>{o.data.type==="URLS_CACHED"&&n()},this.registration.active.postMessage({type:"CACHE_URLS",payload:{urls:t}},[a.port2])})}isPWA(){return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||document.referrer.includes("android-app://")}getStatus(){return{isOnline:this.isOnline,isPWA:this.isPWA(),hasServiceWorker:!!this.registration,updateAvailable:this.updateAvailable,canInstall:!!this.installPrompt}}trackEvent(t,n={}){window.monitoring&&window.monitoring.trackEvent(t,{...n,pwa:!0,isOnline:this.isOnline})}}const be=new Zs,Gs=()=>{const[d,t]=i.useState(be.getStatus());return i.useEffect(()=>{const n=()=>t(be.getStatus());return window.addEventListener("networkchange",n),window.addEventListener("appinstalled",n),()=>{window.removeEventListener("networkchange",n),window.removeEventListener("appinstalled",n)}},[]),{...d,promptInstall:()=>be.promptInstall(),checkForUpdates:()=>be.checkForUpdates(),getCacheSize:()=>be.getCacheSize(),clearCache:()=>be.clearCache()}};var Vs=Gt();const Ys=({onComplete:d})=>{const[t,n]=i.useState(0),[a,o]=i.useState("loading"),[u,c]=i.useState(null),m=i.useRef(null),f=i.useRef(null);i.useEffect(()=>{const g=new AbortController;return fetch("https://restapi.amap.com/v3/ip?key=9fb3c3f43537ecacd6d0a082958a883c",{signal:g.signal}).then(j=>j.json()).then(j=>{if(j.status==="1"&&j.rectangle){const[_,q]=j.rectangle.split(";").map(ne=>ne.split(",").map(Number)),$=[(_[0]+q[0])/2,(_[1]+q[1])/2];c($),window.__userLocation=$}else c([117.28,31.86]),window.__userLocation=[117.28,31.86]}).catch(()=>{c([117.28,31.86]),window.__userLocation=[117.28,31.86]}),()=>g.abort()},[]),i.useEffect(()=>{if(!m.current||f.current)return;const g=()=>{if(!window.mapboxgl){setTimeout(g,100);return}window.mapboxgl.accessToken="pk.eyJ1IjoiZm43cXAiLCJhIjoiY21peTUyd3B5MGJqMTNjcTU4aDVtdnNqNiJ9.TadVpAbhvEATQxuflxmqdA";const j=new window.mapboxgl.Map({container:m.current,style:"mapbox://styles/mapbox/streets-v12",center:[30,20],zoom:1.5,projection:"globe",interactive:!0,scrollZoom:!1,boxZoom:!1,doubleClickZoom:!1,touchZoomRotate:!1,dragRotate:!0,dragPan:!0,keyboard:!1,attributionControl:!1,fadeDuration:200,maxTileCacheSize:4e3,antialias:!0});f.current=j,j.on("style.load",()=>{j.setFog({color:"rgb(186, 210, 235)","high-color":"rgb(36, 92, 223)","horizon-blend":.02,"space-color":"rgb(11, 11, 25)","star-intensity":.6})})};return g(),()=>{f.current&&(f.current.remove(),f.current=null)}},[]),i.useEffect(()=>{let j=null,_=null;const q=$=>{j||(j=$);const ne=Math.min(($-j)/2500*100,100);n(ne),ne<100?_=requestAnimationFrame(q):setTimeout(()=>o("ready"),300)};return _=requestAnimationFrame(q),()=>_&&cancelAnimationFrame(_)},[]);const k=i.useCallback(()=>{if(!f.current||a!=="ready")return;o("flying");const g=f.current,j=u||window.__userLocation||[117.28,31.86];window.__loaderFinalState={center:j,zoom:13},g.flyTo({center:j,zoom:13,duration:2e3,essential:!0}),g.once("moveend",()=>{o("fadeout"),setTimeout(()=>{o("hidden"),d()},300)})},[d,u,a]);if(a==="hidden")return null;const y=a==="ready",N=a==="loading"||a==="ready",x=a==="fadeout";return e.jsxs("div",{className:"globe-loader",style:{opacity:x?0:1,transition:"opacity 0.3s ease"},children:[e.jsx("div",{ref:m,className:"globe-map-container"}),N&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"globe-bottom-gradient"}),e.jsxs("div",{className:"globe-content",children:[e.jsxs("div",{className:"globe-header",children:[e.jsx("h1",{className:"globe-title",children:"åœ°å›¾ç›¸å†Œ"}),e.jsx("p",{className:"globe-subtitle",children:"è®°å½•æ¯ä¸€ä¸ªå€¼å¾—çºªå¿µçš„åœ°ç‚¹"})]}),e.jsx("div",{className:`globe-action ${y?"is-ready":""}`,children:e.jsxs("div",{className:"globe-bar",onClick:y?k:void 0,role:y?"button":void 0,tabIndex:y?0:void 0,children:[e.jsx("div",{className:"globe-bar-fill",style:{width:y?"100%":`${t}%`}}),e.jsx("span",{className:"globe-bar-text",children:y?"è¿›å…¥åœ°å›¾":`${Math.round(t)}%`})]})})]})]})]})};window.electronAPI||Yt(()=>Promise.resolve().then(()=>tn),void 0);const Ks=()=>{const[d,t]=i.useState(!1),n=navigator.userAgent.includes("Mac")?"mac":navigator.userAgent.includes("Linux")?"linux":"windows",a={windows:{name:"Windows",file:"photo-map-setup-1.0.0.exe",size:"~85MB"},mac:{name:"macOS",file:"photo-map-1.0.0.dmg",size:"~90MB"},linux:{name:"Linux",file:"photo-map-1.0.0.AppImage",size:"~88MB"}},o=[{icon:"âš¡",text:"æ›´å¿«çš„æ€§èƒ½å’Œå“åº”é€Ÿåº¦"},{icon:"ğŸ’¾",text:"æœ¬åœ°å­˜å‚¨ï¼Œæ•°æ®æ›´å®‰å…¨"},{icon:"ğŸ“´",text:"ç¦»çº¿ä½¿ç”¨ï¼Œæ— éœ€ç½‘ç»œ"},{icon:"ğŸ–¼ï¸",text:"æ›´å¥½çš„å›¾ç‰‡å¤„ç†èƒ½åŠ›"}],u=d?Vs.createPortal(e.jsx("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:99999},onClick:()=>t(!1),children:e.jsxs("div",{style:{background:"#fff",borderRadius:"12px",width:"360px",maxWidth:"90vw",boxShadow:"0 16px 48px rgba(0,0,0,0.2)"},onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{style:{padding:"20px 20px 16px",borderBottom:"1px solid #e5e7eb"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("h2",{style:{margin:0,fontSize:"17px",fontWeight:600,color:"#111"},children:"ä¸‹è½½æ¡Œé¢ç‰ˆ"}),e.jsx("button",{onClick:()=>t(!1),style:{background:"none",border:"none",fontSize:"18px",color:"#9ca3af",cursor:"pointer",padding:0},children:"Ã—"})]}),e.jsx("p",{style:{margin:"6px 0 0",fontSize:"13px",color:"#6b7280"},children:"è·å¾—æ›´å¥½çš„ä½¿ç”¨ä½“éªŒ"})]}),e.jsxs("div",{style:{padding:"16px 20px"},children:[e.jsx("div",{style:{marginBottom:"16px"},children:o.map((c,m)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px",padding:"6px 0",fontSize:"13px",color:"#374151"},children:[e.jsx("span",{children:c.icon}),e.jsx("span",{children:c.text})]},m))}),e.jsxs("div",{style:{background:"#f9fafb",border:"1px solid #e5e7eb",borderRadius:"8px",padding:"14px",marginBottom:"14px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"10px"},children:[e.jsxs("div",{children:[e.jsx("div",{style:{fontWeight:500,fontSize:"14px",color:"#111"},children:a[n].name}),e.jsx("div",{style:{fontSize:"12px",color:"#9ca3af"},children:a[n].size})]}),e.jsx("span",{style:{background:"#ecfdf5",color:"#059669",fontSize:"11px",padding:"3px 6px",borderRadius:"4px",fontWeight:500},children:"æ¨è"})]}),e.jsx("a",{href:`/downloads/${a[n].file}`,download:!0,style:{display:"block",background:"#111",color:"#fff",textAlign:"center",padding:"10px",borderRadius:"6px",fontSize:"13px",fontWeight:500,textDecoration:"none"},children:"ç«‹å³ä¸‹è½½"})]}),e.jsx("div",{style:{display:"flex",justifyContent:"center",gap:"20px"},children:Object.entries(a).filter(([c])=>c!==n).map(([c,m])=>e.jsx("a",{href:`/downloads/${m.file}`,download:!0,style:{fontSize:"12px",color:"#6b7280",textDecoration:"underline"},children:m.name},c))})]}),e.jsx("div",{style:{borderTop:"1px solid #e5e7eb",padding:"12px 20px",textAlign:"center"},children:e.jsx("a",{href:"https://github.com/Satulalala/photo-map",target:"_blank",rel:"noopener noreferrer",style:{fontSize:"12px",color:"#6b7280",textDecoration:"none"},children:"GitHub â†’"})})]})}),document.body):null;return e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
        @keyframes subtle-pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.85; }
        }
        .web-dl-btn-dark {
          background: #111;
          color: #fff;
          border: none;
          border-radius: 6px;
          padding: 8px 12px;
          font-size: 13px;
          font-weight: 500;
          cursor: pointer;
          white-space: nowrap;
          animation: subtle-pulse 3s ease-in-out infinite;
          transition: transform 0.15s, opacity 0.15s;
        }
        .web-dl-btn-dark:hover {
          transform: scale(1.03);
          opacity: 0.9;
        }
      `}),e.jsx("button",{onClick:()=>t(!0),className:"web-dl-btn-dark",children:"â¬‡ æ¡Œé¢ç‰ˆ"}),u]})},Jt=({onComplete:d})=>e.jsx(Ys,{onComplete:d});i.lazy(()=>Yt(()=>import("./SettingsPanel-hZ22DIAV.js"),__vite__mapDeps([0,1,2,3])));const wt=i.memo(function({photo:t,className:n,alt:a="",useThumbnail:o=!0}){const[u,c]=i.useState("");return i.useEffect(()=>{if(t){if(typeof t=="string"){c(t);return}if(t.data?.startsWith("data:")){c(t.data);return}if(t.id&&window.electronAPI){const m=o?ze:X,f=o?t.id.replace(/\.[^.]+$/,".webp"):t.id,k=m.get(f);if(k){c(k);return}(o&&window.electronAPI.getThumbnailUrl?window.electronAPI.getThumbnailUrl:window.electronAPI.getPhotoUrl)(t.id).then(N=>{N&&(m.set(f,N),c(N))})}}},[t,o]),u?e.jsx("img",{src:u,alt:a,className:n,loading:"lazy"}):e.jsx("div",{className:n,style:{background:"#f0f0f0"}})}),Zt=i.memo(function({marker:t,onClick:n}){return e.jsxs("div",{className:"marker-list-item",onClick:n,children:[(t.firstPhoto||t.photos?.[0])&&e.jsx(wt,{photo:t.firstPhoto||t.photos[0],className:"marker-list-thumb"}),e.jsxs("div",{className:"marker-list-info",children:[e.jsx("div",{className:"marker-list-name",children:t.name||`${t.lat.toFixed(3)}Â°, ${t.lng.toFixed(3)}Â°`}),e.jsxs("div",{className:"marker-list-meta",children:["ğŸ“· ",t.photoCount??t.photos?.length??0," å¼  Â· ",t.createdAt?new Date(t.createdAt).toLocaleDateString("zh-CN"):"æœªçŸ¥æ—¶é—´"]})]})]})}),Qs=()=>typeof window<"u"&&window.mapboxgl?(window.mapboxgl.accessToken="pk.eyJ1IjoiZm43cXAiLCJhIjoiY21peTUyd3B5MGJqMTNjcTU4aDVtdnNqNiJ9.TadVpAbhvEATQxuflxmqdA",window.mapboxgl):null;Qs();const xt=(d,t)=>{const n=Math.PI,a=6378245,o=.006693421622965943,u=(x,g)=>{let j=-100+2*x+3*g+.2*g*g+.1*x*g+.2*Math.sqrt(Math.abs(x));return j+=(20*Math.sin(6*x*n)+20*Math.sin(2*x*n))*2/3,j+=(20*Math.sin(g*n)+40*Math.sin(g/3*n))*2/3,j+=(160*Math.sin(g/12*n)+320*Math.sin(g*n/30))*2/3,j},c=(x,g)=>{let j=300+x+2*g+.1*x*x+.1*x*g+.1*Math.sqrt(Math.abs(x));return j+=(20*Math.sin(6*x*n)+20*Math.sin(2*x*n))*2/3,j+=(20*Math.sin(x*n)+40*Math.sin(x/3*n))*2/3,j+=(150*Math.sin(x/12*n)+300*Math.sin(x/30*n))*2/3,j};let m=u(d-105,t-35),f=c(d-105,t-35);const k=t/180*n;let y=Math.sin(k);y=1-o*y*y;const N=Math.sqrt(y);return m=m*180/(a*(1-o)/(y*N)*n),f=f*180/(a/N*Math.cos(k)*n),{lng:d-f,lat:t-m}};function Xs(){const d=qs(),t=Hs();Gs();const[n,a]=i.useState(!1);i.useEffect(()=>{const s=()=>{typeof window<"u"&&window.mapboxgl?a(!0):setTimeout(s,100)};s()},[]);const[o,u]=i.useState(!1),[c,m]=i.useState([]),[f,k]=i.useState({lat:0,lng:0,x:0,y:0}),[y,N]=i.useState(null),[x,g]=i.useState(null),[j,_]=i.useState(null),[q,$]=i.useState(""),[ne,ke]=i.useState(0),[ae,re]=i.useState(!1),[O,xe]=i.useState("map"),[G,je]=i.useState(!1),[D,H]=i.useState(null),[_e,$e]=i.useState(""),[bt,me]=i.useState(null),[we,A]=i.useState(!1),[C,T]=i.useState(!1),[b,R]=i.useState(null),[S,F]=i.useState(null),[oe,J]=i.useState(!1),[V,Z]=i.useState([]),[Me,Ne]=i.useState({count:0,size:0}),[Ve,pe]=i.useState(!1),[Se,ge]=i.useState(!1),[Ce,ie]=i.useState(!1),[Ye,kt]=i.useState("time"),[Pe,Xt]=i.useState(""),[Ie,Ke]=i.useState([]),[jt,Qe]=i.useState(!1),[Xe,Oe]=i.useState(!1),[et,Ue]=i.useState(!1),[le,tt]=i.useState(""),st=i.useDeferredValue(le),[nt,Ee]=i.useState([]),[at,ye]=i.useState(!1),[es,Mt]=i.useState(!1),[Ae,Nt]=i.useState(()=>{try{return JSON.parse(localStorage.getItem("searchHistory")||"[]")}catch{return[]}}),[Be,ce]=i.useState(-1),Fe=i.useRef(null),[Te,St]=i.useState(null),[ts,Ct]=i.useState(!0),[de,Pt]=i.useState(!1),[rt,qe]=i.useState(new Set),[sn,nn]=i.useState(0),[We,ot]=i.useState(null),it={antialias:!0,fadeDuration:200,maxTileCacheSize:4e3,dragRotate:!1,renderWorldCopies:!1,maxZoom:18,minZoom:0},[U,lt]=i.useState(()=>{try{const s=localStorage.getItem("mapSettings");return s?{...it,...JSON.parse(s)}:it}catch{return it}}),[z,ee]=i.useState(U),[ss,ct]=i.useState(null),[ns,It]=i.useState([]),dt=i.useRef(null),P=i.useRef(null),He=i.useRef({}),Je=i.useRef(null),as=i.useRef(c),te=i.useRef(null),Et=i.useRef(!1),fe=i.useRef(null);i.useEffect(()=>{as.current=c},[c]);const Le=i.useCallback(async s=>{if(!s)return null;if(typeof s=="string")return s;if(s.data&&s.data.startsWith("data:"))return s.data;const r=s.id;if(!r)return null;const l=X.get(r);if(l)return l;if(window.electronAPI){const p=await window.electronAPI.getPhotoUrl(r);return p&&X.set(r,p),p}return null},[]);i.useCallback(s=>{if(!s)return"";if(typeof s=="string")return s;if(s.data&&s.data.startsWith("data:"))return s.data;const r=s.id;return X.get(r)||""},[]);const At=i.useMemo(()=>c.reduce((s,r)=>s+(r.photoCount??r.photos?.length??0),0),[c]);i.useEffect(()=>{if(D&&D.photos[D.index]){Le(D.photos[D.index]).then(r=>{$e(r||"")});const s=()=>{const{photos:r,index:l}=D;[l+1,l-1].filter(h=>h>=0&&h<r.length).forEach(h=>{Le(r[h]).then(w=>{if(w){const v=new Image;v.src=w}})})};"requestIdleCallback"in window?requestIdleCallback(s,{timeout:1e3}):setTimeout(s,100)}else $e(""),me(null)},[D,Le]),i.useEffect(()=>{if(D&&D.photos[D.index]){const s=D.photos[D.index];s?.id&&window.electronAPI?.getPhotoInfo?window.electronAPI.getPhotoInfo(s.id).then(r=>{me(r)}):me(null)}},[D?.index,D?.photos]);const Y=i.useCallback((s,r,l=2500)=>{St({type:s,message:r}),setTimeout(()=>St(null),l)},[]);i.useEffect(()=>{const s=r=>{if(!(r.target.tagName==="INPUT"||r.target.tagName==="TEXTAREA")){if(r.key==="Escape"){if(D){H(null);return}if(We){ot(null);return}if(ae){re(!1);return}if(Ce){ie(!1);return}if(x){g(null);return}if(y){N(null),_(null);return}if(G){je(!1);return}}if(D){r.key==="ArrowLeft"||r.key==="a"?(H(l=>({...l,index:(l.index-1+l.photos.length)%l.photos.length})),ge(!1)):(r.key==="ArrowRight"||r.key==="d")&&(H(l=>({...l,index:(l.index+1)%l.photos.length})),ge(!1));return}!ae&&!Ce&&!x&&!y&&(r.key==="f"||r.key==="F"?(r.preventDefault(),Fe.current?.focus()):r.key==="m"||r.key==="M"?ie(!0):r.key==="h"||r.key==="H"?Pt(l=>!l):(r.key==="s"||r.key==="S")&&!r.ctrlKey&&!r.metaKey?re(!0):r.key==="r"||r.key==="R"?je(l=>!l):r.key==="+"||r.key==="="?P.current?.zoomIn():r.key==="-"?P.current?.zoomOut():r.key==="0"&&te.current&&P.current&&P.current.flyTo({center:te.current,zoom:13,duration:1e3}))}};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[D,We,ae,Ce,x,y,G]),i.useEffect(()=>(Ls(),window.electronAPI&&(Ct(!0),window.electronAPI.loadMarkers().then(s=>{m(s),Ct(!1);const r=s.filter(l=>!l.name);r.length>0&&Promise.all(r.map(async l=>{try{const h=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${l.lng},${l.lat}.json?access_token=${window.mapboxgl?.accessToken}&language=zh&limit=1`)).json();if(h.features?.[0]){const v=(h.features[0].place_name_zh||h.features[0].place_name||"").replace(/\s*\d{5,6}\s*$/,"").replace(/,\s*$/,"");return window.electronAPI.updateMarker({id:l.id,lat:l.lat,lng:l.lng,name:v}),{id:l.id,name:v}}}catch{}return null})).then(l=>{const p={};l.forEach(h=>{h&&(p[h.id]=h.name)}),Object.keys(p).length>0&&m(h=>h.map(w=>p[w.id]?{...w,name:p[w.id]}:w))})}),window.electronAPI.getCacheStats().then(Ne)),()=>{Ds()}),[]),i.useEffect(()=>{window.electronAPI||(d.updateSEO({title:"åœ°å›¾ç›¸å†Œ",description:"ä¸€ä¸ªä¼˜é›…çš„ç…§ç‰‡åœ°å›¾åº”ç”¨ï¼Œå¸®åŠ©æ‚¨åœ¨åœ°å›¾ä¸Šæ ‡è®°å’Œç®¡ç†ç…§ç‰‡ï¼Œè®°å½•æ—…è¡Œè¶³è¿¹ï¼Œåˆ†äº«ç¾å¥½å›å¿†ã€‚",keywords:"åœ°å›¾ç›¸å†Œ,ç…§ç‰‡åœ°å›¾,GPSç…§ç‰‡,æ—…è¡Œè®°å½•,ä½ç½®æ ‡è®°,ç…§ç‰‡ç®¡ç†"}),t.trackPage("/","åœ°å›¾ç›¸å†Œ - é¦–é¡µ"),t.trackEvent("app_start",{version:"1.0.0",platform:"web",userAgent:navigator.userAgent,language:navigator.language,screenResolution:`${screen.width}x${screen.height}`,viewportSize:`${window.innerWidth}x${window.innerHeight}`}),setTimeout(()=>{t.trackPerformance()},2e3),console.log("âœ… Web optimization features initialized"))},[d,t]),i.useEffect(()=>{let s=0;const r=setInterval(()=>{s+=Math.random()*35+20,s>95&&(s=95),ke(s)},25),l=new AbortController,p=setTimeout(()=>l.abort(),1500);fetch("https://restapi.amap.com/v3/ip?key=9fb3c3f43537ecacd6d0a082958a883c",{signal:l.signal}).then(h=>h.json()).then(h=>{if(clearTimeout(p),h.status==="1"&&h.rectangle){const[w,v]=h.rectangle.split(";").map(E=>E.split(",").map(Number)),M=(w[0]+v[0])/2,I=(w[1]+v[1])/2;te.current=[M,I],console.log("é«˜å¾·IPå®šä½:",h.city,[M,I])}}).catch(()=>{clearTimeout(p)}).finally(()=>{te.current||(te.current=[117.28,31.86]),clearInterval(r),ke(100)})},[]),i.useEffect(()=>{if(!o||!dt.current||P.current||!n)return;if(!window.mapboxgl){console.error("Mapbox GL JS æœªåŠ è½½");return}const s=window.__loaderFinalState||{},r=s.center||window.__userLocation||[117.28,31.86],l=s.zoom||13;te.current=r;try{const p=new window.mapboxgl.Map({container:dt.current,style:"mapbox://styles/mapbox/streets-v12",center:r,zoom:l,pitch:0,projection:"globe",language:"zh-Hans",antialias:U.antialias,fadeDuration:U.fadeDuration,maxTileCacheSize:U.maxTileCacheSize,dragRotate:U.dragRotate,renderWorldCopies:U.renderWorldCopies,maxZoom:U.maxZoom,minZoom:U.minZoom,trackResize:!0,refreshExpiredTiles:!1,scrollZoom:!0,pitchWithRotate:!1,crossSourceCollisions:!1,collectResourceTiming:!1,preserveDrawingBuffer:!1,failIfMajorPerformanceCaveat:!1});p.on("style.load",()=>{p.setFog({color:"rgb(186, 210, 235)","high-color":"rgb(36, 92, 223)","horizon-blend":.02,"space-color":"rgb(11, 11, 25)","star-intensity":.6})}),p.on("dragstart",()=>pe(!0)),p.on("dragend",()=>pe(!1));let h=0;return p.on("mousemove",w=>{const v=Date.now();v-h<16||(h=v,k({lat:w.lngLat.lat,lng:w.lngLat.lng,x:w.point.x,y:w.point.y}))}),p.on("click",w=>{const v=document.createElement("div");if(v.className="click-ripple",v.style.left=`${w.point.x}px`,v.style.top=`${w.point.y}px`,document.body.appendChild(v),setTimeout(()=>v.remove(),700),Et.current){const L={lat:w.lngLat.lat,lng:w.lngLat.lng};if(!fe.current)fe.current=L,ct(L);else{const B=[fe.current.lng,fe.current.lat],K=[L.lng,L.lat],Q=rs(B,K),ys=Q>=1?`${Q.toFixed(2)} km`:`${Math.round(Q*1e3)} m`;It(vs=>[...vs,{start:fe.current,end:L,distance:ys}]),fe.current=null,ct(null)}return}const M={lat:w.lngLat.lat,lng:w.lngLat.lng};_(M),N({x:w.point.x,y:w.point.y,latlng:M}),$(`${M.lat.toFixed(3)}Â°, ${M.lng.toFixed(3)}Â°`);const I=M.lng>=73&&M.lng<=135&&M.lat>=18&&M.lat<=54,E=new AbortController,W=setTimeout(()=>E.abort(),3e3);I?fetch(`https://restapi.amap.com/v3/geocode/regeo?key=9fb3c3f43537ecacd6d0a082958a883c&location=${M.lng},${M.lat}&extensions=base`,{signal:E.signal}).then(L=>L.json()).then(L=>{clearTimeout(W),L.status==="1"&&L.regeocode?.formatted_address&&$(L.regeocode.formatted_address)}).catch(()=>clearTimeout(W)):fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${M.lng},${M.lat}.json?access_token=${window.mapboxgl?.accessToken}&language=zh-Hans&limit=1`,{signal:E.signal}).then(L=>L.json()).then(L=>{if(clearTimeout(W),L.features?.[0]){let B=L.features[0].place_name||"";B=B.replace(/\s*\d{5,6}\s*$/,"").replace(/,\s*$/,""),B&&$(B)}}).catch(()=>clearTimeout(W))}),p.on("load",()=>{T(!0),p.addSource("markers-heatmap",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),p.addLayer({id:"markers-heat",type:"heatmap",source:"markers-heatmap",maxzoom:18,layout:{visibility:"none"},paint:{"heatmap-weight":["interpolate",["linear"],["get","photoCount"],1,.4,5,.7,10,.9,20,1],"heatmap-intensity":["interpolate",["linear"],["zoom"],0,2,5,1.5,10,2,15,3],"heatmap-color":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"rgba(65, 105, 225, 0.5)",.3,"rgb(0, 191, 255)",.5,"rgb(50, 205, 50)",.7,"rgb(255, 215, 0)",.85,"rgb(255, 140, 0)",1,"rgb(255, 0, 0)"],"heatmap-radius":["interpolate",["linear"],["zoom"],0,15,3,20,6,25,10,30,15,40],"heatmap-opacity":["interpolate",["linear"],["zoom"],0,.8,10,.85,15,.6]}}),setTimeout(()=>{te.current&&p.flyTo({center:te.current,zoom:13,duration:2e3})},800)}),P.current=p,()=>{p.remove(),P.current=null}}catch(p){console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:",p)}},[o,n]);const rs=(s,r)=>{const p=(r[1]-s[1])*Math.PI/180,h=(r[0]-s[0])*Math.PI/180,w=Math.sin(p/2)*Math.sin(p/2)+Math.cos(s[1]*Math.PI/180)*Math.cos(r[1]*Math.PI/180)*Math.sin(h/2)*Math.sin(h/2);return 6371*2*Math.atan2(Math.sqrt(w),Math.sqrt(1-w))},Tt=i.useCallback((s,r=[])=>{const l=document.createElement("div");return l.className="marker-pin",r.length>0?(l.style.display="flex",l.style.flexDirection="column",l.style.alignItems="center",l.innerHTML=`
        <div class="marker-photo-preview">
          <img src="" alt="é¢„è§ˆ" loading="lazy" style="background:#f0f0f0" />
          ${r.length>1?`<span class="photo-badge">+${r.length-1}</span>`:""}
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="32" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="${s}"/><circle cx="12" cy="12" r="5" fill="white"/></svg>
      `,Le(r[0]).then(p=>{const h=l.querySelector("img");h&&p&&(h.src=p)})):(l.style.width="24px",l.style.height="32px",l.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="32" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="${s}"/><circle cx="12" cy="12" r="5" fill="white"/></svg>`),l.style.cursor="pointer",l},[Le]);i.useRef({}),i.useCallback((s,r)=>{const l=document.createElement("div");if(l.className="marker-pin",l.style.cssText="cursor:pointer;display:flex;flex-direction:column;align-items:center;",s){l.innerHTML=`
        <div class="marker-photo-preview" style="width:48px;height:48px;border-radius:6px;overflow:hidden;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);background:#f0f0f0;margin-bottom:2px;position:relative;">
          <img src="" style="width:100%;height:100%;object-fit:cover;display:block;" />
          ${r>1?`<span style="position:absolute;top:2px;right:2px;background:rgba(0,0,0,0.6);color:white;font-size:10px;padding:1px 4px;border-radius:8px;">+${r-1}</span>`:""}
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="26" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="#ff6b6b"/><circle cx="12" cy="12" r="4" fill="white"/></svg>
      `;const p=l.querySelector("img");window.electronAPI?.getThumbnailUrl&&window.electronAPI.getThumbnailUrl(s).then(h=>{h&&(p.src=h)})}else l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="32" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="#ff6b6b"/><circle cx="12" cy="12" r="5" fill="white"/></svg>';return l},[]);const Lt=i.useCallback((s,r)=>{const l=document.createElement("div");l.className="marker-pin",l.style.cssText=`cursor:pointer;display:flex;flex-direction:column;align-items:center;${r?"animation:markerDrop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;":""}`;const p=s.firstPhoto,h=s.photoCount??0;if(p&&(p.id||p.data)){l.innerHTML=`
        <div class="marker-photo-preview" style="width:48px;height:48px;border-radius:6px;overflow:hidden;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);background:#e2e8f0;margin-bottom:2px;position:relative;">
          <img src="" style="width:100%;height:100%;object-fit:cover;display:block;opacity:0;transition:opacity 0.2s;" />
          ${h>1?`<span style="position:absolute;top:2px;right:2px;background:rgba(0,0,0,0.6);color:white;font-size:10px;padding:1px 4px;border-radius:8px;">+${h-1}</span>`:""}
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="26" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="#ff6b6b"/><circle cx="12" cy="12" r="4" fill="white"/></svg>
      `;const v=l.querySelector("img");v&&(p.data&&p.data.startsWith("data:")?(v.onload=()=>{v.style.opacity="1"},v.src=p.data):p.id&&window.electronAPI?.getThumbnailUrl&&window.electronAPI.getThumbnailUrl(p.id).then(M=>{M&&(v.onload=()=>{v.style.opacity="1"},v.src=M)}))}else l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="32" viewBox="0 0 24 32"><path d="M12 0C5.4 0 0 5.4 0 12c0 9 12 20 12 20s12-11 12-20C24 5.4 18.6 0 12 0z" fill="#ff6b6b"/><circle cx="12" cy="12" r="5" fill="white"/></svg>';return l.addEventListener("click",async v=>{v.stopPropagation(),P.current.flyTo({center:[s.lng,s.lat],zoom:Math.max(P.current.getZoom(),15),duration:800}),setTimeout(async()=>{const M=P.current.project([s.lng,s.lat]);let I=s;if(window.electronAPI?.getMarkerDetail){const E=await window.electronAPI.getMarkerDetail(s.id);E&&(I=E)}g({x:M.x,y:M.y,marker:I})},850),N(null),_(null)}),l},[]),Dt=i.useCallback(()=>{P.current&&(Object.values(He.current).forEach(s=>s.remove()),He.current={},c.forEach(s=>{const r=rt.has(s.id),l=Lt(s,r),p=new window.mapboxgl.Marker({element:l,anchor:"bottom"}).setLngLat([s.lng,s.lat]).addTo(P.current);He.current[s.id]=p,de&&(l.style.display="none")}))},[c,rt,Lt,de]);i.useEffect(()=>{C&&Dt()},[c,C,Dt,rt]),i.useEffect(()=>{if(!P.current||!C)return;const s=P.current.getSource("markers-heatmap");if(!s)return;const r=c.map(l=>({type:"Feature",geometry:{type:"Point",coordinates:[l.lng,l.lat]},properties:{photoCount:l.photoCount??l.photos?.length??1}}));s.setData({type:"FeatureCollection",features:r})},[c,C]),i.useEffect(()=>{!P.current||!C||!P.current.getLayer("markers-heat")||(P.current.setLayoutProperty("markers-heat","visibility",de?"visible":"none"),Object.values(He.current).forEach(r=>{r.getElement().style.display=de?"none":"flex"}))},[de,C]),i.useEffect(()=>{if(P.current&&(Je.current&&(Je.current.remove(),Je.current=null),j)){const s=Tt("#00b894");Je.current=new window.mapboxgl.Marker({element:s,anchor:"bottom"}).setLngLat([j.lng,j.lat]).addTo(P.current)}},[j,Tt]);const he=i.useCallback(()=>{window.electronAPI&&window.electronAPI.loadMarkers().then(m)},[]),Rt=i.useCallback(async(s,r)=>{const l=r>=73&&r<=135&&s>=18&&s<=54;try{if(l){const h=await(await fetch(`https://restapi.amap.com/v3/geocode/regeo?key=9fb3c3f43537ecacd6d0a082958a883c&location=${r},${s}&extensions=base`,{signal:AbortSignal.timeout(3e3)})).json();if(h.status==="1"&&h.regeocode?.formatted_address)return h.regeocode.formatted_address}else{const h=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${r},${s}.json?access_token=${window.mapboxgl?.accessToken}&language=zh-Hans&limit=1`,{signal:AbortSignal.timeout(3e3)})).json();if(h.features?.[0])return(h.features[0].place_name||"").replace(/\s*\d{5,6}\s*$/,"").replace(/,\s*$/,"")}}catch{}return`${s.toFixed(3)}Â°, ${r.toFixed(3)}Â°`},[]),os=async s=>{if(!window.electronAPI)return;const r=await window.electronAPI.selectPhotos();if(!r||r.length===0)return;const l=await Rt(s.lat,s.lng),p={id:Ot(),lat:s.lat,lng:s.lng,name:l,photos:r.map(h=>({id:h.id,data:h.data,note:""})),photoCount:r.length,firstPhoto:r[0]?{id:r[0].id,data:r[0].data}:null,createdAt:Date.now()};await window.electronAPI.addMarker(p),qe(h=>new Set(h).add(p.id)),setTimeout(()=>qe(h=>{const w=new Set(h);return w.delete(p.id),w}),600),he(),N(null),_(null),Y("success",`å·²æ·»åŠ  ${r.length} å¼ ç…§ç‰‡`)},is=async(s,r,l)=>{window.electronAPI&&(await window.electronAPI.updatePhotoNote(s,r,l),Y("success","å¤‡æ³¨å·²ä¿å­˜")),R(null)},ht=i.useCallback(s=>typeof s=="string"?"":s.note||"",[]),zt=i.useCallback(()=>{N(null),_(null),g(null)},[]),ls=i.useCallback(async s=>{window.electronAPI&&(await window.electronAPI.deleteMarker(s),he(),Y("success","æ ‡è®°å·²åˆ é™¤"))},[he,Y]),cs=i.useCallback(()=>{P.current&&te.current&&P.current.flyTo({center:te.current,zoom:15,duration:1e3})},[]),ds=i.useCallback(()=>P.current?.zoomIn(),[]),hs=i.useCallback(()=>P.current?.zoomOut(),[]),Ze=i.useCallback((s,r,l,p)=>{const w=(p-r)*Math.PI/180,v=(l-s)*Math.PI/180,M=Math.sin(w/2)*Math.sin(w/2)+Math.cos(r*Math.PI/180)*Math.cos(p*Math.PI/180)*Math.sin(v/2)*Math.sin(v/2);return 6371*2*Math.atan2(Math.sqrt(M),Math.sqrt(1-M))},[]),ut="9fb3c3f43537ecacd6d0a082958a883c",_t=i.useCallback(async s=>{if(!s.trim()){Ee([]);return}Mt(!0),ce(-1);try{const r=P.current?.getCenter()||{lng:117,lat:32},l=new AbortController,p=setTimeout(()=>l.abort(),5e3);let h=[];const v=await(await fetch(`https://restapi.amap.com/v3/assistant/inputtips?key=${ut}&keywords=${encodeURIComponent(s)}&location=${r.lng},${r.lat}&datatype=all`,{signal:l.signal})).json();if(v.status==="1"&&v.tips?.length>0&&(h=v.tips.filter(I=>I.location&&I.location.includes(",")).slice(0,10).map(I=>{const[E,W]=I.location.split(",").map(Number),{lng:L,lat:B}=xt(E,W),K=Ze(r.lng,r.lat,L,B);return{name:I.name,address:I.district||I.address||"",type:I.typecode||"",lng:L,lat:B,distance:K<1?`${Math.round(K*1e3)}m`:`${K.toFixed(1)}km`}})),h.length===0){const I=await(await fetch(`https://restapi.amap.com/v3/place/text?key=${ut}&keywords=${encodeURIComponent(s)}&offset=10&extensions=base`,{signal:l.signal})).json();I.status==="1"&&I.pois?.length>0&&(h=I.pois.map(E=>{const[W,L]=E.location.split(",").map(Number),{lng:B,lat:K}=xt(W,L),Q=Ze(r.lng,r.lat,B,K);return{name:E.name,address:(E.pname||"")+(E.cityname||"")+(E.adname||""),type:E.type||"",lng:B,lat:K,distance:Q<1?`${Math.round(Q*1e3)}m`:`${Q.toFixed(1)}km`}}))}if(h.length===0){const I=await(await fetch(`https://restapi.amap.com/v3/geocode/geo?key=${ut}&address=${encodeURIComponent(s)}`,{signal:l.signal})).json();I.status==="1"&&I.geocodes?.length>0&&(h=I.geocodes.map(E=>{const[W,L]=E.location.split(",").map(Number),{lng:B,lat:K}=xt(W,L),Q=Ze(r.lng,r.lat,B,K);return{name:E.formatted_address||s,address:(E.province||"")+(E.city||"")+(E.district||""),type:"region",lng:B,lat:K,distance:Q<1?`${Math.round(Q*1e3)}m`:`${Q.toFixed(1)}km`}}))}clearTimeout(p),Ee(h)}catch(r){r.name!=="AbortError"&&Ee([])}Mt(!1)},[Ze]);i.useEffect(()=>{st?_t(st):Ee([])},[st,_t]);const $t=i.useCallback(s=>{Nt(r=>{const l=r.filter(h=>h.name!==s.name),p=[{name:s.name,address:s.address,lng:s.lng,lat:s.lat},...l].slice(0,10);return localStorage.setItem("searchHistory",JSON.stringify(p)),p})},[]),us=i.useCallback(()=>{Nt([]),localStorage.removeItem("searchHistory")},[]);i.useCallback(async(s,r)=>{if(!window.electronAPI?.rotatePhoto)return!1;const l=await window.electronAPI.rotatePhoto(s,r);return l?(Y("success","ç…§ç‰‡å·²æ—‹è½¬"),X.delete(s),ze.delete(s.replace(/\.[^.]+$/,".webp"))):Y("error","æ—‹è½¬å¤±è´¥"),l},[Y]);const ms=i.useCallback(async(s,r)=>{if(!window.electronAPI?.cropPhoto)return!1;const l=await window.electronAPI.cropPhoto(s,r);return l?(Y("success","ç…§ç‰‡å·²è£å‰ª"),X.delete(s),ze.delete(s.replace(/\.[^.]+$/,".webp"))):Y("error","è£å‰ªå¤±è´¥"),l},[Y]),ps=s=>{tt(s),ce(-1),(s||Ae.length>0)&&ye(!0)},gs=()=>{(le||Ae.length>0)&&ye(!0)},fs=s=>{const r=le?nt:Ae;r.length&&(s.key==="ArrowDown"?(s.preventDefault(),ce(l=>Math.min(l+1,r.length-1))):s.key==="ArrowUp"?(s.preventDefault(),ce(l=>Math.max(l-1,-1))):s.key==="Enter"&&Be>=0?(s.preventDefault(),mt(r[Be])):s.key==="Escape"&&(ye(!1),Fe.current?.blur()))},mt=i.useCallback(s=>{if(P.current){let r=17;s.type==="region"||s.type?.includes("çœ")||s.type?.includes("å¸‚")?r=14:(s.type?.includes("åŒº")||s.type?.includes("å¿"))&&(r=15),P.current.flyTo({center:[s.lng,s.lat],zoom:r,duration:1500})}$t(s),ye(!1),tt(s.name),ce(-1)},[$t]),xs=()=>{je(!1),Et.current=!1,fe.current=null,ct(null)},ws=()=>{It([])},pt=!window.electronAPI||window.location.pathname.includes("index-web")||window.location.port==="3001"||window.location.hostname.includes("netlify")||window.location.hostname.includes("vercel");return console.log("App ç»„ä»¶æ¸²æŸ“ - Web ç‰ˆæœ¬:",pt,"å·²ç™»å½•:",o,"åœ°å›¾å·²åŠ è½½:",C),console.log("window.electronAPI:",window.electronAPI),console.log("å½“å‰URL:",window.location.href),n?e.jsxs("div",{className:`app ${pt?"web-app":""}`,children:[!o&&e.jsx(Jt,{onComplete:()=>{a(!0),u(!0)}}),e.jsx("div",{className:"window-drag-region"}),e.jsx("div",{ref:dt,className:`map-container ${G?"measure-mode":""}`}),!G&&e.jsxs("div",{className:"search-bar-container",children:[e.jsxs("div",{className:"search-bar",onClick:()=>Fe.current?.focus(),children:[e.jsx("span",{className:"search-icon",children:"ğŸ”"}),e.jsx("input",{type:"text",placeholder:"æœç´¢åœ°ç‚¹...",value:le,onChange:s=>ps(s.target.value),onFocus:gs,onKeyDown:fs,ref:Fe}),le&&e.jsx("button",{className:"search-clear",onClick:s=>{s.stopPropagation(),tt(""),Ee([]),ye(!1),ce(-1)},children:"âœ•"})]}),pt&&o&&e.jsx("div",{className:"web-download-beside-search",children:e.jsx(Ks,{})}),at&&e.jsx("div",{className:"search-results",children:es?e.jsxs("div",{className:"search-loading",children:[e.jsx("span",{className:"loading-spinner"}),"æœç´¢ä¸­..."]}):le&&nt.length>0?nt.map((s,r)=>e.jsxs("div",{className:`search-result-item ${Be===r?"selected":""}`,onClick:()=>mt(s),onMouseEnter:()=>ce(r),children:[e.jsx("span",{className:"result-icon",children:s.type?.includes("é¤é¥®")?"ğŸ½ï¸":s.type?.includes("é…’åº—")||s.type?.includes("ä½å®¿")?"ğŸ¨":s.type?.includes("é£æ™¯")||s.type?.includes("å…¬å›­")||s.type?.includes("æ—…æ¸¸")?"ğŸï¸":s.type?.includes("åŒ»ç–—")||s.type?.includes("åŒ»é™¢")?"ğŸ¥":s.type?.includes("å­¦æ ¡")||s.type?.includes("æ•™è‚²")?"ğŸ«":s.type?.includes("è´­ç‰©")||s.type?.includes("å•†åœº")?"ğŸ›’":s.type?.includes("äº¤é€š")||s.type?.includes("ç«™")||s.type?.includes("åœ°é“")?"ğŸš‰":s.type?.includes("é“¶è¡Œ")||s.type?.includes("é‡‘è")?"ğŸ¦":s.type?.includes("æ”¿åºœ")||s.type?.includes("æœºå…³")?"ğŸ›ï¸":s.type?.includes("å°åŒº")||s.type?.includes("ä½å®…")?"ğŸ˜ï¸":s.type?.includes("å†™å­—æ¥¼")||s.type?.includes("å…¬å¸")?"ğŸ¢":s.type?.includes("åœ°å")||s.type==="region"?"ğŸ—ºï¸":"ğŸ“"}),e.jsxs("div",{className:"result-info",children:[e.jsx("div",{className:"result-name",children:s.name}),e.jsx("div",{className:"result-address",children:s.address})]}),e.jsx("span",{className:"result-distance",children:s.distance})]},r)):le?e.jsxs("div",{className:"search-empty",children:['æœªæ‰¾åˆ° "',le,'" ç›¸å…³åœ°ç‚¹']}):Ae.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"search-history-header",children:[e.jsx("span",{children:"ğŸ• æœç´¢å†å²"}),e.jsx("button",{onClick:us,children:"æ¸…é™¤"})]}),Ae.map((s,r)=>e.jsxs("div",{className:`search-result-item history-item ${Be===r?"selected":""}`,onClick:()=>mt(s),onMouseEnter:()=>ce(r),children:[e.jsx("span",{className:"result-icon",children:"ğŸ•"}),e.jsxs("div",{className:"result-info",children:[e.jsx("div",{className:"result-name",children:s.name}),e.jsx("div",{className:"result-address",children:s.address})]})]},r))]}):e.jsx("div",{className:"search-tip",children:"è¾“å…¥åœ°åã€åœ°å€æœç´¢"})})]}),at&&e.jsx("div",{className:"search-overlay",onClick:()=>ye(!1)}),!Ve&&!y&&!x&&!ae&&!Ce&&!D&&!at&&!S&&!b&&e.jsxs("div",{className:"cursor-info",style:{left:Math.min(f.x+15,window.innerWidth-120),top:Math.max(f.y-35,10),opacity:f.x>0?1:0},children:[f.lat.toFixed(3),"Â°, ",f.lng.toFixed(3),"Â°"]}),!G&&e.jsxs("div",{className:"toolbar toolbar-left",children:[e.jsx("button",{onClick:cs,"data-tooltip":"å®šä½",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M12 2v4m0 12v4M2 12h4m12 0h4"})]})}),e.jsx("button",{onClick:()=>window.location.reload(),"data-tooltip":"åˆ·æ–°",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"}),e.jsx("path",{d:"M21 3v5h-5"}),e.jsx("path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"}),e.jsx("path",{d:"M3 21v-5h5"})]})})]}),!G&&e.jsxs("div",{className:"toolbar toolbar-right",children:[e.jsx("button",{onClick:ds,"data-tooltip":"æ”¾å¤§",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})}),e.jsx("button",{onClick:hs,"data-tooltip":"ç¼©å°",children:e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),e.jsx("button",{onClick:()=>Pt(!de),"data-tooltip":de?"å…³é—­çƒ­åŠ›å›¾":"çƒ­åŠ›å›¾",className:de?"active":"",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("circle",{cx:"12",cy:"12",r:"6",opacity:"0.5"}),e.jsx("circle",{cx:"12",cy:"12",r:"9",opacity:"0.25"})]})}),e.jsx("button",{onClick:async()=>{if(ee(U),re(!0),window.electronAPI){const s=await window.electronAPI.getCacheStats();Ne(s)}},"data-tooltip":"è®¾ç½®",className:"settings-btn",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"}),e.jsx("circle",{cx:"12",cy:"12",r:"3"})]})})]}),!G&&e.jsxs("button",{className:"marker-count-btn",onClick:()=>ie(!0),title:"æŸ¥çœ‹æ‰€æœ‰æ ‡è®°å’Œæœç´¢å¤‡æ³¨",children:["ğŸ“Œ ",c.length," Â· ğŸ“· ",At]}),Ce&&e.jsx("div",{className:"marker-list-overlay",onClick:()=>ie(!1),children:e.jsxs("div",{className:"marker-list-panel",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"marker-list-header",children:[e.jsx("h3",{children:"ğŸ“ æ‰€æœ‰æ ‡è®°"}),e.jsx("button",{className:"panel-close",onClick:()=>ie(!1),children:"âœ•"})]}),e.jsxs("div",{className:"marker-list-toolbar",children:[e.jsx("input",{type:"text",placeholder:"ğŸ” æœç´¢åœ°åæˆ–å¤‡æ³¨...",value:Pe,onChange:s=>{Xt(s.target.value),s.target.value.trim()&&window.electronAPI?.searchPhotos?(Qe(!0),window.electronAPI.searchPhotos(s.target.value).then(r=>{Ke(r||[]),Qe(!1)}).catch(()=>{Ke([]),Qe(!1)})):Ke([])},className:"marker-search"}),e.jsxs("div",{className:"sort-btns",children:[e.jsx("button",{className:Ye==="time"?"active":"",onClick:()=>kt("time"),children:"ğŸ• æ—¶é—´"}),e.jsx("button",{className:Ye==="name"?"active":"",onClick:()=>kt("name"),children:"ğŸ”¤ åœ°å"})]})]}),e.jsx("div",{className:"marker-list-content",children:(()=>{const s=c.filter(l=>Pe?(l.name||`${l.lat.toFixed(3)}Â°, ${l.lng.toFixed(3)}Â°`).toLowerCase().includes(Pe.toLowerCase()):!0).sort((l,p)=>{if(Ye==="time")return(p.createdAt||0)-(l.createdAt||0);{const h=l.name||"",w=p.name||"";return h.localeCompare(w,"zh-CN")}});if(ts)return[1,2,3,4].map(l=>e.jsxs("div",{className:"skeleton-list-item",children:[e.jsx("div",{className:"skeleton-list-thumb"}),e.jsxs("div",{className:"skeleton-list-info",children:[e.jsx("div",{className:"skeleton-text medium"}),e.jsx("div",{className:"skeleton-text short"})]})]},l));if(Pe){const l=s.length>0,p=Ie.length>0;return!l&&!p&&!jt?e.jsxs("div",{className:"marker-list-empty",children:['æœªæ‰¾åˆ°åŒ¹é… "',Pe,'" çš„ç»“æœ']}):e.jsxs("div",{className:"search-results-grouped",children:[l&&e.jsxs("div",{className:"result-group",children:[e.jsxs("div",{className:"result-group-title",children:["ğŸ“ æ ‡è®° (",s.length,")"]}),s.slice(0,10).map(h=>e.jsx(Zt,{marker:h,onClick:async()=>{ie(!1),P.current&&(P.current.flyTo({center:[h.lng,h.lat],zoom:15,duration:1e3}),setTimeout(async()=>{const w=P.current.project([h.lng,h.lat]);let v=h;if(window.electronAPI?.getMarkerDetail){const M=await window.electronAPI.getMarkerDetail(h.id);M&&(v=M)}g({x:w.x,y:w.y,marker:v})},1050))}},h.id)),s.length>10&&e.jsxs("div",{className:"result-more",children:["è¿˜æœ‰ ",s.length-10," ä¸ªç»“æœ..."]})]}),jt?e.jsxs("div",{className:"result-group",children:[e.jsx("div",{className:"result-group-title",children:"ğŸ“ å¤‡æ³¨"}),e.jsxs("div",{className:"marker-list-empty",children:[e.jsx("span",{className:"loading-spinner"})," æœç´¢ä¸­..."]})]}):p&&e.jsxs("div",{className:"result-group",children:[e.jsxs("div",{className:"result-group-title",children:["ğŸ“ å¤‡æ³¨ (",Ie.length,")"]}),Ie.slice(0,10).map((h,w)=>e.jsxs("div",{className:"marker-list-item note-item",onClick:async()=>{if(ie(!1),P.current&&P.current.flyTo({center:[h.lng,h.lat],zoom:15,duration:1e3}),window.electronAPI?.getMarkerDetail){const v=await window.electronAPI.getMarkerDetail(h.markerId);if(v){const M=v.photos.findIndex(I=>I.id===h.fileId);H({photos:v.photos,index:M>=0?M:0,markerId:h.markerId})}}},children:[e.jsx(wt,{photo:{id:h.fileId},className:"marker-list-thumb"}),e.jsxs("div",{className:"marker-list-info",children:[e.jsxs("div",{className:"marker-list-name",children:['"',h.note,'"']}),e.jsxs("div",{className:"marker-list-meta",children:["ğŸ“ ",h.markerName||`${h.lat.toFixed(3)}Â°, ${h.lng.toFixed(3)}Â°`]})]})]},`note-${w}`)),Ie.length>10&&e.jsxs("div",{className:"result-more",children:["è¿˜æœ‰ ",Ie.length-10," ä¸ªç»“æœ..."]})]})]})}if(s.length===0)return e.jsx("div",{className:"marker-list-empty",children:"æš‚æ— æ ‡è®°ï¼Œç‚¹å‡»åœ°å›¾æ·»åŠ "});const r=({index:l,style:p})=>{const h=s[l];return e.jsx("div",{style:p,children:e.jsx(Zt,{marker:h,onClick:async()=>{ie(!1),P.current&&(P.current.flyTo({center:[h.lng,h.lat],zoom:15,duration:1e3}),setTimeout(async()=>{const w=P.current.project([h.lng,h.lat]);let v=h;if(window.electronAPI?.getMarkerDetail){const M=await window.electronAPI.getMarkerDetail(h.id);M&&(v=M)}g({x:w.x,y:w.y,marker:v})},1050))}})})};return e.jsx(Ns,{height:550,itemCount:s.length,itemSize:80,width:"100%",overscanCount:3,children:r})})()})]})}),G&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"measure-hint",children:["ğŸ“ æµ‹é‡æ¨¡å¼ - ",ss?"ç‚¹å‡»é€‰æ‹©ç»ˆç‚¹":"ç‚¹å‡»é€‰æ‹©èµ·ç‚¹"]}),e.jsxs("div",{className:"measure-toolbar",children:[ns.length>0&&e.jsx("button",{onClick:ws,className:"measure-btn",children:"ğŸ—‘ï¸ æ¸…é™¤æµ‹é‡"}),e.jsx("button",{onClick:xs,className:"measure-btn exit",children:"âœ– é€€å‡ºæµ‹é‡æ¨¡å¼"})]})]}),ae&&e.jsx("div",{className:"settings-overlay",onClick:()=>{JSON.stringify(z)!==JSON.stringify(U)&&(window.confirm("è®¾ç½®å·²æ›´æ”¹ä½†æœªä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ")?(lt(z),localStorage.setItem("mapSettings",JSON.stringify(z))):ee(U)),re(!1)},children:e.jsxs("div",{className:"settings-panel",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"settings-nav",children:[e.jsxs("div",{className:"settings-nav-header",children:[e.jsx("span",{className:"nav-icon",children:"âš™ï¸"}),e.jsx("span",{className:"nav-title",children:"è®¾ç½®"})]}),e.jsxs("div",{className:"settings-nav-items",children:[e.jsxs("button",{className:O==="map"?"active":"",onClick:()=>xe("map"),children:[e.jsx("span",{children:"ğŸ—ºï¸"})," åœ°å›¾æ˜¾ç¤º"]}),e.jsxs("button",{className:O==="performance"?"active":"",onClick:()=>xe("performance"),children:[e.jsx("span",{children:"ğŸš€"})," æ€§èƒ½ä¼˜åŒ–"]}),e.jsxs("button",{className:O==="storage"?"active":"",onClick:()=>xe("storage"),children:[e.jsx("span",{children:"ğŸ’¾"})," å­˜å‚¨ç®¡ç†"]}),e.jsxs("button",{className:O==="about"?"active":"",onClick:()=>xe("about"),children:[e.jsx("span",{children:"â„¹ï¸"})," å…³äº"]})]})]}),e.jsxs("div",{className:"settings-content",children:[e.jsx("button",{className:"settings-close",onClick:()=>{JSON.stringify(z)!==JSON.stringify(U)&&(window.confirm("è®¾ç½®å·²æ›´æ”¹ä½†æœªä¿å­˜ï¼Œæ˜¯å¦ä¿å­˜ï¼Ÿ")?(lt(z),localStorage.setItem("mapSettings",JSON.stringify(z))):ee(U)),re(!1)},children:"âœ•"}),O==="map"&&e.jsxs("div",{className:"settings-page",children:[e.jsx("h2",{children:"ğŸ—ºï¸ åœ°å›¾æ˜¾ç¤º"}),e.jsx("p",{className:"page-desc",children:"è°ƒæ•´åœ°å›¾çš„æ˜¾ç¤ºæ•ˆæœå’Œäº¤äº’æ–¹å¼"}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"ç”»è´¨è®¾ç½®"}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"æŠ—é”¯é½¿"}),e.jsx("span",{children:"å¹³æ»‘åœ°å›¾è¾¹ç¼˜ï¼Œæå‡ç”»è´¨ä½†ä¼šå¢åŠ GPUè´Ÿæ‹…"})]}),e.jsxs("label",{className:"switch",children:[e.jsx("input",{type:"checkbox",checked:z.antialias,onChange:s=>ee(r=>({...r,antialias:s.target.checked}))}),e.jsx("span",{className:"slider"})]})]})]}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"äº¤äº’è®¾ç½®"}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"å…è®¸æ—‹è½¬"}),e.jsx("span",{children:"å³é”®æ‹–åŠ¨å¯æ—‹è½¬åœ°å›¾è§†è§’"})]}),e.jsxs("label",{className:"switch",children:[e.jsx("input",{type:"checkbox",checked:z.dragRotate,onChange:s=>ee(r=>({...r,dragRotate:s.target.checked}))}),e.jsx("span",{className:"slider"})]})]}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"ä¸–ç•Œå‰¯æœ¬"}),e.jsx("span",{children:"å·¦å³æ— é™æ»šåŠ¨ï¼Œæ˜¾ç¤ºå¤šä¸ªåœ°çƒå‰¯æœ¬"})]}),e.jsxs("label",{className:"switch",children:[e.jsx("input",{type:"checkbox",checked:z.renderWorldCopies,onChange:s=>ee(r=>({...r,renderWorldCopies:s.target.checked}))}),e.jsx("span",{className:"slider"})]})]})]}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"ç¼©æ”¾èŒƒå›´"}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"æœ€å°ç¼©æ”¾çº§åˆ«"}),e.jsx("span",{children:"æ•°å€¼è¶Šå°å¯ä»¥çœ‹åˆ°è¶Šå¤§èŒƒå›´"})]}),e.jsxs("div",{className:"range-control",children:[e.jsx("input",{type:"range",min:"0",max:"5",step:"1",value:z.minZoom,onChange:s=>ee(r=>({...r,minZoom:Number(s.target.value)}))}),e.jsx("span",{className:"range-value",children:z.minZoom})]})]}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"æœ€å¤§ç¼©æ”¾çº§åˆ«"}),e.jsx("span",{children:"æ•°å€¼è¶Šå¤§å¯ä»¥çœ‹åˆ°è¶Šè¯¦ç»†"})]}),e.jsxs("div",{className:"range-control",children:[e.jsx("input",{type:"range",min:"15",max:"22",step:"1",value:z.maxZoom,onChange:s=>ee(r=>({...r,maxZoom:Number(s.target.value)}))}),e.jsx("span",{className:"range-value",children:z.maxZoom})]})]})]})]}),O==="performance"&&e.jsxs("div",{className:"settings-page",children:[e.jsx("h2",{children:"ğŸš€ æ€§èƒ½ä¼˜åŒ–"}),e.jsx("p",{className:"page-desc",children:"è°ƒæ•´æ€§èƒ½å‚æ•°ä»¥è·å¾—æ›´æµç•…çš„ä½“éªŒ"}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"æ¸²æŸ“è®¾ç½®"}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"ç“¦ç‰‡æ·¡å…¥æ—¶é—´"}),e.jsx("span",{children:"åœ°å›¾ç“¦ç‰‡åŠ è½½æ—¶çš„æ·¡å…¥åŠ¨ç”»æ—¶é•¿ï¼Œ0ä¸ºç«‹å³æ˜¾ç¤º"})]}),e.jsxs("div",{className:"range-control wide",children:[e.jsx("input",{type:"range",min:"0",max:"500",step:"50",value:z.fadeDuration,onChange:s=>ee(r=>({...r,fadeDuration:Number(s.target.value)}))}),e.jsxs("span",{className:"range-value",children:[z.fadeDuration,"ms"]})]})]})]}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"ç¼“å­˜è®¾ç½®"}),e.jsxs("div",{className:"setting-row",children:[e.jsxs("div",{className:"setting-label",children:[e.jsx("strong",{children:"ç“¦ç‰‡ç¼“å­˜æ•°é‡"}),e.jsx("span",{children:"å†…å­˜ä¸­ç¼“å­˜çš„åœ°å›¾ç“¦ç‰‡æ•°é‡ï¼Œè¶Šå¤§è¶Šæµç•…ä½†å ç”¨æ›´å¤šå†…å­˜"})]}),e.jsxs("div",{className:"range-control wide",children:[e.jsx("input",{type:"range",min:"1000",max:"6000",step:"500",value:z.maxTileCacheSize,onChange:s=>ee(r=>({...r,maxTileCacheSize:Number(s.target.value)}))}),e.jsx("span",{className:"range-value",children:z.maxTileCacheSize})]})]})]}),e.jsxs("div",{className:"setting-tip",children:[e.jsx("span",{children:"ğŸ’¡"}),e.jsx("p",{children:"æ€§èƒ½è®¾ç½®ä¿®æ”¹åéœ€è¦é‡å¯åº”ç”¨æ‰èƒ½ç”Ÿæ•ˆã€‚å¦‚æœåœ°å›¾å¡é¡¿ï¼Œå¯ä»¥å°è¯•é™ä½ç“¦ç‰‡ç¼“å­˜æ•°é‡ã€‚"})]})]}),O==="storage"&&e.jsxs("div",{className:"settings-page",children:[e.jsx("h2",{children:"ğŸ’¾ å­˜å‚¨ç®¡ç†"}),e.jsx("p",{className:"page-desc",children:"æŸ¥çœ‹å’Œç®¡ç†åº”ç”¨æ•°æ®"}),e.jsxs("div",{className:"storage-cards",children:[e.jsxs("div",{className:"storage-card",children:[e.jsx("div",{className:"storage-icon",children:"ğŸ“"}),e.jsx("div",{className:"storage-value",children:c.length}),e.jsx("div",{className:"storage-label",children:"æ ‡è®°ç‚¹"})]}),e.jsxs("div",{className:"storage-card",children:[e.jsx("div",{className:"storage-icon",children:"ğŸ“·"}),e.jsx("div",{className:"storage-value",children:At}),e.jsx("div",{className:"storage-label",children:"ç…§ç‰‡"})]}),e.jsxs("div",{className:"storage-card",children:[e.jsx("div",{className:"storage-icon",children:"ğŸ—ºï¸"}),e.jsx("div",{className:"storage-value",children:Me.count}),e.jsx("div",{className:"storage-label",children:"ç¼“å­˜ç“¦ç‰‡"})]}),e.jsxs("div",{className:"storage-card",children:[e.jsx("div",{className:"storage-icon",children:"ğŸ“¦"}),e.jsx("div",{className:"storage-value",children:(Me.size/1024/1024).toFixed(1)}),e.jsx("div",{className:"storage-label",children:"MB ç¼“å­˜"})]})]}),e.jsxs("div",{className:"setting-group",children:[e.jsx("h3",{children:"æ•°æ®æ“ä½œ"}),e.jsxs("div",{className:"action-buttons",children:[e.jsxs("button",{className:"action-btn",onClick:async()=>{if(window.confirm("ç¡®å®šæ¸…é™¤æ‰€æœ‰ç“¦ç‰‡ç¼“å­˜ï¼Ÿè¿™ä¸ä¼šå½±å“ä½ çš„æ ‡è®°å’Œç…§ç‰‡ã€‚")){await window.electronAPI?.clearTileCache();const s=await window.electronAPI?.getCacheStats();s&&Ne(s)}},children:[e.jsx("span",{children:"ğŸ§¹"}),e.jsxs("div",{children:[e.jsx("strong",{children:"æ¸…é™¤ç“¦ç‰‡ç¼“å­˜"}),e.jsx("small",{children:"é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼Œä¸å½±å“æ ‡è®°æ•°æ®"})]})]}),e.jsxs("button",{className:"action-btn danger",onClick:async()=>{if(window.confirm("âš ï¸ ç¡®å®šåˆ é™¤æ‰€æœ‰æ ‡è®°å’Œç…§ç‰‡ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼")){for(const s of c)await window.electronAPI?.deleteMarker(s.id);m([])}},children:[e.jsx("span",{children:"ğŸ—‘ï¸"}),e.jsxs("div",{children:[e.jsx("strong",{children:"æ¸…é™¤æ‰€æœ‰æ•°æ®"}),e.jsx("small",{children:"åˆ é™¤æ‰€æœ‰æ ‡è®°å’Œç…§ç‰‡ï¼Œä¸å¯æ¢å¤"})]})]})]})]})]}),O==="about"&&e.jsxs("div",{className:"settings-page about-page",children:[e.jsxs("div",{className:"about-header",children:[e.jsx("div",{className:"about-icon",children:"ğŸ“"}),e.jsx("h1",{children:"åœ°å›¾ç›¸å†Œ"}),e.jsx("p",{className:"version",children:"ç‰ˆæœ¬ 1.0.0"})]}),e.jsx("p",{className:"about-desc",children:"åœ¨åœ°å›¾ä¸Šè®°å½•ä½ çš„æ—…è¡Œå›å¿†ï¼Œç”¨ç…§ç‰‡æ ‡è®°æ¯ä¸€ä¸ªå€¼å¾—çºªå¿µçš„åœ°ç‚¹ã€‚"}),e.jsxs("div",{className:"about-features",children:[e.jsxs("div",{className:"feature",children:[e.jsx("span",{children:"ğŸ—ºï¸"}),e.jsxs("div",{children:[e.jsx("strong",{children:"äº¤äº’å¼åœ°å›¾"}),e.jsx("small",{children:"åŸºäº Mapbox GL çš„æµç•…åœ°å›¾ä½“éªŒ"})]})]}),e.jsxs("div",{className:"feature",children:[e.jsx("span",{children:"ğŸ“·"}),e.jsxs("div",{children:[e.jsx("strong",{children:"ç…§ç‰‡ç®¡ç†"}),e.jsx("small",{children:"ä¸ºæ¯ä¸ªåœ°ç‚¹æ·»åŠ å¤šå¼ ç…§ç‰‡å’Œå¤‡æ³¨"})]})]}),e.jsxs("div",{className:"feature",children:[e.jsx("span",{children:"ğŸ”"}),e.jsxs("div",{children:[e.jsx("strong",{children:"æ™ºèƒ½æœç´¢"}),e.jsx("small",{children:"å¿«é€Ÿæœç´¢å…¨çƒä»»æ„åœ°ç‚¹"})]})]}),e.jsxs("div",{className:"feature",children:[e.jsx("span",{children:"ğŸ’¾"}),e.jsxs("div",{children:[e.jsx("strong",{children:"æœ¬åœ°å­˜å‚¨"}),e.jsx("small",{children:"æ•°æ®å®‰å…¨å­˜å‚¨åœ¨æœ¬åœ°"})]})]})]}),e.jsxs("div",{className:"dev-tools-section",children:[e.jsx("h3",{children:"ğŸ› ï¸ å¼€å‘è€…å·¥å…·"}),e.jsxs("div",{className:"dev-tools-btns",children:[e.jsxs("button",{onClick:()=>window.electronAPI?.openDevTools(),children:[e.jsx("span",{children:"ğŸ”§"})," æ‰“å¼€æ§åˆ¶å°"]}),e.jsxs("button",{onClick:()=>window.electronAPI?.openLogFolder(),children:[e.jsx("span",{children:"ğŸ“"})," æ‰“å¼€æ—¥å¿—ç›®å½•"]})]})]}),e.jsx("div",{className:"about-footer",children:e.jsx("p",{children:"ä½¿ç”¨ Electron + React + Mapbox GL æ„å»º"})})]}),(O==="map"||O==="performance")&&e.jsxs("div",{className:"settings-footer",children:[e.jsx("button",{className:"save-btn",disabled:JSON.stringify(z)===JSON.stringify(U),onClick:()=>{lt(z),localStorage.setItem("mapSettings",JSON.stringify(z)),re(!1)},children:"ä¿å­˜è®¾ç½®"}),e.jsx("p",{className:"save-hint",children:JSON.stringify(z)!==JSON.stringify(U)?"* è®¾ç½®å·²æ›´æ”¹ï¼Œç‚¹å‡»ä¿å­˜ç”Ÿæ•ˆ":"éƒ¨åˆ†è®¾ç½®éœ€è¦é‡å¯åº”ç”¨åç”Ÿæ•ˆ"})]})]})]})}),y&&e.jsxs("div",{className:`context-menu ${Xe?"drag-over":""}`,style:{left:Math.min(y.x,window.innerWidth-280),top:Math.min(y.y,window.innerHeight-200)},onDragEnter:s=>{s.preventDefault(),s.stopPropagation(),Oe(!0)},onDragOver:s=>{s.preventDefault(),s.stopPropagation(),s.dataTransfer.dropEffect="copy",Oe(!0)},onDragLeave:s=>{s.preventDefault(),s.stopPropagation(),s.currentTarget.contains(s.relatedTarget)||Oe(!1)},onDrop:async s=>{s.preventDefault(),s.stopPropagation(),Oe(!1);const r=Array.from(s.dataTransfer.files).filter(v=>v.type.startsWith("image/"));if(r.length===0)return;const p=(await Promise.all(r.map(v=>new Promise(M=>{const I=new FileReader;I.onload=async E=>{if(window.electronAPI){const W=await window.electronAPI.savePhotoFromBase64(E.target.result);M(W?{id:W.id,note:""}:null)}else M({data:E.target.result,note:""})},I.readAsDataURL(v)})))).filter(v=>v);if(p.length===0)return;const h=await Rt(y.latlng.lat,y.latlng.lng),w={id:Ot(),lat:y.latlng.lat,lng:y.latlng.lng,name:h,photos:p,createdAt:Date.now()};window.electronAPI&&await window.electronAPI.addMarker(w),qe(v=>new Set(v).add(w.id)),setTimeout(()=>qe(v=>{const M=new Set(v);return M.delete(w.id),M}),600),he(),N(null),_(null)},children:[e.jsx("button",{className:"menu-close",onClick:zt,children:"âœ•"}),e.jsxs("div",{className:"context-menu-header",children:[e.jsxs("div",{className:"place-name",children:["ğŸ“ ",q]}),e.jsxs("div",{className:"coords",children:["ğŸŒ ",y.latlng.lat.toFixed(3),"Â°, ",y.latlng.lng.toFixed(3),"Â°"]})]}),e.jsx("div",{className:"menu-actions",children:e.jsxs("div",{className:`add-photo-zone ${Xe?"drag-active":""}`,onClick:()=>os(y.latlng),children:[e.jsx("span",{className:"zone-icon",children:Xe?"ğŸ“¥":"ğŸ“·"}),e.jsx("span",{className:"zone-text",children:"ç‚¹å‡»é€‰æ‹©ç…§ç‰‡"}),e.jsx("span",{className:"zone-hint",children:"æˆ–æ‹–æ‹½ç…§ç‰‡åˆ°è¿™é‡Œ"})]})})]}),x&&e.jsxs("div",{className:`context-menu ${et?"drag-over":""}`,style:{left:Math.min(x.x,window.innerWidth-280),top:Math.min(x.y,window.innerHeight-320)},onDragEnter:s=>{s.preventDefault(),s.stopPropagation(),Ue(!0)},onDragOver:s=>{s.preventDefault(),s.stopPropagation(),s.dataTransfer.dropEffect="copy",Ue(!0)},onDragLeave:s=>{s.preventDefault(),s.stopPropagation(),s.currentTarget.contains(s.relatedTarget)||Ue(!1)},onDrop:async s=>{s.preventDefault(),s.stopPropagation(),Ue(!1);const r=Array.from(s.dataTransfer.files).filter(w=>w.type.startsWith("image/"));if(r.length===0)return;const p=(await Promise.all(r.map(w=>new Promise(v=>{const M=new FileReader;M.onload=async I=>{if(window.electronAPI){const E=await window.electronAPI.savePhotoFromBase64(I.target.result);v(E?{id:E.id,note:""}:null)}else v({data:I.target.result,note:""})},M.readAsDataURL(w)})))).filter(w=>w);if(p.length===0)return;const h=x;if(window.electronAPI){await window.electronAPI.addPhotosToMarker(h.marker.id,p);const w=await window.electronAPI.getMarkerDetail(h.marker.id);w&&g({...h,marker:w}),he()}},children:[e.jsx("button",{className:"menu-close",onClick:()=>g(null),children:"âœ•"}),e.jsxs("div",{className:"context-menu-header",children:[e.jsxs("div",{className:"place-name",children:["ğŸ“ ",x.marker.name||`${x.marker.lat.toFixed(3)}Â°, ${x.marker.lng.toFixed(3)}Â°`]}),e.jsxs("div",{className:"meta-row",children:[e.jsxs("span",{className:"coords",children:[x.marker.lat.toFixed(3),"Â°, ",x.marker.lng.toFixed(3),"Â°"]}),e.jsxs("span",{className:"photo-count",children:["ğŸ“· ",x.marker.photos?.length||0," å¼ "]})]})]}),e.jsxs("div",{className:"menu-actions",children:[e.jsxs("div",{className:"menu-actions-primary",children:[x.marker.photos?.length>0&&e.jsxs("button",{className:"menu-btn primary view",onClick:()=>{H({photos:x.marker.photos,index:0,markerId:x.marker.id,returnToMenu:x}),g(null)},children:[e.jsx("span",{className:"btn-icon",children:"ğŸ–¼ï¸"}),e.jsx("span",{children:"æŸ¥çœ‹ç…§ç‰‡"})]}),e.jsxs("button",{className:`menu-btn primary add ${et?"drag-active":""}`,onClick:async()=>{if(!window.electronAPI)return;const s=x,r=await window.electronAPI.selectPhotos();if(r?.length>0){await window.electronAPI.addPhotosToMarker(s.marker.id,r.map(p=>({id:p.id,note:""})));const l=await window.electronAPI.getMarkerDetail(s.marker.id);l&&g({...s,marker:l}),he()}},children:[e.jsx("span",{className:"btn-icon",children:et?"ğŸ“¥":"â•"}),e.jsx("span",{children:"æ·»åŠ ç…§ç‰‡"})]})]}),x.marker.photos?.length>0&&e.jsxs("button",{className:"menu-btn note",onClick:()=>{F({markerId:x.marker.id,marker:x.marker,returnToMenu:x}),g(null)},children:[e.jsx("span",{className:"btn-icon",children:"ğŸ“"}),e.jsx("span",{children:"å¤‡æ³¨"})]}),e.jsxs("button",{className:"menu-btn danger",onClick:()=>{ls(x.marker.id),g(null)},children:[e.jsx("span",{className:"btn-icon",children:"ğŸ—‘ï¸"}),e.jsx("span",{children:"åˆ é™¤æ ‡è®°"})]})]})]}),(y||x)&&e.jsx("div",{className:"context-overlay",onClick:zt}),D&&e.jsx(zs,{photoViewer:D,setPhotoViewer:H,currentPhotoUrl:_e,getPhotoNote:ht,markers:c,setMarkerMenu:g,refreshMarkers:he,setPhotoEditor:ot}),b&&e.jsx("div",{className:"note-editor-overlay",onClick:()=>{if(b.returnToViewer)H(b.returnToViewer);else if(b.returnToMenu){const s=c.find(r=>r.id===b.markerId);s&&g({...b.returnToMenu,marker:s})}R(null)},children:e.jsxs("div",{className:"note-editor",onClick:s=>s.stopPropagation(),children:[e.jsx("h3",{children:"ğŸ“ ç¼–è¾‘å¤‡æ³¨"}),e.jsx("textarea",{value:b.note,onChange:s=>R({...b,note:s.target.value}),placeholder:"è¾“å…¥ç…§ç‰‡å¤‡æ³¨...",autoFocus:!0}),e.jsxs("div",{className:"note-editor-btns",children:[e.jsx("button",{onClick:()=>{if(b.returnToViewer)H(b.returnToViewer);else if(b.returnToMenu){const s=c.find(r=>r.id===b.markerId);s&&g({...b.returnToMenu,marker:s})}R(null)},children:"å–æ¶ˆ"}),e.jsx("button",{className:"save",onClick:()=>{is(b.markerId,b.photoIndex,b.note);const s=c.find(r=>r.id===b.markerId);if(s){const r=[...s.photos];if(typeof r[b.photoIndex]=="string"?r[b.photoIndex]={data:r[b.photoIndex],note:b.note}:r[b.photoIndex]={...r[b.photoIndex],note:b.note},b.returnToViewer)H({...b.returnToViewer,photos:r});else if(b.returnToMenu){const l={...s,photos:r};g({...b.returnToMenu,marker:l})}}},children:"ä¿å­˜"})]})]})}),S&&e.jsx("div",{className:"notes-panel-overlay",onClick:async()=>{if(!oe){if(S.returnToMenu)if(window.electronAPI?.getMarkerDetail){const s=await window.electronAPI.getMarkerDetail(S.markerId);s&&g({...S.returnToMenu,marker:s})}else{const s=c.find(r=>r.id===S.markerId);s&&g({...S.returnToMenu,marker:s})}F(null)}},children:e.jsxs("div",{className:"notes-panel",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"notes-panel-header",children:[e.jsx("h3",{children:"ğŸ“ ç…§ç‰‡å¤‡æ³¨"}),e.jsxs("div",{className:"header-actions",children:[oe?e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cancel-btn",onClick:()=>{J(!1),Z([])},children:"å–æ¶ˆ"}),e.jsx("button",{className:"save-btn",onClick:async()=>{if(window.electronAPI?.batchUpdatePhotoNotes)await window.electronAPI.batchUpdatePhotoNotes(S.markerId,V);else if(window.electronAPI)for(let s=0;s<V.length;s++)await window.electronAPI.updatePhotoNote(S.markerId,s,V[s]||"");if(J(!1),Z([]),Y("success","å¤‡æ³¨å·²ä¿å­˜"),window.electronAPI){const s=await window.electronAPI.getMarkerDetail(S.markerId);s&&F(r=>({...r,marker:s}))}},children:"ğŸ’¾ ä¿å­˜"})]}):e.jsx("button",{className:"edit-btn",onClick:()=>{const s=c.find(r=>r.id===S.markerId)?.photos||[];Z(s.map(r=>ht(r))),J(!0)},children:"âœï¸ ç¼–è¾‘"}),e.jsx("button",{className:"panel-close",onClick:async()=>{if(S.returnToMenu)if(window.electronAPI?.getMarkerDetail){const s=await window.electronAPI.getMarkerDetail(S.markerId);s&&g({...S.returnToMenu,marker:s})}else{const s=c.find(r=>r.id===S.markerId);s&&g({...S.returnToMenu,marker:s})}J(!1),Z([]),F(null)},children:"âœ•"})]})]}),e.jsx("div",{className:"notes-list",children:(c.find(s=>s.id===S.markerId)?.photos||[]).map((s,r)=>e.jsxs("div",{className:"note-item",children:[e.jsx(wt,{photo:s,className:"note-thumb",alt:`ç…§ç‰‡${r+1}`}),e.jsxs("div",{className:"note-content",children:[e.jsxs("div",{className:"note-label",children:["ç…§ç‰‡ ",r+1]}),oe?e.jsx("textarea",{value:V[r]||"",onChange:l=>{const p=[...V];p[r]=l.target.value,Z(p)},placeholder:"è¾“å…¥å¤‡æ³¨..."}):e.jsx("div",{className:"note-text",children:ht(s)||"æš‚æ— å¤‡æ³¨"})]})]},r))})]})}),We&&e.jsx(_s,{photoEditor:We,setPhotoEditor:ot,setPhotoViewer:H,cropPhoto:ms,refreshMarkers:he}),Te&&e.jsxs("div",{className:`feedback-toast ${Te.type}`,children:[e.jsx("span",{className:"toast-icon",children:Te.type==="success"?"âœ“":Te.type==="error"?"âœ•":"â„¹"}),Te.message]}),e.jsx($s,{})]}):e.jsx(Jt,{onComplete:()=>{a(!0),u(!0)}})}const en=()=>e.jsx(Os,{name:"App",title:"åº”ç”¨é‡åˆ°äº†é—®é¢˜",message:"åœ°å›¾ç›¸å†Œé‡åˆ°äº†æ„å¤–é”™è¯¯ï¼Œè¯·å°è¯•åˆ·æ–°é¡µé¢ã€‚å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒã€‚",children:e.jsx(Bs,{children:e.jsx(Us,{children:e.jsx(Xs,{})})})});class Qt{constructor(){this.isWeb=!0,this.isElectron=!1,this.selectPhotos=this.selectPhotos.bind(this),this.getPhotoUrl=this.getPhotoUrl.bind(this),this.getThumbnailUrl=this.getThumbnailUrl.bind(this),this.generateThumbnail=this.generateThumbnail.bind(this),this.storePhoto=this.storePhoto.bind(this),this.getStoredPhoto=this.getStoredPhoto.bind(this),this.loadMarkers=this.loadMarkers.bind(this),this.saveMarkers=this.saveMarkers.bind(this),this.addMarker=this.addMarker.bind(this),this.updateMarker=this.updateMarker.bind(this),this.deleteMarker=this.deleteMarker.bind(this),this.addPhotosToMarker=this.addPhotosToMarker.bind(this),this.deletePhotoFromMarker=this.deletePhotoFromMarker.bind(this),this.getMarkerPhotos=this.getMarkerPhotos.bind(this),this.getPhotoInfo=this.getPhotoInfo.bind(this)}async selectPhotos(){return new Promise(t=>{const n=document.createElement("input");n.type="file",n.multiple=!0,n.accept="image/*",n.onchange=async a=>{const o=Array.from(a.target.files),u=[];for(const c of o){const m=crypto.randomUUID()+"."+c.name.split(".").pop(),f=new FileReader,k=await new Promise(y=>{f.onload=()=>y(f.result),f.readAsDataURL(c)});u.push({id:m,data:k,name:c.name,size:c.size})}t(u)},n.click()})}async getPhotoUrl(t){return(await this.getStoredPhoto(t))?.data||null}async getThumbnailUrl(t){const n=await this.getStoredPhoto(t);return n?.data?this.generateThumbnail(n.data):null}async generateThumbnail(t,n=200){return new Promise(a=>{const o=new Image;o.onload=()=>{const u=document.createElement("canvas"),c=u.getContext("2d"),m=Math.min(n/o.width,n/o.height);u.width=o.width*m,u.height=o.height*m,c.drawImage(o,0,0,u.width,u.height),a(u.toDataURL("image/webp",.8))},o.src=t})}async storePhoto(t){return new Promise((n,a)=>{const o=indexedDB.open("PhotoMapDB",1);o.onerror=()=>a(o.error),o.onsuccess=()=>{const c=o.result.transaction(["photos"],"readwrite");c.objectStore("photos").put(t),c.oncomplete=()=>n(!0),c.onerror=()=>a(c.error)},o.onupgradeneeded=()=>{const u=o.result;u.objectStoreNames.contains("photos")||u.createObjectStore("photos",{keyPath:"id"})}})}async getStoredPhoto(t){return new Promise((n,a)=>{const o=indexedDB.open("PhotoMapDB",1);o.onerror=()=>a(o.error),o.onsuccess=()=>{const f=o.result.transaction(["photos"],"readonly").objectStore("photos").get(t);f.onsuccess=()=>n(f.result),f.onerror=()=>a(f.error)}})}async loadMarkers(){try{const t=localStorage.getItem("photo-map-markers");return t?JSON.parse(t):[]}catch{return[]}}async saveMarkers(t){try{return localStorage.setItem("photo-map-markers",JSON.stringify(t)),!0}catch{return!1}}async addMarker(t){try{const n=await this.loadMarkers();return n.push(t),await this.saveMarkers(n),t}catch(n){return console.error("æ·»åŠ æ ‡è®°å¤±è´¥:",n),null}}async updateMarker(t){try{const n=await this.loadMarkers(),a=n.findIndex(o=>o.id===t.id);return a!==-1&&(n[a]={...n[a],...t},await this.saveMarkers(n)),!0}catch(n){return console.error("æ›´æ–°æ ‡è®°å¤±è´¥:",n),!1}}async deleteMarker(t){try{const a=(await this.loadMarkers()).filter(o=>o.id!==t);return await this.saveMarkers(a),!0}catch(n){return console.error("åˆ é™¤æ ‡è®°å¤±è´¥:",n),!1}}async addPhotosToMarker({markerId:t,photos:n}){try{const a=await this.loadMarkers(),o=a.find(u=>u.id===t);if(o){o.photos||(o.photos=[]),o.photos.push(...n),o.photoCount=o.photos.length,!o.firstPhoto&&n.length>0&&(o.firstPhoto=n[0]),await this.saveMarkers(a);for(const u of n)await this.storePhoto(u)}return!0}catch(a){return console.error("æ·»åŠ ç…§ç‰‡å¤±è´¥:",a),!1}}async deletePhotoFromMarker({markerId:t,photoIndex:n}){try{const a=await this.loadMarkers(),o=a.find(u=>u.id===t);return o&&o.photos&&(o.photos.splice(n,1),o.photoCount=o.photos.length,o.firstPhoto=o.photos[0]||null,await this.saveMarkers(a)),!0}catch(a){return console.error("åˆ é™¤ç…§ç‰‡å¤±è´¥:",a),!1}}async getMarkerPhotos(t){try{return(await this.loadMarkers()).find(o=>o.id===t)?.photos||[]}catch{return[]}}async getPhotoInfo(t){return await this.getStoredPhoto(t)||null}async rotatePhoto({photoId:t,degrees:n}){const a=await this.getStoredPhoto(t);if(!a?.data)return!1;const o=await this.rotateImageData(a.data,n);return a.data=o,await this.storePhoto(a),!0}async cropPhoto({photoId:t,crop:n}){const a=await this.getStoredPhoto(t);if(!a?.data)return!1;const o=await this.cropImageData(a.data,n);return a.data=o,await this.storePhoto(a),!0}async rotateImageData(t,n){return new Promise(a=>{const o=new Image;o.onload=()=>{const u=document.createElement("canvas"),c=u.getContext("2d");n===90||n===270?(u.width=o.height,u.height=o.width):(u.width=o.width,u.height=o.height),c.translate(u.width/2,u.height/2),c.rotate(n*Math.PI/180),c.drawImage(o,-o.width/2,-o.height/2),a(u.toDataURL("image/jpeg",.92))},o.src=t})}async cropImageData(t,n){return new Promise(a=>{const o=new Image;o.onload=()=>{const u=document.createElement("canvas"),c=u.getContext("2d");u.width=n.width,u.height=n.height,c.drawImage(o,n.x,n.y,n.width,n.height,0,0,n.width,n.height),a(u.toDataURL("image/jpeg",.92))},o.src=t})}async log({level:t,message:n}){console[t]("[PhotoMap]",n)}async getCacheStats(){return{count:0,size:0,path:"IndexedDB"}}}typeof window<"u"&&(window.electronAPI=new Qt);const tn=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));new Qt;Es.createRoot(document.getElementById("root")).render(e.jsx(Vt.StrictMode,{children:e.jsx(en,{})}));export{e as j};
