# 地图相册 - 优化与功能待办清单

> 每完成一项标记为 [x]

## 优先级说明

| 标记 | 含义 | 建议 |
|------|------|------|
| 🔴 | 关键 - 影响核心体验 | 优先处理 |
| 🟠 | 重要 - 明显改善体验 | 尽快处理 |
| 🟡 | 建议 - 锦上添花 | 有空再做 |

---

## 已完成

### 性能优化
- [x] 虚拟滚动 - 标记列表使用 react-window
- [x] 图片懒加载 - IntersectionObserver 精确控制
- [x] WebP 缩略图 - sharp 转换，体积减少 50%
- [x] 渐进式加载 - 先模糊占位图再高清
- [x] React.memo - 避免组件重复渲染
- [x] useDeferredValue - 搜索输入防抖
- [x] SQLite 索引 - lat/lng 复合索引
- [x] WAL 模式 - 提升数据库并发性能
- [x] GPU 加速 - CSS transform/will-change
- [x] 代码分割 - 懒加载组件

### 功能
- [x] 照片搜索 - 按备注内容搜索
- [x] 照片编辑 - 裁剪/旋转
- [x] 热力图模式 - 照片密度可视化
- [x] 标记入场动画
- [x] 骨架屏加载
- [x] 日志系统 - electron-log
- [x] 错误边界 - ErrorBoundary

---

## 性能优化

### 渲染性能
- [ ] 🔴 Canvas 标记渲染 - 超过 200 个标记时使用 Canvas/WebGL 替代 DOM
- [ ] 🟠 标记聚合优化 - 使用 Supercluster 在 Worker 中计算
- [ ] 🟡 帧率控制 - requestAnimationFrame 节流地图事件

### 内存优化（当前约 550MB，目标 300MB 以下）
- [x] 🟠 照片缓存清理 - LRU 策略，限制缓存数量（原图15张、缩略图50张）
- [x] 🟡 WeakMap 缓存 - 使用 Map + LRU 策略避免内存泄漏
- [x] 🔴 Blob URL 及时释放 - LRU 缓存淘汰时调用 revokeObjectURL 释放内存
- [x] 🟠 组件卸载清理 - 照片查看器、编辑器关闭时清理相关缓存
- [x] 🟡 定时内存清理 - 每 5 分钟检查并清理未使用的缓存
- [x] 🟠 减少 LRU 缓存容量 - 原图从 30 张减到 15 张，缩略图从 100 张减到 50 张
- [x] 🟡 内存监控面板 - 开发模式显示实时内存占用，便于排查问题
- [ ] 🟠 地图瓦片缓存限制 - 限制 Mapbox 瓦片内存缓存数量，超出时清理旧瓦片
- [x] 🟠 图片解码优化 - 使用 createImageBitmap 替代 Image 对象，减少内存占用
- [x] 🟠 Sharp 处理优化 - 处理完成后及时释放 Buffer，避免内存堆积
- [ ] 🟡 大图流式加载 - 超大照片分块加载

### 启动优化
- [x] 🟠 延迟初始化 - 非关键模块延迟加载（crypto/store/db/sharp/exif-parser）
- [x] 🟡 预编译模板 - V8 编译缓存加速启动
- [x] 🟡 数据库预热 - 启动时预加载常用数据

### 数据库优化
- [x] 🟡 查询缓存 - 缓存常用查询结果（5秒有效期，自动失效）
- [x] 🟡 批量更新 - 合并多次写操作（500ms 延迟批量执行）

---

## 功能增强

### 照片管理
- [ ] 🟠 批量导入 - 从文件夹导入带 GPS 的照片
- [ ] 🟠 EXIF 信息 - 显示拍摄时间、相机、光圈等
- [ ] 🟡 批量选择 - 多选照片删除/移动
- [ ] 🟡 照片排序 - 拖拽调整顺序
- [ ] 🟡 原图导出 - 导出到指定文件夹
- [ ] 重复检测 - 检测并清理重复照片

### 标记管理
- [ ] 🟠 标记分组 - 按旅行/项目分组
- [ ] 🟡 标记标签 - 自定义标签筛选
- [ ] 🟡 标记合并 - 合并相近位置的标记
- [ ] 标记颜色 - 按类别显示不同颜色
- [ ] 标记图标 - 自定义标记图标

### 地图功能
- [ ] 🟠 离线地图 - 下载区域供离线使用
- [ ] 🟡 底图切换 - 卫星/街道/暗色切换
- [ ] 🟡 轨迹绘制 - 连接标记形成旅行轨迹
- [ ] 地图截图 - 导出当前地图视图

### 数据管理
- [ ] 🟠 数据备份 - 自动定期备份
- [ ] 🟠 数据导出 - JSON/GeoJSON/KML 格式
- [ ] 🟡 数据导入 - 从其他应用导入
- [ ] 🟡 云同步 - WebDAV/坚果云同步
- [ ] 数据统计 - 总里程、城市数、趋势图

### 搜索增强
- [ ] 🟡 高级搜索 - 按时间范围、地区筛选
- [ ] 🟡 搜索历史 - 记录最近搜索
- [ ] 模糊搜索 - 支持拼音/首字母搜索

---

## 界面优化

### 视觉效果
- [ ] 🟡 深色模式 - 夜间主题
- [ ] 🟡 主题色 - 自定义强调色
- [ ] 照片墙 - 网格瀑布流展示
- [ ] 幻灯片 - 自动播放照片
- [ ] 时间轴 - 按时间线展示

### 交互优化
- [x] 🟡 快捷键 - 键盘快捷操作
- [x] 🟡 手势支持 - 双指缩放、滑动切换
- [ ] 拖拽上传 - 拖拽照片到地图添加
- [ ] 右键菜单 - 更多操作选项

### 信息展示
- [x] 🟡 照片信息面板 - 详细信息侧边栏
- [ ] 地点天气 - 显示标记位置天气
- [ ] 距离显示 - 标记间距离

---

## 技术改进

### 代码质量
- [x] 🟡 TypeScript - 类型安全（已添加类型定义和核心模块）
- [ ] 🟡 完整 TS 迁移 - 将所有 .jsx 文件迁移为 .tsx
- [ ] 🟡 组件文档 - Storybook 组件库
- [ ] 🟡 ESLint + Prettier - 代码规范和格式化
- [ ] 提交规范 - Husky + lint-staged
- [x] 路径别名 - 使用 @/ 替代相对路径（@components/@utils/@store/@types）

### 构建工具 (Vite)
- [x] 🟠 迁移到 Vite - 替代 Create React App，启动速度提升 10 倍
- [x] 🟠 依赖预构建优化 - 配置 optimizeDeps 加速冷启动
- [x] 🟡 构建分析 - rollup-plugin-visualizer 分析包体积（npm run build:analyze）
- [x] 🟡 Chunk 分割策略 - manualChunks 优化加载顺序（react-vendor/utils-vendor/virtual-scroll）
- [x] 🟡 CSS 代码分割 - 按组件拆分 CSS（cssCodeSplit: true）
- [ ] 🟡 动态导入优化 - 路由级别代码分割
- [ ] Gzip/Brotli 压缩 - vite-plugin-compression 预压缩
- [ ] Legacy 兼容 - @vitejs/plugin-legacy 支持旧浏览器

### 打包优化
- [ ] 🟠 安装包瘦身 - 排除不必要依赖
- [ ] 🟡 增量更新 - electron-updater 差量更新
- [ ] 资源压缩 - 图片/字体压缩
- [ ] Tree Shaking 优化 - 确保未使用代码被移除

### 安全加固
- [x] 🟠 CSP 策略 - Content Security Policy（已配置完整 CSP 头）
- [x] 输入校验 - 防止注入攻击（validation.ts 工具模块）
- [x] 依赖审计 - npm audit 检查（npm run audit/audit:fix/audit:report）

### 测试完善 (Vitest)
- [x] 🟡 迁移到 Vitest - 替代 Jest，与 Vite 生态统一
- [ ] 🟡 单元测试 - 核心功能测试
- [ ] 🟡 组件测试 - React Testing Library
- [ ] E2E 测试 - Playwright 关键流程测试
- [ ] 测试覆盖率 - 目标 80% 以上
- [ ] 性能测试 - 基准测试监控

---

## 创新功能

### AI 智能（本地运行）
- [ ] 照片描述 - AI 自动生成描述
- [ ] 场景分类 - 识别美食/风景/人物
- [ ] 文字识别 - OCR 识别照片文字
- [ ] 智能标签 - 自动打标签

### 数据可视化
- [ ] 年度报告 - 旅行年度总结
- [ ] 足迹动画 - 按时间播放轨迹
- [ ] 3D 地球 - 3D 展示足迹
- [ ] 统计图表 - 旅行数据可视化

### 社交分享
- [ ] 分享图片 - 生成精美分享图
- [ ] 旅行报告 - PDF 旅行总结
- [ ] 足迹地图 - 去过的省份/国家

### 游戏化
- [ ] 成就系统 - 解锁旅行成就
- [ ] 探索进度 - 省份/国家完成度
- [ ] 旅行等级 - 根据足迹升级

---

## 已知问题

- [ ] 🔴 运行时内存占用过高（约 550MB），需要优化到 300MB 以下
- [ ] 🔴 大量标记（500+）时地图卡顿
- [ ] 照片查看器缩放后切换不重置（有归位按钮）
- [ ] 热力图在极低缩放时显示不明显

---

## 近期计划

### v1.1 版本目标
1. 批量导入带 GPS 照片
2. EXIF 信息展示
3. 数据备份/导出
4. 深色模式

### v1.2 版本目标
1. 离线地图下载
2. 标记分组/标签
3. 轨迹绘制
4. 快捷键支持

---

最后更新: 2024-12-18
构建工具迁移: CRA 到 Vite + Vitest
类型系统: 添加 TypeScript 支持
待解决: 内存占用优化（550MB 到 300MB）
