# GitHub Actions å¤šå¹³å°æ„å»ºå’Œå‘å¸ƒå·¥ä½œæµ
# 
# è§¦å‘æ¡ä»¶ï¼š
# - æ¨é€å¸¦æœ‰ v* æ ‡ç­¾æ—¶è‡ªåŠ¨æ„å»ºå‘å¸ƒ
# - æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
#
# æ„å»ºå¹³å°ï¼š
# - Windows (x64)
# - macOS (x64, arm64)
# - Linux (x64)

name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: false
        default: ''

# è®¾ç½®æƒé™
permissions:
  contents: write

jobs:
  # ========== æ„å»º Windows ç‰ˆæœ¬ ==========
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: é‡å»ºåŸç”Ÿæ¨¡å—
        run: npm run rebuild
        
      - name: æ„å»ºå‰ç«¯
        run: npm run build
        
      - name: æ„å»º Windows å®‰è£…åŒ…
        run: npm run dist -- --win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ä¸Šä¼  Windows æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/*.exe
            dist/*.zip
            dist/latest.yml
          retention-days: 5

  # ========== æ„å»º macOS ç‰ˆæœ¬ ==========
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: é‡å»ºåŸç”Ÿæ¨¡å—
        run: npm run rebuild
        
      - name: æ„å»ºå‰ç«¯
        run: npm run build
        
      # ä»£ç ç­¾åï¼ˆéœ€è¦é…ç½®è¯ä¹¦ï¼‰
      - name: å¯¼å…¥ä»£ç ç­¾åè¯ä¹¦
        if: env.CSC_LINK != ''
        env:
          CSC_LINK: ${{ secrets.MAC_CERTS }}
          CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
        run: |
          echo "ä»£ç ç­¾åè¯ä¹¦å·²é…ç½®"
          
      - name: æ„å»º macOS å®‰è£…åŒ…
        run: npm run dist -- --mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.MAC_CERTS }}
          CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          
      - name: ä¸Šä¼  macOS æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            dist/*.dmg
            dist/*.zip
            dist/latest-mac.yml
          retention-days: 5

  # ========== æ„å»º Linux ç‰ˆæœ¬ ==========
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y libarchive-tools rpm
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: é‡å»ºåŸç”Ÿæ¨¡å—
        run: npm run rebuild
        
      - name: æ„å»ºå‰ç«¯
        run: npm run build
        
      - name: æ„å»º Linux å®‰è£…åŒ…
        run: npm run dist -- --linux
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ä¸Šä¼  Linux æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/latest-linux.yml
          retention-days: 5

  # ========== åˆ›å»º GitHub Release ==========
  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist
          
      - name: æ•´ç†æ„å»ºäº§ç‰©
        run: |
          mkdir -p release
          find dist -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.yml" \) -exec cp {} release/ \;
          ls -la release/
          
      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
          
      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          echo "## ğŸ‰ åœ°å›¾ç›¸å†Œ v${{ steps.get_version.outputs.version }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ“¦ ä¸‹è½½" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "| å¹³å° | ä¸‹è½½é“¾æ¥ |" >> CHANGELOG.md
          echo "|------|----------|" >> CHANGELOG.md
          echo "| Windows | [å®‰è£…åŒ… (.exe)](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/åœ°å›¾ç›¸å†Œ-${{ steps.get_version.outputs.version }}-win-x64.exe) |" >> CHANGELOG.md
          echo "| macOS | [å®‰è£…åŒ… (.dmg)](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/åœ°å›¾ç›¸å†Œ-${{ steps.get_version.outputs.version }}-mac-x64.dmg) |" >> CHANGELOG.md
          echo "| Linux | [AppImage](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/åœ°å›¾ç›¸å†Œ-${{ steps.get_version.outputs.version }}-x64.AppImage) |" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### âœ¨ æ›´æ–°å†…å®¹" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "- è¯·æŸ¥çœ‹ [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ“‹ ç³»ç»Ÿè¦æ±‚" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "- **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬" >> CHANGELOG.md
          echo "- **macOS**: macOS 10.15 æˆ–æ›´é«˜ç‰ˆæœ¬" >> CHANGELOG.md
          echo "- **Linux**: Ubuntu 18.04+ æˆ–åŒç­‰ç‰ˆæœ¬" >> CHANGELOG.md
          
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: åœ°å›¾ç›¸å†Œ v${{ steps.get_version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'alpha') }}
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========== æ„å»º Web ç‰ˆæœ¬å¹¶éƒ¨ç½² ==========
  build-web:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: å®‰è£…ä¾èµ–
        run: npm ci
        
      - name: æ„å»º Web ç‰ˆæœ¬
        run: npm run web:build
        env:
          VITE_MAPBOX_TOKEN: ${{ secrets.MAPBOX_TOKEN }}
          
      - name: ä¸Šä¼  Web æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist-web
          retention-days: 5
          
      # éƒ¨ç½²åˆ° GitHub Pagesï¼ˆå¯é€‰ï¼‰
      - name: éƒ¨ç½²åˆ° GitHub Pages
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist-web
          cname: photo-map.example.com  # è‡ªå®šä¹‰åŸŸåï¼ˆå¯é€‰ï¼‰